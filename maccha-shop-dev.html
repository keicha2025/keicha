<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEICHA æŠ¹èŒ¶å•†åº— - ç·šä¸Šä¸‹å–®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brandGreen: '#6ea44c',
                        brandLight: '#e8f5e9',
                    },
                    fontFamily: {
                        sans: ['"Microsoft JhengHei"', '"Heiti TC"', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #f9f9f7; overflow-x: hidden; }
        
        .brand-green { color: #6ea44c; }
        .bg-brand-green { background-color: #6ea44c; }
        
        /* Loading */
        .loader { border-top-color: #6ea44c; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* å´é‚Šé¢æ¿èˆ‡é®ç½© */
        .side-panel {
            position: fixed; top: 0; right: 0; height: 100%; width: 100%; max-width: 420px;
            background-color: white; z-index: 200; transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column;
            box-shadow: -4px 0 15px rgba(0,0,0,0.1);
        }
        .side-panel.open { transform: translateX(0); }
        
        .overlay {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 190;
            opacity: 0; visibility: hidden; transition: opacity 0.3s; backdrop-filter: blur(4px);
        }
        .overlay.open { opacity: 1; visibility: visible; }

        /* è³¼ç‰©è»Šèˆ‡å•†å“åˆ—è¡¨æ¨£å¼ */
        .cart-item-row { display: flex; align-items: center; gap: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #f3f4f6; }
        .cart-item-img { width: 64px; height: 64px; object-fit: cover; border-radius: 8px; background-color: #f9fafb; }
        
        .btn-outline-brand { background-color: white; color: #6ea44c; border: 2px solid #6ea44c; width: 100%; padding: 0.8rem; border-radius: 0.75rem; font-weight: bold; transition: all 0.2s; font-size: 0.875rem; }
        .btn-outline-brand:hover { background-color: rgba(110, 164, 76, 0.05); }

        /* è¼¸å…¥æ¡†æ¨£å¼ */
        .user-edit-input { width: 100%; padding: 0.5rem 0; border: none; border-bottom: 2px solid #6ea44c; outline: none; background-color: transparent; transition: all 0.3s; }
        .checkout-inline-input { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; outline: none; transition: border-color 0.2s; }
        .checkout-inline-input:focus { border-color: #6ea44c; ring: 1px solid #6ea44c; }
        
        /* æ‡¸æµ®è³¼ç‰©è»ŠæŒ‰éˆ• */
        .cart-floating-btn {
            position: fixed; bottom: 2rem; right: 2rem; width: 4rem; height: 4rem;
            background-color: #6ea44c; color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: transform 0.2s;
        }
        .cart-floating-btn:active { transform: scale(0.95); }

        /* =========================================
           ğŸ“¦ å•†å“å¡ç‰‡æ¨£å¼å„ªåŒ–
           ========================================= */
        .qty-control { 
            display: flex; align-items: center; justify-content: space-between; 
            background: #ffffff; border: 1px solid #e5e7eb; border-radius: 0.75rem; 
            padding: 0 8px; height: 48px; box-sizing: border-box;
        }
        
        .add-btn {
            height: 48px !important; display: flex; align-items: center; justify-content: center;
            padding: 0 16px; border-radius: 0.75rem; font-weight: bold; cursor: pointer; transition: all 0.2s;
        }

        /* æ‰‹æ©Ÿç‰ˆé©é… */
        @media (max-width: 767px) {
            .mobile-product-card { 
                display: flex !important; flex-direction: column !important; 
                padding: 16px !important; gap: 12px !important;
            }
            .card-top-row { 
                display: flex !important; flex-direction: row !important; 
                align-items: flex-start !important; gap: 16px !important; width: 100%;
            }
            .card-img-group { 
                width: 100px !important; height: 100px !important; flex-shrink: 0 !important;
                border-radius: 12px !important; overflow: hidden; background-color: #f9fafb;
            }
            .card-info-group {
                flex: 1 !important; display: flex !important; flex-direction: column !important;
                justify-content: space-between; min-height: 100px;
            }
            .card-bottom-row {
                display: flex !important; flex-direction: row !important; gap: 12px !important;
                width: 100%; padding: 0 !important; border-top: none !important;
            }
        }
        
        /* ç‰©æµé¸é …é¸ä¸­æ¨£å¼ */
        .ship-opt-card.selected { border-color: #6ea44c; background-color: #f0fdf4; }
    </style>
</head>
<body>

    <div id="overlay" class="overlay" onclick="closeAllPanels()"></div>

    <div class="bg-white border-b border-gray-100 sticky top-0 z-30 shadow-sm">
        <div class="container mx-auto px-4 max-w-6xl py-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl md:text-2xl font-bold tracking-tight text-gray-800">KEICHA æŠ¹èŒ¶å•†åº—</h1>
                <p class="text-xs text-gray-400 mt-0.5">æ—¥æœ¬ç›´é€ â€¢ æ–°é®®ä»£è³¼</p>
            </div>
            <div id="top-auth-zone">
                <button onclick="openPanel('login-panel')" class="flex items-center gap-1 brand-green font-bold text-sm bg-green-50 px-3 py-1.5 rounded-full hover:bg-green-100 transition">
                    <span class="material-symbols-rounded text-lg">account_circle</span> 
                    <span id="header-user-name">æœƒå“¡ç™»å…¥</span>
                </button>
            </div>
        </div>
    </div>

    <section class="py-8 bg-gray-50 border-b border-gray-200">
        <div class="container mx-auto px-4 max-w-5xl">
            <h2 class="text-xl font-bold text-center mb-6 text-gray-800 flex items-center justify-center gap-2">
                <span class="material-symbols-rounded text-brandGreen">storefront</span> å“ç‰Œç¸½è¦½
            </h2>
            
            <div id="status-loader" class="flex justify-center h-20">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div>
            </div>
            
            <div id="status-grid-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                </div>
            <div id="status-error" class="hidden text-center text-red-500 text-sm mt-4"></div>
        </div>
    </section>

    <main class="max-w-5xl mx-auto px-4 py-8 pb-32">
        <div id="product-list-container" class="space-y-12"></div>
    </main>

    <div class="cart-floating-btn" onclick="openCart()">
        <span class="material-symbols-rounded text-3xl">shopping_bag</span>
        <span id="cart-badge" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full border-2 border-white hidden">0</span>
    </div>

    <div id="login-panel" class="side-panel">
        <div class="p-6 bg-[#6ea44c] text-white flex justify-between items-center">
            <h3 class="font-bold flex items-center gap-2 text-white"><span class="material-symbols-rounded">login</span> æœƒå“¡ç™»å…¥</h3>
            <button onclick="closeAllPanels()" class="material-symbols-rounded text-white">close</button>
        </div>
        <div class="p-8 space-y-6">
            <div class="text-center space-y-2">
                <p class="text-gray-600 font-bold text-xl">æ­¡è¿ä¾†åˆ° KEICHA</p>
                <p class="text-sm text-gray-400">è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼å¿«é€Ÿç™»å…¥/è¨»å†Š</p>
            </div>
            <input type="tel" id="member-phone-search" placeholder="ä¾‹å¦‚ï¼š0912345678" class="w-full p-4 bg-gray-50 border rounded-2xl text-lg font-bold outline-none focus:ring-1 ring-[#6ea44c]">
            <p id="member-msg" class="text-xs text-center min-h-[1.5em]"></p>
            
            <button onclick="checkMember()" id="login-submit-btn" class="w-full bg-[#6ea44c] text-white py-4 rounded-2xl font-bold shadow-lg flex justify-center items-center gap-2 hover:bg-green-700 transition">
                <span id="login-text">ä¸‹ä¸€æ­¥</span><span id="login-icon" class="material-symbols-rounded">arrow_forward</span>
            </button>
        </div>
    </div>

    <div id="cart-sidebar" class="side-panel">
        <div class="p-6 border-b flex justify-between items-center bg-white sticky top-0 z-10">
            <h3 class="font-bold flex items-center gap-2 text-gray-800">
                <span class="material-symbols-rounded">shopping_cart</span> è³¼ç‰©è»Š
            </h3>
            <button onclick="closeAllPanels()" class="material-symbols-rounded text-gray-400 hover:text-gray-600">close</button>
        </div>
        
        <div id="cart-items-container" class="flex-grow overflow-y-auto p-6 space-y-4">
            <div class="text-center text-gray-400 mt-10">è³¼ç‰©è»Šæ˜¯ç©ºçš„</div>
        </div>

        <div class="p-6 border-t bg-gray-50 space-y-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <div class="flex justify-between items-center font-bold mb-2">
                <span class="text-gray-600">é ä¼°å°è¨ˆ</span>
                <span id="bar-total" class="text-xl brand-green">0</span>
                </div>
            <button onclick="openCheckout()" class="w-full bg-[#6ea44c] text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                å‰å¾€çµå¸³ <span class="material-symbols-rounded text-sm">arrow_forward</span>
            </button>
            <button onclick="closeAllPanels()" class="btn-outline-brand flex items-center justify-center gap-2">
                <span class="material-symbols-rounded text-sm">arrow_back</span> è¿”å›å•†åº—ç¹¼çºŒé¸è³¼
            </button>
        </div>
    </div>

    <div id="checkout-panel" class="side-panel">
        <div class="p-6 bg-[#6ea44c] text-white flex justify-between items-center sticky top-0 z-20 shadow-md">
            <h3 class="font-bold flex items-center gap-2">
                <span class="material-symbols-rounded">shopping_cart_checkout</span> çµå¸³ç¢ºèª
            </h3>
            <button onclick="closeAllPanels()" class="material-symbols-rounded text-white hover:opacity-70 transition">close</button>
        </div>

        <form id="order-form" onsubmit="submitOrder(event)" class="contents">
            <div class="p-8 flex-1 overflow-y-auto space-y-10 pb-24">
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="text-xs font-bold brand-green uppercase tracking-widest mb-2">è³¼è²·æ¸…å–®</h4>
                    <ul id="checkout-cart-list" class="text-sm space-y-2 text-gray-700"></ul>
                </div>

                <div class="hidden">
                    <select id="input-logistics" onchange="updateShippingFee()">
                        <option value="7-11">7-11</option>
                        <option value="å…¨å®¶">å…¨å®¶</option>
                        <option value="éƒµå¯„/å®…é…">å®…é…</option>
                    </select>
                    <input type="checkbox" id="join-member" checked> </div>

                <section class="space-y-4">
                    <h4 class="text-xs font-bold brand-green uppercase tracking-widest border-b border-gray-100 pb-2">è¯çµ¡è³‡è¨Š</h4>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="text-[10px] text-gray-400 font-bold mb-1 block">æ”¶ä»¶äººå…¨å <span class="text-red-500">*</span></label>
                            <input type="text" id="input-name" required class="checkout-inline-input w-full bg-gray-50" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 font-bold mb-1 block">æ‰‹æ©Ÿè™Ÿç¢¼ <span class="text-red-500">*</span></label>
                            <input type="tel" id="input-phone" required class="checkout-inline-input w-full bg-gray-50" placeholder="09xxxxxxxx">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 font-bold mb-1 block">é›»å­ä¿¡ç®± <span class="text-red-500">*</span></label>
                            <input type="email" id="input-email" required class="checkout-inline-input w-full bg-gray-50" placeholder="è¨‚å–®é€šçŸ¥ç”¨">
                        </div>
                         <div>
                            <label class="text-[10px] text-gray-400 font-bold mb-1 block">LINE ID / æš±ç¨±</label>
                            <input type="text" id="input-line" class="checkout-inline-input w-full bg-gray-50">
                        </div>
                    </div>
                </section>

                <section class="space-y-4">
                    <h4 class="text-xs font-bold brand-green uppercase tracking-widest border-b border-gray-100 pb-2">é¸æ“‡å–è²¨æ–¹å¼</h4>
                    
                    <div onclick="uiSelectLogistics('7-11')" id="card-7-11" class="ship-opt-card p-4 rounded-2xl border border-gray-200 cursor-pointer hover:border-brandGreen transition-all bg-white">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="material-symbols-rounded text-orange-500 text-2xl">local_shipping</span>
                            <div class="font-bold text-sm text-gray-800">7-11 åº—åˆ°åº—</div>
                        </div>
                        <div id="area-7-11" class="hidden space-y-2 mt-2 pt-2 border-t border-dashed">
                             <div class="flex gap-2">
                                <input type="text" class="checkout-inline-input flex-1 text-xs" placeholder="è¼¸å…¥6ç¢¼åº—è™Ÿ" onchange="syncStoreValue(this)">
                                <a href="https://www.ibon.com.tw/mobile/retail_inquiry.aspx" target="_blank" class="bg-gray-100 text-gray-600 px-3 py-1 rounded text-xs flex items-center" onclick="event.stopPropagation()">æŸ¥è©¢</a>
                             </div>
                             <input type="text" class="checkout-inline-input w-full text-xs" placeholder="é–€å¸‚åç¨± (é¸å¡«)" onchange="syncStoreValue(this)">
                        </div>
                    </div>

                    <div onclick="uiSelectLogistics('å…¨å®¶')" id="card-fami" class="ship-opt-card p-4 rounded-2xl border border-gray-200 cursor-pointer hover:border-brandGreen transition-all bg-white">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="material-symbols-rounded text-blue-500 text-2xl">store</span>
                            <div class="font-bold text-sm text-gray-800">å…¨å®¶ åº—åˆ°åº—</div>
                        </div>
                        <div id="area-fami" class="hidden space-y-2 mt-2 pt-2 border-t border-dashed">
                             <div class="flex gap-2">
                                <input type="text" class="checkout-inline-input flex-1 text-xs" placeholder="è¼¸å…¥6ç¢¼åº—è™Ÿ" onchange="syncStoreValue(this)">
                                <a href="https://www.family.com.tw/marketing/inquiry.aspx" target="_blank" class="bg-gray-100 text-gray-600 px-3 py-1 rounded text-xs flex items-center" onclick="event.stopPropagation()">æŸ¥è©¢</a>
                             </div>
                             <input type="text" class="checkout-inline-input w-full text-xs" placeholder="é–€å¸‚åç¨± (é¸å¡«)" onchange="syncStoreValue(this)">
                        </div>
                    </div>

                    <div onclick="uiSelectLogistics('éƒµå¯„/å®…é…')" id="card-addr" class="ship-opt-card p-4 rounded-2xl border border-gray-200 cursor-pointer hover:border-brandGreen transition-all bg-white">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="material-symbols-rounded text-gray-500 text-2xl">home</span>
                            <div class="font-bold text-sm text-gray-800">éƒµå¯„ / å®…é…</div>
                        </div>
                        <div id="area-addr" class="hidden mt-2 pt-2 border-t border-dashed">
                            <textarea class="checkout-inline-input w-full text-xs" rows="2" placeholder="è«‹è¼¸å…¥å®Œæ•´æ”¶ä»¶åœ°å€" onchange="syncStoreValue(this)"></textarea>
                        </div>
                    </div>

                    <input type="hidden" name="store" id="input-store" required>
                </section>

                <section class="space-y-4">
                    <h4 class="text-xs font-bold brand-green uppercase tracking-widest border-b border-gray-100 pb-2">è¨‚å–®å‚™è¨»</h4>
                    <textarea name="note" id="input-note" class="w-full p-4 rounded-2xl border border-gray-200 bg-gray-50 text-sm focus:ring-1 ring-[#6ea44c] outline-none resize-none" rows="2" placeholder="å¦‚æœ‰å…¶ä»–éœ€æ±‚è«‹å¡«å¯«..."></textarea>
                </section>

                <section class="bg-gray-50 p-6 rounded-3xl space-y-4">
                    <div class="flex justify-between text-sm text-gray-500">
                        <span>å•†å“å°è¨ˆ</span>
                        <span>NT$ <span id="modal-subtotal">0</span></span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-500">
                        <span>é‹è²»</span>
                        <span>NT$ <span id="modal-shipping">è¨ˆç®—ä¸­...</span></span>
                    </div>
                    <div class="flex justify-between text-xl font-bold text-gray-800 pt-4 border-t border-gray-200">
                        <span>ç¸½è¨ˆé‡‘é¡</span>
                        <span class="brand-green font-mono">NT$ <span id="modal-total">0</span></span>
                    </div>
                </section>

                <div class="space-y-4 pt-4">
                    <button type="submit" id="btn-submit" class="w-full bg-[#6ea44c] text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-all flex justify-center items-center gap-2 text-lg">
                        <span class="material-symbols-rounded">verified</span> ç¢ºèªé€å‡ºè¨‚å–®
                    </button>
                </div>
            </div>
        </form>
    </div>

    <script>
        // ========================================================
        // 1. UI äº’å‹•é‚è¼¯ (æ–°å¢éƒ¨åˆ† - ç”¨ä¾†é©…å‹•è¦–è¦ºæ•ˆæœèˆ‡èˆŠé‚è¼¯)
        // ========================================================
        
        function openPanel(panelId) {
            document.getElementById('overlay').classList.add('open');
            document.getElementById(panelId).classList.add('open');
        }

        function closeAllPanels() {
            document.getElementById('overlay').classList.remove('open');
            document.querySelectorAll('.side-panel').forEach(p => p.classList.remove('open'));
        }

        function openCart() {
            // é›–ç„¶æ˜¯æ–° UIï¼Œä½†åº•å±¤è³‡æ–™éœ€è¦åŒæ­¥
            openPanel('cart-sidebar');
            updateCartSidebarRender(); // é‡æ–°æ¸²æŸ“å´é‚Šæ¬„æ¸…å–®
        }

        // ç•¶ä½¿ç”¨è€…é»æ“Šç‰©æµå¡ç‰‡æ™‚
        function uiSelectLogistics(value) {
            // 1. æ›´æ–°éš±è—çš„åŸå§‹ Select
            const select = document.getElementById('input-logistics');
            select.value = value;
            
            // 2. è§¸ç™¼åŸå§‹é‚è¼¯ (è¨ˆç®—é‹è²»)
            updateShippingFee();

            // 3. UI è¦–è¦ºåˆ‡æ›
            document.querySelectorAll('.ship-opt-card').forEach(el => el.classList.remove('selected', 'ring-2', 'ring-brandGreen'));
            document.querySelectorAll('[id^="area-"]').forEach(el => el.classList.add('hidden'));

            let cardId = '', areaId = '';
            if(value.includes('7-11')) { cardId = 'card-7-11'; areaId = 'area-7-11'; }
            else if(value.includes('å…¨å®¶')) { cardId = 'card-fami'; areaId = 'area-fami'; }
            else { cardId = 'card-addr'; areaId = 'area-addr'; }

            if(document.getElementById(cardId)) {
                document.getElementById(cardId).classList.add('selected', 'ring-2', 'ring-brandGreen');
                document.getElementById(areaId).classList.remove('hidden');
            }
        }

        // åŒæ­¥è¼¸å…¥æ¡†å…§å®¹åˆ°éš±è—çš„ input-store (å› ç‚ºèˆŠé‚è¼¯åªè®€å– input-store)
        function syncStoreValue(el) {
            // ç°¡å–®è™•ç†ï¼šå°‡è©²å€åŸŸæ‰€æœ‰è¼¸å…¥æ¡†ä¸²æ¥èµ·ä¾†
            const parent = el.closest('[id^="area-"]');
            const inputs = parent.querySelectorAll('input, textarea');
            const vals = Array.from(inputs).map(i => i.value).filter(v => v).join(' / ');
            document.getElementById('input-store').value = vals;
        }
        
        // æ¸²æŸ“è³¼ç‰©è»Šå´é‚Šæ¬„ (å–ä»£èˆŠçš„ openCheckout åˆ—è¡¨æ¸²æŸ“)
        function updateCartSidebarRender() {
            const container = document.getElementById('cart-items-container');
            container.innerHTML = '';
            
            if (cart.length === 0) {
                container.innerHTML = '<div class="flex flex-col items-center justify-center h-64 text-gray-400 space-y-4"><span class="material-symbols-rounded text-4xl">remove_shopping_cart</span><p>è³¼ç‰©è»Šæ˜¯ç©ºçš„</p></div>';
                return;
            }

            cart.forEach(item => {
                const itemTotal = (item.qty * (item.qty >= 2 ? item.price_multi : item.price));
                container.innerHTML += `
                    <div class="flex gap-4 items-start pb-4 border-b border-gray-100 last:border-0">
                        <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center text-gray-300">
                           <span class="material-symbols-rounded">image</span>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800 text-sm line-clamp-2">${item.name}</h4>
                            <div class="text-xs text-gray-500 mt-1">å–®åƒ¹ $${item.price}</div>
                            <div class="flex justify-between items-end mt-2">
                                <div class="font-bold text-brandGreen">$${itemTotal}</div>
                                <div class="text-xs font-bold bg-gray-100 px-2 py-1 rounded">x ${item.qty}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            // åŒæ­¥åº•éƒ¨é‡‘é¡é¡¯ç¤º (ä½¿ç”¨èˆŠé‚è¼¯å‡½å¼è¨ˆç®—)
            const sub = calculateSubtotal();
            // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨ querySelector æ›´æ–°æ‰€æœ‰é¡¯ç¤º bar-total çš„åœ°æ–¹
            document.querySelectorAll('#bar-total').forEach(el => el.innerText = "NT$ " + sub.toLocaleString());
        }

        // ========================================================
        // 2. åŸå§‹é‚è¼¯å€ (ä¿ç•™ä¸è®Šï¼Œåƒ…å¾®èª¿æ¸²æŸ“è¼¸å‡º HTML)
        // ========================================================
        const DISPLAY_API_URL = "https://script.google.com/macros/s/AKfycbxnxbcdCdxH2Qmuek5Up8BqTWeOLUcLR30jfUi0lMbMn5ocn9tY1f_c7yEyd9KSZ4Um/exec"; 
        const ORDER_API_URL = "https://script.google.com/macros/s/AKfycbyUq36i64Z-JGcERE_rZOdphVtVDX8L-lguc7eiUIdoAERqI1ZK8GWAL-HgbC75cuMHFg/exec"; 
        const BASE_REPO_URL = "assets/images/"; 

        let cart = []; 
        let shippingFee = 0; 
        let shippingRules = []; 

        function addToCart(brandKey, name, price, priceMulti, stock, maxLimit) {
            const existingItem = cart.find(item => item.name === name && item.brand_key === brandKey);
            let currentQty = existingItem ? existingItem.qty : 0;

            if (currentQty >= stock) { alert("æŠ±æ­‰ï¼Œåº«å­˜ä¸è¶³ï¼"); return; }
            if (currentQty >= maxLimit) { alert(`æ­¤å•†å“æ¯äººé™è³¼ ${maxLimit} ä»¶`); return; }

            if (existingItem) { existingItem.qty++; } 
            else { cart.push({ brand_key: brandKey, name: name, price: price, price_multi: priceMulti, qty: 1 }); }
            
            updateCartUI();
            
            // UX: è‡ªå‹•æ‰“é–‹è³¼ç‰©è»Š
            openCart();
            if (navigator.vibrate) navigator.vibrate(50);
        }

        function calculateSubtotal() {
            const brandCounts = {};
            cart.forEach(item => { brandCounts[item.brand_key] = (brandCounts[item.brand_key] || 0) + item.qty; });
            let subtotal = 0;
            cart.forEach(item => {
                const brandTotalQty = brandCounts[item.brand_key] || 0;
                const unitPrice = brandTotalQty >= 2 ? item.price_multi : item.price;
                subtotal += unitPrice * item.qty;
            });
            return subtotal;
        }

        function updateCartUI() {
            const subtotal = calculateSubtotal();
            const badge = document.getElementById('cart-badge');
            
            document.querySelectorAll('#bar-total').forEach(el => el.innerText = subtotal.toLocaleString());
            
            const totalQty = cart.reduce((acc, item) => acc + item.qty, 0);
            if(badge) {
                badge.innerText = totalQty;
                badge.classList.toggle('hidden', totalQty === 0);
            }
            updateCartSidebarRender(); // åŒæ­¥æ›´æ–°å´é‚Šæ¬„
        }

        // ä¿®æ”¹ï¼šopenCheckout ä¸å†æ‰“é–‹ Modalï¼Œè€Œæ˜¯æ‰“é–‹ Side Panel
        function openCheckout() {
            if (cart.length === 0) { alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„å–”ï¼"); return; }
            
            // æ¸²æŸ“è³¼ç‰©è»Šæ˜ç´° (ä¿ç•™ ID è®“èˆŠé‚è¼¯æ­£å¸¸é‹ä½œï¼Œä½†æ¸²æŸ“åˆ°æ–°ä½ç½®)
            const listEl = document.getElementById('checkout-cart-list');
            listEl.innerHTML = '';
            
            const brandCounts = {};
            cart.forEach(item => brandCounts[item.brand_key] = (brandCounts[item.brand_key] || 0) + item.qty);

            cart.forEach(item => {
                const brandTotalQty = brandCounts[item.brand_key] || 0;
                const unitPrice = brandTotalQty >= 2 ? item.price_multi : item.price;
                const sub = unitPrice * item.qty;
                
                const li = document.createElement('li');
                li.className = "flex justify-between border-b border-gray-100 pb-2 last:border-0";
                li.innerHTML = `
                    <span class="text-gray-600">${item.name} <span class="text-xs bg-gray-200 px-1 rounded">x${item.qty}</span></span>
                    <span class="font-bold text-brandGreen">$${sub}</span>
                `;
                listEl.appendChild(li);
            });

            updateShippingFee();
            // åˆ‡æ›é¢æ¿
            closeAllPanels();
            openPanel('checkout-panel');
        }

        function updateShippingFee() {
            const subtotal = calculateSubtotal();
            const selectedLogistics = document.getElementById('input-logistics').value; 
            
            const rule = shippingRules.find(r => r.category === 'æŠ¹èŒ¶' && selectedLogistics.includes(r.method));

            let finalFee = 60; 
            if (selectedLogistics.includes("å®…é…")) finalFee = 100;

            if (rule) {
                finalFee = Number(rule.base); 
                if (rule.t3 && subtotal >= rule.t3) { finalFee = Number(rule.f3); } 
                else if (rule.t2 && subtotal >= rule.t2) { finalFee = Number(rule.f2); } 
                else if (rule.t1 && subtotal >= rule.t1) { finalFee = Number(rule.f1); }
            }

            shippingFee = finalFee;
            updateModalTotals();
        }

        function updateModalTotals() {
            const subtotal = calculateSubtotal();
            document.getElementById('modal-subtotal').innerText = subtotal.toLocaleString();
            document.getElementById('modal-shipping').innerText = shippingFee;
            document.getElementById('modal-total').innerText = (subtotal + shippingFee).toLocaleString();
        }

        function checkMember() {
            const phone = document.getElementById('member-phone-search').value.trim();
            const msgEl = document.getElementById('member-msg');
            
            if (!phone) { alert("è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼"); return; }

            msgEl.innerText = "æŸ¥è©¢ä¸­...";
            msgEl.className = "text-xs mt-1 text-blue-500";

            fetch(ORDER_API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "login", phone: phone })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const info = data.data;
                    document.getElementById('input-phone').value = info.phone; 
                    // è¦–è¦ºæ›´æ–°ï¼šå°‡ç™»å…¥é¢æ¿é—œé–‰ï¼Œç›´æ¥å°å‘çµå¸³æˆ–é¡¯ç¤ºæˆåŠŸ
                    closeAllPanels();
                    document.getElementById('header-user-name').innerText = info.name || "æœƒå“¡";
                    alert(`æ­¡è¿å›ä¾†ï¼Œ${info.name}ï¼\nè³‡æ–™å·²è‡ªå‹•å¸¶å…¥çµå¸³é é¢ã€‚`);
                    
                    if (info.name) {
                        document.getElementById('input-name').value = info.name;
                        document.getElementById('input-email').value = info.email;
                        
                        // å˜—è©¦è‡ªå‹•é¸æ“‡ç‰©æµ (æ›´æ–° UI + æ›´æ–°å€¼)
                        if (info.store_711) {
                            uiSelectLogistics('7-11');
                            // é€™è£¡è¼ƒé›£è‡ªå‹•é‚„åŸ store input çš„æ‹†åˆ†å€¼ï¼Œç›´æ¥å¡«å…¥
                            document.querySelector('#area-7-11 input:last-child').value = info.store_711;
                            document.getElementById('input-store').value = info.store_711;
                        } 
                        // ... å…¶ä»–ç‰©æµé‚è¼¯ç•¥ ...
                        updateShippingFee(); 
                    }
                } else {
                    msgEl.innerText = "æ˜¯æ–°æœ‹å‹å‘¢ï¼è«‹å¡«å¯«è³‡æ–™ï¼Œä¸‹å–®å¾Œè‡ªå‹•æˆç‚ºæœƒå“¡ã€‚";
                    msgEl.className = "text-xs mt-1 text-orange-500 font-bold";
                    // å»¶é²è·³è½‰
                    setTimeout(() => {
                        closeAllPanels();
                        openCheckout();
                        document.getElementById('input-phone').value = phone;
                    }, 1000);
                }
            })
            .catch(err => {
                console.error(err);
                msgEl.innerText = "ç³»çµ±é€£ç·šéŒ¯èª¤";
            });
        }

        function submitOrder(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            btn.innerHTML = '<span class="loader h-5 w-5 border-2 border-white rounded-full"></span> è™•ç†ä¸­...';

            const subtotal = calculateSubtotal();
            const brandCounts = {};
            cart.forEach(item => brandCounts[item.brand_key] = (brandCounts[item.brand_key] || 0) + item.qty);
            
            const itemsStr = cart.map(item => {
                const brandTotalQty = brandCounts[item.brand_key] || 0;
                const finalPrice = brandTotalQty >= 2 ? item.price_multi : item.price;
                return `${item.name} x${item.qty} ($${finalPrice})`;
            }).join('\n');

            const payload = {
                action: "checkout",
                name: document.getElementById('input-name').value,
                phone: document.getElementById('input-phone').value,
                email: document.getElementById('input-email').value,
                line_name: document.getElementById('input-line').value,
                logistics: document.getElementById('input-logistics').value,
                store: document.getElementById('input-store').value,
                product_note: document.getElementById('input-note').value,
                join_member: document.getElementById('join-member').checked,
                items: itemsStr,
                subtotal: subtotal,
                shipping: shippingFee,
                temp: "å¸¸æº«", 
                date: new Date().toISOString()
            };

            fetch(ORDER_API_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert(`è¨‚å–®å»ºç«‹æˆåŠŸï¼\nè¨‚å–®ç·¨è™Ÿ: ${data.orderId}\nè«‹è‡³ Email æ”¶ä¿¡ç¢ºèªã€‚`);
                    cart = []; 
                    updateCartUI();
                    closeAllPanels();
                    document.getElementById('order-form').reset();
                } else {
                    alert("è¨‚å–®å»ºç«‹å¤±æ•—: " + data.msg);
                }
            })
            .catch(err => {
                console.error(err);
                alert("ç¶²è·¯éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€£ç·š");
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerText = "ç¢ºèªé€å‡ºè¨‚å–®";
            });
        }

        window.addEventListener('load', () => {
            const statusLoader = document.getElementById('status-loader');

            fetch(ORDER_API_URL) 
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.shipping_rules) {
                        shippingRules = data.shipping_rules;
                    }
                })
                .catch(err => console.error("ç„¡æ³•è®€å–é‹è²»è¦å‰‡:", err));

            // ä¿®æ”¹ï¼šä½¿ç”¨æ–°çš„ UI çµæ§‹æ¸²æŸ“å“ç‰Œåˆ—è¡¨
            function renderStatusOverview(brands) {
                const container = document.getElementById('status-grid-container');
                if (statusLoader) statusLoader.style.display = 'none';
                if (!container) return;
                container.innerHTML = '';
                brands.forEach(brand => {
                    const rawStatus = (brand.status || '').toLowerCase().trim();
                    let statusText = brand.status || 'æœªå®š';
                    let statusColorClass = 'bg-gray-200 text-gray-600';
                    
                    if (['available', 'open', 'å¼€å›¢', 'é–‹åœ˜', 'æ¥æ”¶è¨‚å–®ä¸­', 'æ”¶å–®ä¸­'].includes(rawStatus)) {
                        statusText = 'å¯è¨‚è³¼';
                        statusColorClass = 'bg-brandGreen text-white';
                    } else if (['out-of-stock', 'sold out', 'close', 'é—œé–‰', 'ç¼ºè²¨', 'å·²çµå–®'].includes(rawStatus)) {
                        statusText = 'ç¼ºè²¨ä¸­';
                        statusColorClass = 'bg-gray-200 text-gray-600';
                    }
                    
                    // ä½¿ç”¨æ–°çš„å¡ç‰‡æ¨£å¼
                    container.innerHTML += `
                        <a href="#brand-${brand.key}" class="block bg-white p-4 rounded-lg shadow hover:shadow-md transition border border-gray-100 flex justify-between items-center group">
                            <span class="font-bold text-gray-700 group-hover:text-brandGreen transition">${brand.name}</span>
                            <span class="text-xs px-3 py-1 rounded-full ${statusColorClass}">
                                ${statusText}
                            </span>
                        </a>`;
                });
            }

            function renderProductSections(brands) {
                const container = document.getElementById('product-list-container');
                if (!container) return;
                container.innerHTML = '';
                brands.forEach(brand => {
                    container.innerHTML += `
                        <section id="brand-${brand.key}" class="scroll-mt-24">
                            <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-gray-800 border-b pb-4">
                                <span class="w-2 h-6 bg-brandGreen rounded-full"></span>
                                ${brand.name}
                            </h2>
                            <div id="${brand.key}-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                        </section>`;
                });
            }

            // ä¿®æ”¹ï¼šä½¿ç”¨æ–°çš„ Mobile Row / Desktop Card æ¨£å¼
            function renderProductCards(brandKey, products) {
                const grid = document.getElementById(`${brandKey}-grid`);
                if (!grid) return;
                const visibleProducts = products.filter(p => !p.hidden);
                if (visibleProducts.length === 0) {
                    grid.innerHTML = `<p class="text-gray-400 text-center col-span-full py-8">å°šç„¡å“é …</p>`;
                    return;
                }
                visibleProducts.forEach(product => {
                    const name = product.name || 'æœªå‘½å';
                    const price = Number(product.price) || 0;
                    const priceMulti = Number(product.price_multi) || 0;
                    const status = product.status || '';
                    const note = product.note || '';
                    const imgPath = String(product.img || '');
                    
                    const isSoldOut = product.stock <= 0 || status === 'å®Œå”®';
                    
                    let imgHTML = imgPath ? `<img src="${imgPath.startsWith('http') ? imgPath : BASE_REPO_URL + imgPath}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" loading="lazy">` : `<div class="w-full h-full flex items-center justify-center bg-gray-100 text-gray-400"><span class="material-symbols-rounded">image_not_supported</span></div>`;
                    
                    // Badge æ¨£å¼å„ªåŒ–
                    let badgeHTML = '';
                    if (!isSoldOut && note) {
                        badgeHTML = `<span class="absolute top-2 right-2 bg-brandGreen text-white text-[10px] font-bold px-2 py-1 rounded shadow z-10">${note}</span>`;
                    } else if (isSoldOut) {
                        badgeHTML = `<span class="absolute top-2 right-2 bg-gray-500 text-white text-[10px] font-bold px-2 py-1 rounded z-10">ç¼ºè²¨</span>`;
                    }

                    let priceHTML = (priceMulti > 0 && priceMulti < price) 
                        ? `<div class="flex flex-col items-end md:items-start"><span class="text-xs text-gray-400 line-through">$${price}</span><span class="text-brandGreen font-bold text-lg">$${priceMulti}</span></div>` 
                        : `<div class="text-gray-800 font-bold text-lg">$${price}</div>`;

                    const btnClass = isSoldOut ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-brandGreen hover:bg-green-700 text-white shadow-sm active:scale-95';
                    const clickEvent = isSoldOut ? '' : `onclick="addToCart('${product.brand_key}', '${name}', ${price}, ${priceMulti}, ${product.stock}, ${product.max_limit})"`;
                    const btnText = isSoldOut ? 'å®Œå”®' : '<span class="material-symbols-rounded">add_shopping_cart</span>';

                    // é€™è£¡æ‡‰ç”¨äº†æ‚¨æä¾›çš„ Mobile Row (mobile-product-card) èˆ‡é€šç”¨æ¨£å¼
                    grid.innerHTML += `
                        <div class="mobile-product-card bg-white shadow-sm rounded-2xl overflow-hidden border border-gray-100 group flex flex-col relative transition-all hover:shadow-md">
                            ${badgeHTML}
                            
                            <div class="card-top-row w-full relative">
                                <div class="card-img-group w-full aspect-square relative overflow-hidden bg-gray-50">
                                    ${imgHTML}
                                </div>
                                </div>

                            <div class="card-info-group p-4 flex-grow flex flex-col justify-between">
                                <div>
                                    <h3 class="font-bold text-gray-800 leading-tight mb-1 text-base">${name}</h3>
                                    ${product.spec ? `<p class="text-xs text-gray-500 mb-2">${product.spec}</p>` : ''}
                                </div>
                                <div class="card-bottom-row mt-3 flex items-center justify-between gap-2 border-t border-gray-50 pt-3 md:border-none md:pt-0">
                                    ${priceHTML}
                                    <button class="add-btn ${btnClass}" ${clickEvent}>${btnText}</button>
                                </div>
                            </div>
                        </div>`;
                });
            }

            fetch(DISPLAY_API_URL)
                .then(res => res.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    renderStatusOverview(data.brands);
                    renderProductSections(data.brands);
                    data.brands.forEach(brand => {
                        renderProductCards(brand.key, data.products.filter(p => p.brand_key === brand.key));
                    });
                })
                .catch(err => {
                    console.error(err);
                    if(document.getElementById('status-grid-container')) 
                        document.getElementById('status-grid-container').innerHTML = `<p class="text-red-500">è¼‰å…¥å¤±æ•—</p>`;
                });
        });
    </script>
</body>
</html>
