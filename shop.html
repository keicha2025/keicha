---
layout: default
title: KEICHA 網路商店
---

<style>
    /* 品牌色與基礎樣式 */
    .brand-green { color: #6ea44c; }
    .bg-brand-green { background-color: #6ea44c; }
    .bg-brand-green-10 { background-color: rgba(110, 164, 76, 0.1); }
    
    /* 側邊欄控制 */
    .side-panel {
        position: fixed; top: 0; right: 0; height: 100%; width: 100%; max-width: 400px;
        background-color: white; z-index: 200; transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column;
        box-shadow: -4px 0 15px rgba(0,0,0,0.1);
    }
    .side-panel.open { transform: translateX(0); }
    
    /* 覆蓋層 */
    .overlay {
        position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 190;
        opacity: 0; visibility: hidden; transition: opacity 0.3s; backdrop-filter: blur(4px);
    }
    .overlay.open { opacity: 1; visibility: visible; }

    /* 購物車懸浮按鈕 */
    .cart-floating-btn {
        position: fixed; bottom: 2rem; right: 2rem; width: 4rem; height: 4rem;
        background-color: #6ea44c; color: white; border-radius: 50%;
        display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: transform 0.2s;
    }
    .cart-floating-btn:active { transform: scale(0.9); }

    /* 登入彈窗 */
    .login-modal {
        position: fixed; inset: 0; z-index: 300; display: none;
        align-items: center; justify-content: center; background: rgba(0,0,0,0.6);
    }
    .login-modal.open { display: flex; }
</style>

<div class="bg-white border-b sticky top-0 z-50">
    <div class="container mx-auto px-4 max-w-6xl py-4 flex justify-between items-center">
        <h1 class="text-xl font-bold brand-green">KEICHA 網路商店</h1>
        <div id="top-auth-zone"></div>
    </div>
</div>

<section id="announcement-section" class="hidden py-3 bg-yellow-50 border-b">
    <div class="container mx-auto px-4 text-center text-xs font-medium text-yellow-800" id="announcement-content"></div>
</section>

<main class="max-w-6xl mx-auto p-4 md:p-10 space-y-12 min-h-screen">
    <div id="products-loader" class="flex justify-center items-center h-48">
        <div class="w-10 h-10 border-4 border-gray-200 border-t-[#6ea44c] rounded-full animate-spin"></div>
    </div>
    <div id="category-container" class="space-y-16"></div>
</main>

<div id="user-panel" class="side-panel">
    <div class="p-6 bg-[#6ea44c] text-white flex justify-between items-center">
        <h3 class="font-bold flex items-center gap-2 text-white"><span class="material-symbols-rounded">account_circle</span> 會員資料</h3>
        <button onclick="closeAllPanels()" class="material-symbols-rounded">close</button>
    </div>
    <div id="panel-body" class="p-6 flex-1 overflow-y-auto space-y-10"></div>
</div>

<div id="cart-sidebar" class="side-panel">
    <div class="p-6 border-b flex justify-between items-center">
        <h3 class="font-bold flex items-center gap-2"><span class="material-symbols-rounded">shopping_cart</span> 購物車</h3>
        <button onclick="closeAllPanels()" class="material-symbols-rounded">close</button>
    </div>
    <div id="cart-items-container" class="flex-grow p-6 space-y-6 overflow-y-auto"></div>
    <div class="p-6 border-t bg-gray-50 space-y-4">
        <div class="flex justify-between font-bold"><span>總額</span><span id="cart-total-price" class="brand-green">NT$ 0</span></div>
        <button class="w-full bg-[#6ea44c] text-white py-4 rounded-xl font-bold shadow-lg">介面確認中 (暫不結帳)</button>
    </div>
</div>

<div id="login-modal" class="login-modal" onclick="closeLogin()">
    <div class="bg-white w-full max-w-md h-[80vh] rounded-t-3xl md:rounded-3xl overflow-hidden relative" onclick="event.stopPropagation()">
        <button class="absolute top-4 right-4 p-2 bg-gray-100 rounded-full" onclick="closeLogin()"><span class="material-symbols-rounded text-sm">close</span></button>
        <iframe src="member.html" class="w-full h-full border-none"></iframe>
    </div>
</div>

<div id="cart-float" class="cart-floating-btn" onclick="openCart()">
    <span class="material-symbols-rounded text-3xl">shopping_bag</span>
    <span id="cart-count" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full border-2 border-white hidden">0</span>
</div>

<div id="global-overlay" class="overlay" onclick="closeAllPanels()"></div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyUq36i64Z-JGcERE_rZOdphVtVDX8L-lguc7eiUIdoAERqI1ZK8GWAL-HgbC75cuMHFg/exec";
    const siteBaseUrl = "{{ site.baseurl | default: '' }}";
    let cart = [];
    let globalProducts = [];

    async function initShop() {
        try {
            const res = await fetch(GAS_URL);
            const data = await res.json();
            globalProducts = data.products;
            renderProducts(data.products);
            if(data.settings?.announcement) {
                document.getElementById('announcement-content').innerText = data.settings.announcement;
                document.getElementById('announcement-section').classList.remove('hidden');
            }
            document.getElementById('products-loader').classList.add('hidden');
            renderTopAuth();
        } catch (e) { console.error(e); }
    }

    // 登入處理
    function openLogin() { document.getElementById('login-modal').classList.add('open'); }
    function closeLogin() { document.getElementById('login-modal').classList.remove('open'); renderTopAuth(); }

    function renderTopAuth() {
        const user = JSON.parse(localStorage.getItem('keicha_v2_user'));
        const zone = document.getElementById('top-auth-zone');
        zone.innerHTML = user ? `
            <button onclick="openUserPanel()" class="flex items-center gap-1 brand-green font-bold text-sm">
                <span class="material-symbols-rounded">account_circle</span> ${user.name || user.phone}
            </button>
        ` : `
            <button onclick="openLogin()" class="flex items-center gap-1 text-gray-400 font-bold text-sm">
                <span class="material-symbols-rounded">login</span> 登入/註冊
            </button>
        `;
    }

    // 商品渲染
    function renderProducts(products) {
        const container = document.getElementById('category-container');
        const grouped = products.reduce((acc, p) => {
            const cat = p.category || "精選選物";
            if (!acc[cat]) acc[cat] = [];
            acc[cat].push(p);
            return acc;
        }, {});

        container.innerHTML = Object.keys(grouped).map(cat => `
            <section class="space-y-6">
                <h3 class="text-lg font-bold border-l-4 border-[#6ea44c] pl-3">${cat}</h3>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    ${grouped[cat].map(p => {
                        const stock = parseInt(p.stock) || 999;
                        const isSoldOut = stock <= 0;
                        let img = p.image_url || "";
                        if (img && !img.startsWith('http')) img = siteBaseUrl + (img.startsWith('/') ? img : '/' + img);
                        return `
                        <div class="bg-white rounded-2xl border border-gray-100 flex flex-col overflow-hidden">
                            ${img ? `<img src="${img}" class="aspect-square object-cover ${isSoldOut ? 'grayscale opacity-30' : ''}">` : ''}
                            <div class="p-4 flex-1 flex flex-col gap-2">
                                <h4 class="font-bold text-xs line-clamp-2">${p.product_name}</h4>
                                <p class="brand-green font-bold font-mono">NT$ ${p.price}</p>
                                <div class="flex items-center gap-2 mt-auto">
                                    <input type="number" id="qty-${p.product_id}" value="1" min="1" max="${stock}" class="w-12 text-center bg-gray-50 rounded py-1 text-xs">
                                    <button onclick="addToCart('${p.product_id}')" class="flex-1 bg-[#6ea44c] text-white py-1.5 rounded-lg text-xs font-bold ${isSoldOut?'bg-gray-200 cursor-not-allowed':''}" ${isSoldOut?'disabled':''}>加入</button>
                                </div>
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            </section>
        `).join('');
    }

    function addToCart(pid) {
        const p = globalProducts.find(x => x.product_id === pid);
        const qty = parseInt(document.getElementById(`qty-${pid}`).value);
        const inCart = cart.find(x => x.id === pid);
        if((inCart ? inCart.qty : 0) + qty > (parseInt(p.stock) || 999)) return alert("庫存不足");
        if(inCart) inCart.qty += qty; else cart.push({ id: pid, name: p.product_name, price: p.price, qty: qty });
        updateCartUI();
    }

    function updateCartUI() {
        const count = cart.reduce((s, i) => s + i.qty, 0);
        document.getElementById('cart-count').innerText = count;
        document.getElementById('cart-count').classList.toggle('hidden', count === 0);
        const c = document.getElementById('cart-items-container');
        let total = 0;
        c.innerHTML = cart.map(i => {
            total += i.price * i.qty;
            return `<div class="flex justify-between items-center text-xs"><div><b>${i.name}</b><br>NT$ ${i.price} x ${i.qty}</div></div>`;
        }).join('');
        document.getElementById('cart-total-price').innerText = "NT$ " + total.toLocaleString();
    }

    // 會員分段編輯
    function renderUserFields() {
        const u = JSON.parse(localStorage.getItem('keicha_v2_user'));
        const b = document.getElementById('panel-body');
        b.innerHTML = `
            <div id="section-info" class="space-y-4">
                <div class="flex justify-between items-center"><h4 class="text-xs font-bold brand-green uppercase">個人資訊</h4><button onclick="editSection('info')" class="material-symbols-rounded text-sm">edit_square</button></div>
                <div class="text-sm"><b>姓名：</b>${u.name || '未填'}</div>
                <div class="text-sm"><b>Email：</b>${u.email || '未填'}</div>
            </div>
            <div id="section-ship" class="space-y-4 pt-6 border-t">
                <div class="flex justify-between items-center"><h4 class="text-xs font-bold brand-green uppercase">收件方式</h4><button onclick="editSection('ship')" class="material-symbols-rounded text-sm">edit_square</button></div>
                <div class="text-sm"><b>7-11：</b>${u.store_711 || '未填'}</div>
                <div class="text-sm"><b>全家：</b>${u.store_fami || '未填'}</div>
                <div class="text-sm"><b>宅配：</b>${u.shipping_address || '未填'}</div>
            </div>
        `;
    }

    function editSection(type) {
        const u = JSON.parse(localStorage.getItem('keicha_v2_user'));
        const el = document.getElementById(`section-${type}`);
        if(type === 'info') {
            el.innerHTML = `
                <h4 class="text-xs font-bold brand-green uppercase">編輯個人資訊</h4>
                <input id="ed-name" value="${u.name||''}" class="w-full border p-2 rounded text-sm" placeholder="姓名">
                <input id="ed-email" value="${u.email||''}" class="w-full border p-2 rounded text-sm" placeholder="Email">
                <button onclick="saveSection('info')" id="btn-info" class="w-full bg-[#6ea44c] text-white py-2 rounded text-xs font-bold">儲存變更</button>
            `;
        } else {
            el.innerHTML = `
                <h4 class="text-xs font-bold brand-green uppercase">編輯收件方式</h4>
                <div class="flex justify-between items-center text-[10px]"><span class="brand-green">7-11</span><a href="https://www.ibon.com.tw/mobile/retail_inquiry.aspx" target="_blank" class="underline">查詢店號</a></div>
                <input id="ed-711" value="${u.store_711||''}" class="w-full border p-2 rounded text-sm" placeholder="店號">
                <div class="flex justify-between items-center text-[10px] pt-2"><span class="brand-green">全家</span><a href="https://www.family.com.tw/marketing/inquiry.aspx" target="_blank" class="underline font-bold bg-yellow-50 px-2 rounded">查詢店號 (官方)</a></div>
                <input id="ed-fami" value="${u.store_fami||''}" class="w-full border p-2 rounded text-sm" placeholder="店號">
                <textarea id="ed-addr" class="w-full border p-2 rounded text-sm" placeholder="宅配地址">${u.shipping_address||''}</textarea>
                <button onclick="saveSection('ship')" id="btn-ship" class="w-full bg-[#6ea44c] text-white py-2 rounded text-xs font-bold">儲存變更</button>
            `;
        }
    }

    async function saveSection(type) {
        const btn = document.getElementById(`btn-${type}`);
        const original = btn.innerText;
        btn.innerText = "更新中...";
        btn.disabled = true;
        const u = JSON.parse(localStorage.getItem('keicha_v2_user'));
        if(type === 'info') { u.name = document.getElementById('ed-name').value; u.email = document.getElementById('ed-email').value; }
        else { u.store_711 = document.getElementById('ed-711').value; u.store_fami = document.getElementById('ed-fami').value; u.shipping_address = document.getElementById('ed-addr').value; }
        
        const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'save', ...u }) });
        const result = await res.json();
        if(result.success) { localStorage.setItem('keicha_v2_user', JSON.stringify(u)); renderUserFields(); renderTopAuth(); }
    }

    function openUserPanel() { renderUserFields(); document.getElementById('user-panel').classList.add('open'); document.getElementById('global-overlay').classList.add('open'); }
    function openCart() { document.getElementById('cart-sidebar').classList.add('open'); document.getElementById('global-overlay').classList.add('open'); }
    function closeAllPanels() { document.querySelectorAll('.side-panel, .overlay').forEach(e => e.classList.remove('open')); }
    
    window.onload = initShop;
</script>
