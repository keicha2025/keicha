---
layout: default
title: KEICHA 網路商店
---

<style>
    .brand-title { font-family: 'brand-title-font', sans-serif; }
    .brand-green { color: #6ea44c; }
    
    /* 側邊面板最優先級 */
    .side-panel {
        position: fixed; top: 0; right: 0; height: 100%; width: 100%; max-width: 420px;
        background-color: white; z-index: 999; transform: translateX(100%);
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column;
        box-shadow: -4px 0 15px rgba(0,0,0,0.1);
    }
    .side-panel.open { transform: translateX(0); }
    .overlay {
        position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 998;
        opacity: 0; visibility: hidden; transition: opacity 0.3s; backdrop-filter: blur(4px);
    }
    .overlay.open { opacity: 1; visibility: visible; }

    /* 商品網格佈局 */
    .product-grid { display: grid !important; grid-template-columns: repeat(1, minmax(0, 1fr)) !important; gap: 1.5rem !important; }
    @media (min-width: 768px) { .product-grid { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; } }
    @media (min-width: 1024px) { .product-grid { grid-template-columns: repeat(4, minmax(0, 1fr)) !important; } }

    /* 手機版橫式適配 */
    @media (max-width: 767px) {
        .mobile-product-card { display: flex !important; flex-direction: column !important; padding: 16px !important; }
        .card-top-row { display: flex !important; flex-direction: row !important; gap: 16px !important; width: 100% !important; }
        .card-img-group { width: 100px !important; height: 100px !important; flex-shrink: 0 !important; border-radius: 12px; overflow: hidden; }
        .card-bottom-row { display: flex !important; gap: 10px !important; margin-top: 12px !important; }
    }

    .qty-control { display: flex; align-items: center; background: #f3f4f6; border-radius: 12px; padding: 4px; gap: 8px; }
    .qty-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: white; border-radius: 8px; font-weight: bold; cursor: pointer; border: 1px solid #e5e7eb; }

    .cart-floating-btn {
        position: fixed; bottom: 2rem; right: 2rem; width: 4.5rem; height: 4.5rem;
        background-color: #6ea44c; color: white; border-radius: 50%;
        display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
</style>

<div class="bg-white border-b border-gray-50">
    <div class="container mx-auto px-4 max-w-6xl py-12 flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
        <h1 class="text-4xl md:text-5xl font-bold brand-title text-gray-800 tracking-tight">KEICHA 網路商店</h1>
        <div id="top-auth-zone" class="w-full md:w-auto"></div>
    </div>
</div>

<main class="max-w-6xl mx-auto p-4 md:px-10 pb-32 min-h-screen">
    <div id="products-loader" class="flex flex-col justify-center items-center h-64">
        <div class="w-10 h-10 border-4 border-gray-100 border-t-[#6ea44c] rounded-full animate-spin"></div>
    </div>
    <div id="category-container" class="space-y-20"></div>
</main>

<div id="global-overlay" class="overlay" onclick="window.closeAllPanels()"></div>

{% include panel-login.html %}
{% include panel-user.html %}
{% include panel-cart.html %}
{% include panel-checkout.html %}

<div class="cart-floating-btn" onclick="window.openCart()">
    <span class="material-symbols-rounded text-3xl">shopping_bag</span>
    <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-6 h-6 flex items-center justify-center rounded-full border-2 border-white hidden font-bold">0</span>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyUq36i64Z-JGcERE_rZOdphVtVDX8L-lguc7eiUIdoAERqI1ZK8GWAL-HgbC75cuMHFg/exec";
    const siteBaseUrl = "{{ site.baseurl | default: '' }}";
    
    // 全域變數
    window.cart = [];
    window.globalProducts = [];
    window.shippingRules = [];
    window.selectedMethod = '';

    // 商品卡片模板
    const ITEM_CARD_TEMPLATE = (p, img, isSoldOut) => `{% include item-card.html %}`;

    // --- 初始化與同步 ---
    async function initShop() {
        try {
            const res = await fetch(GAS_URL);
            const data = await res.json();
            if (!data || !data.products) return;
            window.globalProducts = data.products;
            window.shippingRules = (data.shipping_rules || []).map(r => ({
                ...r,
                method: (r.method && r.method.toString().includes('2025-')) ? '7-11' : r.method
            }));
            const localUser = JSON.parse(localStorage.getItem('keicha_v2_user'));
            if (localUser && localUser.phone) syncUserData(localUser.phone);
            renderProducts(window.globalProducts);
            document.getElementById('products-loader').classList.add('hidden');
            renderTopAuth();
        } catch (e) { console.error(e); }
    }

    async function syncUserData(phone) {
        try {
            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'login', phone }) });
            const result = await res.json();
            if (result.success) {
                localStorage.setItem('keicha_v2_user', JSON.stringify(result.data));
                renderTopAuth();
            }
        } catch (e) { }
    }

    // --- 渲染功能 ---
    function renderProducts(prods) {
        const container = document.getElementById('category-container');
        const grouped = prods.reduce((acc, p) => {
            const cat = p.category || "精選選物";
            if (!acc[cat]) acc[cat] = [];
            acc[cat].push(p);
            return acc;
        }, {});

        container.innerHTML = Object.keys(grouped).map(cat => `
            <section>
                <h3 class="text-xl font-bold border-l-4 border-[#6ea44c] pl-3 mb-8 text-gray-800">${cat}</h3>
                <div class="product-grid">
                    ${grouped[cat].map(p => {
                        const stock = parseInt(p.stock) || 0;
                        const isSoldOut = stock <= 0;
                        let img = p.image_url || "";
                        if (img && !img.startsWith('http')) img = siteBaseUrl + (img.startsWith('/') ? img : '/' + img);
                        return ITEM_CARD_TEMPLATE(p, img, isSoldOut);
                    }).join('')}
                </div>
            </section>`).join('');
    }

    function renderTopAuth() {
        const u = JSON.parse(localStorage.getItem('keicha_v2_user'));
        const zone = document.getElementById('top-auth-zone');
        if (u && (u.name || u.phone)) {
            zone.innerHTML = `<button onclick="window.openUserPanel()" class="flex items-center gap-2 brand-green font-bold text-lg hover:opacity-70 transition"><span class="material-symbols-rounded">account_circle</span> ${u.name || u.phone}</button>`;
        } else {
            zone.innerHTML = `<button onclick="window.openLoginPanel()" class="bg-gray-100 text-gray-600 px-8 py-3 rounded-2xl text-sm font-bold hover:bg-gray-200 transition">登入 / 註冊</button>`;
        }
    }

    // --- 購物車 UI (補回 Log 中遺失的函數) ---
    window.updateCartUI = function() {
        const count = window.cart.reduce((s, i) => s + i.qty, 0);
        document.getElementById('cart-count').innerText = count;
        document.getElementById('cart-count').classList.toggle('hidden', count === 0);
        
        const container = document.getElementById('cart-items-container');
        if (window.cart.length === 0) {
            container.innerHTML = `<div class="text-center py-20 text-gray-300 font-bold"><p>購物車是空的</p></div>`;
            document.getElementById('cart-total-price').innerText = "NT$ 0";
            return;
        }

        let total = 0;
        container.innerHTML = window.cart.map((i, idx) => {
            total += i.price * i.qty;
            const imgHTML = i.img ? `<img src="${i.img}" class="w-16 h-16 object-cover rounded-xl bg-gray-50">` : '';
            return `
            <div class="flex items-center gap-4 border-b border-gray-50 pb-4">
                ${imgHTML}
                <div class="flex-1 min-w-0"><div class="text-sm font-bold text-gray-800 truncate">${i.name}</div><div class="text-xs brand-green font-mono mt-1">NT$ ${i.price.toLocaleString()}</div></div>
                <div class="flex items-center gap-2">
                    <div class="qty-control scale-75 origin-right">
                        <button class="qty-btn" onclick="window.updateCartQty(${idx}, -1)">-</button>
                        <span class="text-xs font-bold w-4 text-center">${i.qty}</span>
                        <button class="qty-btn" onclick="window.updateCartQty(${idx}, 1)">+</button>
                    </div>
                    <button onclick="window.removeFromCart(${idx})" class="material-symbols-rounded text-gray-300 hover:text-red-500 transition p-1">close</button>
                </div>
            </div>`;
        }).join('');
        document.getElementById('cart-total-price').innerText = "NT$ " + total.toLocaleString();
    }

    // --- 會員面板管理 (補回 Log 中遺失的函數) ---
// --- 會員面板管理 (優化版：包含編輯切換、電話顯示與儲存動畫) ---

/**
 * 渲染會員資料：取得資料時直接顯示出店號+備註內容，並顯示電話
 */
window.renderUserFields = function() {
    const u = JSON.parse(localStorage.getItem('keicha_v2_user') || '{}');
    if (!u.phone) return;

    // 顯示目前帳號的電話號碼
    const phoneDisplay = document.getElementById('display-user-phone');
    if (phoneDisplay) phoneDisplay.innerText = u.phone;

    // 1. 個人資訊顯示區 (姓名及 Mail)
    const nameText = document.getElementById('text-name');
    const emailText = document.getElementById('text-email');
    if (nameText) nameText.innerText = u.name || '未填寫';
    if (emailText) emailText.innerText = u.email || '未填寫';

    // 2. 物流資料顯示區 (合併店號與備註內容)
    const d711 = document.getElementById('display-711');
    const dFami = document.getElementById('display-fami');
    const dAddr = document.getElementById('display-addr');

    if (d711) d711.innerText = u.store_711 ? `${u.store_711} ${u.store_711_note || ''}`.trim() : '尚未設定';
    if (dFami) dFami.innerText = u.store_fami ? `${u.store_fami} ${u.store_fami_note || ''}`.trim() : '尚未設定';
    if (dAddr) dAddr.innerText = u.shipping_address || '尚未設定';

    // 3. 填入 Input 預設值 (供編輯使用)
    const fields = ['name', 'email', '711', '711-note', 'fami', 'fami-note', 'addr'];
    fields.forEach(f => {
        const input = document.getElementById(`upd-${f}`);
        const key = f.replace('-', '_').replace('addr', 'shipping_address');
        if (input) input.value = u[key] || '';
    });
};

/**
 * 切換編輯模式：按下新增或是編輯後才會出現輸入框與「查詢門市」按鈕
 * @param {string} type - 'info' 或 'ship'
 */
window.toggleEdit = function(type) {
    if (type === 'info') {
        const disp = document.getElementById('info-display');
        const edit = document.getElementById('info-edit');
        if (disp && edit) {
            disp.classList.toggle('hidden');
            edit.classList.toggle('hidden');
        }
    } else if (type === 'ship') {
        // 物流設定區：切換顯示/編輯狀態與查詢按鈕
        const sections = ['711', 'fami', 'addr'];
        sections.forEach(s => {
            const d = document.getElementById(`display-${s}`);
            const e = document.getElementById(`edit-${s}`);
            if (d && e) {
                d.classList.toggle('hidden');
                e.classList.toggle('hidden');
            }
        });
        // 顯示查詢按鈕
        const q711 = document.getElementById('btn-711-query');
        const qFami = document.getElementById('btn-fami-query');
        if (q711) q711.classList.toggle('hidden');
        if (qFami) qFami.classList.toggle('hidden');
    }
};

/**
 * 儲存資料：同步雲端並執行載入動畫
 */
window.saveFullUser = async function() {
    const btn = document.getElementById('btn-user-save');
    const icon = document.getElementById('save-icon');
    const text = document.getElementById('save-text');
    
    // 1. 開始動畫狀態
    btn.disabled = true;
    const originalText = text.innerText;
    text.innerText = "資料同步中...";
    icon.classList.add('animate-spin-custom');
    icon.innerText = "sync";

    const u = JSON.parse(localStorage.getItem('keicha_v2_user') || '{}');
    const updatedData = {
        ...u,
        action: 'save',
        name: document.getElementById('upd-name').value,
        email: document.getElementById('upd-email').value,
        store_711: document.getElementById('upd-711').value,
        store_711_note: document.getElementById('upd-711-note').value,
        store_fami: document.getElementById('upd-fami').value,
        store_fami_note: document.getElementById('upd-fami-note').value,
        shipping_address: document.getElementById('upd-addr').value
    };

    try {
        const response = await fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify(updatedData)
        });
        const result = await response.json();
        
        if (result.success) {
            localStorage.setItem('keicha_v2_user', JSON.stringify(updatedData));
            window.renderUserFields(); // 重新渲染顯示文字
            
            // 2. 結束動畫並恢復模式
            alert("會員資料已更新！");
            // 強制關閉所有編輯視窗回歸顯示模式
            const infoEdit = document.getElementById('info-edit');
            const infoDisp = document.getElementById('info-display');
            if (infoEdit && !infoEdit.classList.contains('hidden')) window.toggleEdit('info');
            
            const edit711 = document.getElementById('edit-711');
            if (edit711 && !edit711.classList.contains('hidden')) window.toggleEdit('ship');
        }
    } catch (error) {
        console.error("Save Error:", error);
        alert("連線失敗，請稍後再試");
    } finally {
        // 3. 恢復按鈕原始狀態
        btn.disabled = false;
        text.innerText = originalText;
        icon.classList.remove('animate-spin-custom');
        icon.innerText = "cloud_upload";
    }
};

/**
 * 安全登出
 */
window.handleLogout = function() {
    if (confirm("確定要登出並清除本地快取資料嗎？")) {
        localStorage.removeItem('keicha_v2_user');
        location.reload();
    }
};

    // --- 面板與互動控制 ---
    window.openLoginPanel = function() { document.getElementById('login-panel').classList.add('open'); document.getElementById('global-overlay').classList.add('open'); };
    window.openUserPanel = function() { window.renderUserFields(); document.getElementById('user-panel').classList.add('open'); document.getElementById('global-overlay').classList.add('open'); };
    window.openCart = function() { window.updateCartUI(); document.getElementById('cart-sidebar').classList.add('open'); document.getElementById('global-overlay').classList.add('open'); };
    window.closeAllPanels = function() { document.querySelectorAll('.side-panel, .overlay').forEach(p => p.classList.remove('open')); };
    
    window.adjQty = function(pid, delta) { const el = document.getElementById(`iq-${pid}`); let v = parseInt(el.innerText) + delta; if(v >= 1) el.innerText = v; };
    window.updateCartQty = function(idx, d) { window.cart[idx].qty += d; if(window.cart[idx].qty <= 0) window.cart.splice(idx, 1); window.updateCartUI(); };
    window.removeFromCart = function(idx) { window.cart.splice(idx, 1); window.updateCartUI(); };
    
    window.addToCart = function(pid) { 
        const p = window.globalProducts.find(x => x.product_id === pid); 
        const qty = parseInt(document.getElementById(`iq-${pid}`).innerText); 
        const inCart = window.cart.find(x => x.id === pid); 
        if (inCart) inCart.qty += qty; 
        else window.cart.push({ id: pid, name: p.product_name, price: p.price, qty: qty, img: p.image_url, category: p.category }); 
        window.updateCartUI(); window.openCart(); 
    };

window.handleQuickLogin = async function() {
    const phone = document.getElementById('login-phone').value;
    if(!/^09\d{8}$/.test(phone)) return alert("格式錯誤");

    const btn = document.getElementById('login-submit-btn');
    const icon = document.getElementById('login-icon');
    
    // 開啟動畫
    btn.disabled = true;
    icon.innerText = "sync";
    icon.classList.add('animate-spin-custom');

    try {
        const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'login', phone }) });
        const data = await res.json();
        if(data.success) {
            localStorage.setItem('keicha_v2_user', JSON.stringify(data.data));
            renderTopAuth();
            window.closeAllPanels();
        }
    } catch(e) { alert("連線失敗"); } finally {
        // 結束動畫
        btn.disabled = false;
        icon.innerText = "arrow_forward";
        icon.classList.remove('animate-spin-custom');
    }
};

    // --- 結帳相關 ---
    window.openCheckout = function() {
        if(window.cart.length === 0) return alert("購物車空的");
        window.closeAllPanels();
        setTimeout(() => {
            document.getElementById('checkout-panel').classList.add('open');
            document.getElementById('global-overlay').classList.add('open');
            // ...這裡需有 renderShipOptions 邏輯 (可放在 panel-checkout 元件內或補齊)
        }, 150);
    };

    window.onload = initShop;
</script>
