---
layout: default
title: KEICHA 網路商店
---

<style>
    .brand-green { color: #6ea44c; }
    .bg-brand-green { background-color: #6ea44c; }
    
    /* 側邊面板與遮罩 */
    .side-panel {
        position: fixed; top: 0; right: 0; height: 100%; width: 100%; max-width: 420px;
        background-color: white; z-index: 200; transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column;
        box-shadow: -4px 0 15px rgba(0,0,0,0.1);
    }
    .side-panel.open { transform: translateX(0); }
    
    .overlay {
        position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 190;
        opacity: 0; visibility: hidden; transition: opacity 0.3s; backdrop-filter: blur(4px);
    }
    .overlay.open { opacity: 1; visibility: visible; }

    /* 購物車樣式 */
    .cart-item-row { display: flex; align-items: center; gap: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #f3f4f6; }
    .cart-item-img { width: 64px; height: 64px; object-fit: cover; border-radius: 8px; background-color: #f9fafb; }
    .cart-qty-control { display: flex; align-items: center; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 2px; }
    .cart-qty-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #6ea44c; cursor: pointer; }
    .cart-qty-num { width: 30px; text-align: center; font-size: 13px; font-weight: 700; color: #374151; }
    .btn-outline-brand { background-color: white; color: #6ea44c; border: 2px solid #6ea44c; width: 100%; padding: 0.8rem; border-radius: 0.75rem; font-weight: bold; transition: all 0.2s; font-size: 0.875rem; }
    .btn-outline-brand:hover { background-color: rgba(110, 164, 76, 0.05); }

    /* 輸入框樣式 */
    .user-edit-input { width: 100%; padding: 0.5rem 0; border: none; border-bottom: 2px solid #6ea44c; outline: none; background-color: transparent; transition: all 0.3s; }
    .checkout-inline-input { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; outline: none; transition: border-color 0.2s; }
    .checkout-inline-input:focus { border-color: #6ea44c; ring: 1px solid #6ea44c; }
    
    /* 懸浮購物車按鈕 */
    .cart-floating-btn {
        position: fixed; bottom: 2rem; right: 2rem; width: 4rem; height: 4rem;
        background-color: #6ea44c; color: white; border-radius: 50%;
        display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    /* 載入中動畫 */
    .animate-spin-custom { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* 數量控制 */
    .qty-control { 
        display: flex; 
        align-items: center; 
        justify-content: space-between;
        background: #ffffff; 
        border: 1px solid #e5e7eb; 
        border-radius: 0.75rem;
        padding: 0 8px; 
        height: 48px;
        box-sizing: border-box;
    }
    .qty-btn { 
        width: 32px; 
        height: 32px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        background: transparent; 
        border-radius: 8px; 
        font-weight: bold; 
        cursor: pointer; 
        border: none;
        color: #6ea44c;
        transition: background-color 0.2s;
    }
    .qty-btn:hover { background-color: #f3f4f6; }
    .add-btn { height: 48px !important; display: flex; align-items: center; justify-content: center; padding: 0 16px; }

    /* 手機版適配 */
    @media (max-width: 767px) {
        .mobile-product-card { display: flex !important; flex-direction: column !important; padding: 16px !important; gap: 12px !important; }
        .card-top-row { display: flex !important; flex-direction: row !important; align-items: flex-start !important; gap: 16px !important; width: 100%; }
        .card-img-group { width: 100px !important; height: 100px !important; flex-shrink: 0 !important; border-radius: 12px !important; overflow: hidden; background-color: #f9fafb; }
        .card-info-group { flex: 1 !important; display: flex !important; flex-direction: column !important; justify-content: space-between; min-height: 100px; }
        .card-bottom-row { display: flex !important; flex-direction: row !important; gap: 12px !important; width: 100%; padding: 0 !important; border-top: none !important; }
        .qty-control { flex: 1 !important; }
        .add-btn { flex: 1.5 !important; }
    }
</style>

<div class="bg-white border-b border-gray-100">
    <div class="container mx-auto px-4 max-w-6xl py-6 flex justify-between items-center">
        <h1 class="text-2xl font-bold tracking-tight text-gray-800">KEICHA 網路商店</h1>
        <div id="top-auth-zone"></div>
    </div>
</div>

<section id="announcement-section" class="hidden py-3 bg-yellow-50 border-b border-yellow-100">
    <div class="container mx-auto px-4 text-center text-sm font-medium text-yellow-800" id="announcement-content"></div>
</section>

<main class="max-w-6xl mx-auto p-4 md:p-10 space-y-12 min-h-screen">
    <div id="products-loader" class="flex justify-center items-center h-48">
        <div class="w-10 h-10 border-4 border-gray-200 border-t-[#6ea44c] rounded-full animate-spin"></div>
    </div>
    <div id="category-container" class="space-y-16"></div>
</main>

<div id="global-overlay" class="overlay" onclick="closeAllPanels()"></div>

<div id="login-panel" class="side-panel">
    <div class="p-6 bg-[#6ea44c] text-white flex justify-between items-center">
        <h3 class="font-bold flex items-center gap-2 text-white"><span class="material-symbols-rounded">login</span> 會員登入</h3>
        <button onclick="closeAllPanels()" class="material-symbols-rounded text-white">close</button>
    </div>
    <div class="p-8 space-y-6">
        <div class="text-center space-y-2"><p class="text-gray-600 font-bold">歡迎來到 KEICHA</p><p class="text-xs text-gray-400">請輸入手機號碼快速登入</p></div>
        <input type="tel" id="login-phone" placeholder="例如：0912345678" class="w-full p-4 bg-gray-50 border rounded-2xl text-lg font-bold outline-none focus:ring-1 ring-[#6ea44c]">
        <button onclick="handleQuickLogin()" id="login-submit-btn" class="w-full bg-[#6ea44c] text-white py-4 rounded-2xl font-bold shadow-lg flex justify-center items-center gap-2">
            <span id="login-text">下一步</span><span id="login-icon" class="material-symbols-rounded">arrow_forward</span>
        </button>
    </div>
</div>

<div id="cart-sidebar" class="side-panel">
    <div class="p-6 border-b flex justify-between items-center bg-white sticky top-0 z-10">
        <h3 class="font-bold flex items-center gap-2 text-gray-800"><span class="material-symbols-rounded">shopping_cart</span> 購物車</h3>
        <button onclick="closeAllPanels()" class="material-symbols-rounded text-gray-400 hover:text-gray-600">close</button>
    </div>
    <div id="cart-items-container" class="flex-grow overflow-y-auto p-6 space-y-6"></div>
    <div class="p-6 border-t bg-gray-50 space-y-3">
        <div class="flex justify-between items-center font-bold mb-2">
            <span class="text-gray-600">商品小計</span>
            <span id="cart-total-price" class="text-xl brand-green">NT$ 0</span>
        </div>
        <button id="trigger-checkout-btn" class="w-full bg-[#6ea44c] text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2">前往結帳 <span class="material-symbols-rounded text-sm">arrow_forward</span></button>
        <button onclick="closeAllPanels()" class="btn-outline-brand flex items-center justify-center gap-2"><span class="material-symbols-rounded text-sm">arrow_back</span> 返回商店繼續選購</button>
    </div>
</div>

<div id="user-panel" class="side-panel">
    <div class="p-6 bg-[#6ea44c] text-white flex justify-between items-center sticky top-0 z-10">
        <h3 class="font-bold flex items-center gap-2"><span class="material-symbols-rounded">account_circle</span> 會員資料管理</h3>
        <button onclick="closeAllPanels()" class="material-symbols-rounded text-white">close</button>
    </div>
    <div id="panel-body" class="p-8 flex-1 overflow-y-auto space-y-10">
        <div class="flex items-center justify-between bg-gray-50 p-4 rounded-2xl"><span class="text-xs font-bold text-gray-400 uppercase">目前帳號</span><span id="display-user-phone" class="font-mono font-bold text-[#6ea44c]">-</span></div>
        <section class="space-y-4">
            <div class="flex justify-between items-center border-b border-gray-100 pb-2"><h4 class="text-xs font-bold brand-green uppercase">個人基本資訊</h4><button onclick="toggleEdit('info')" class="material-symbols-rounded text-[#6ea44c]">edit_square</button></div>
            <div class="space-y-6">
                <div><label class="text-[10px] text-gray-400 font-bold block mb-1">收件人全名</label><span id="text-name" class="font-bold text-gray-700"></span><input type="text" id="upd-name" class="user-edit-input font-bold hidden"></div>
                <div><label class="text-[10px] text-gray-400 font-bold block mb-1">電子郵件</label><span id="text-email" class="text-gray-700"></span><input type="email" id="upd-email" class="user-edit-input hidden"></div>
                <div id="info-edit-actions" class="hidden flex gap-3"><button onclick="saveFullUser('info')" id="save-btn-info" class="flex-1 bg-[#6ea44c] text-white py-3 rounded-xl font-bold">儲存</button><button onclick="toggleEdit('info')" class="flex-1 border border-gray-300 text-gray-600 py-3 rounded-xl font-bold">取消</button></div>
            </div>
        </section>
        <section class="pt-6 border-t border-gray-100 flex flex-col gap-3">
            <button onclick="closeAllPanels()" class="w-full border border-gray-200 text-gray-600 py-4 rounded-xl font-bold">關閉會員中心</button>
            <button onclick="handleLogout()" class="w-full text-xs text-gray-300 font-bold py-3 text-center">安全登出此帳號</button>
        </section>
    </div>
</div>

<div id="checkout-panel" class="side-panel">
    <div class="p-6 bg-[#6ea44c] text-white flex justify-between items-center sticky top-0 z-10">
        <h3 class="font-bold flex items-center gap-2"><span class="material-symbols-rounded">shopping_cart_checkout</span> 訂單結帳確認</h3>
        <button onclick="closeAllPanels()" class="material-symbols-rounded text-white">close</button>
    </div>
    <div class="p-8 flex-1 overflow-y-auto space-y-10">
        <section class="space-y-4">
            <div class="flex justify-between items-center border-b border-gray-100 pb-2"><h4 class="text-xs font-bold brand-green uppercase">基本資料確認</h4><button onclick="toggleCheckoutEdit('info')" class="text-[10px] brand-green font-bold border border-[#6ea44c] px-2 py-0.5 rounded-lg">編輯</button></div>
            <div id="checkout-view-info" class="space-y-4 bg-gray-50/50 p-4 rounded-2xl">
                <div><label class="text-[10px] text-gray-400 font-bold block mb-1">手機號碼</label><div id="checkout-info-phone" class="font-bold text-gray-700 font-mono">-</div></div>
                <div><label class="text-[10px] text-gray-400 font-bold block mb-1">收件人全名</label><div id="checkout-info-name" class="font-bold text-gray-700 text-sm">-</div></div>
                <div><label class="text-[10px] text-gray-400 font-bold block mb-1">電子信箱</label><div id="checkout-info-email" class="font-bold text-gray-700 text-sm break-all">-</div></div>
            </div>
            <div id="checkout-edit-info" class="hidden bg-gray-50 p-4 rounded-2xl space-y-3">
                <input type="text" id="chk-input-name" class="checkout-inline-input w-full" placeholder="收件人姓名">
                <input type="email" id="chk-input-email" class="checkout-inline-input w-full" placeholder="電子郵件">
                <div class="flex gap-2"><button onclick="saveCheckoutData('info')" id="chk-save-info" class="flex-1 bg-[#6ea44c] text-white py-2 rounded-lg text-xs font-bold">儲存</button><button onclick="toggleCheckoutEdit('info')" class="flex-1 border border-gray-300 text-gray-500 py-2 rounded-lg text-xs font-bold">取消</button></div>
            </div>
            <input type="text" id="order-line-name" class="user-edit-input font-bold" placeholder="請輸入您的 LINE 名稱">
        </section>

        <section class="space-y-4">
            <h4 class="text-xs font-bold brand-green uppercase border-b border-gray-100 pb-2">選擇收件方式</h4>
            <div id="ship-options-container" class="space-y-3">
                <div onclick="selectShipMethod('7-11')" id="opt-7-11" class="ship-opt-card p-5 rounded-3xl border-2 border-gray-50 cursor-pointer transition-all">
                    <div class="flex justify-between items-center"><div class="flex items-center gap-3"><span class="material-symbols-rounded">local_shipping</span><div><div class="font-bold text-sm">7-11 店到店</div><div id="checkout-display-7-11" class="text-[11px] text-gray-500">-</div></div></div></div>
                </div>
                <div onclick="selectShipMethod('fami')" id="opt-fami" class="ship-opt-card p-5 rounded-3xl border-2 border-gray-50 cursor-pointer transition-all">
                    <div class="flex justify-between items-center"><div class="flex items-center gap-3"><span class="material-symbols-rounded">store</span><div><div class="font-bold text-sm">全家 店到店</div><div id="checkout-display-fami" class="text-[11px] text-gray-500">-</div></div></div></div>
                </div>
                <div onclick="selectShipMethod('addr')" id="opt-addr" class="ship-opt-card p-5 rounded-3xl border-2 border-gray-50 cursor-pointer transition-all">
                    <div class="flex justify-between items-center"><div class="flex items-center gap-3"><span class="material-symbols-rounded">home</span><div><div class="font-bold text-sm">宅配到府</div><div id="checkout-display-addr" class="text-[11px] text-gray-500">-</div></div></div></div>
                </div>
            </div>
        </section>

        <section class="bg-gray-50 p-6 rounded-3xl space-y-4">
            <div class="flex justify-between text-sm text-gray-500"><span>總計金額</span><span id="summary-total" class="brand-green font-mono font-bold">NT$ 0</span></div>
        </section>

        <button onclick="handlePlaceOrder()" id="btn-submit-order" class="w-full bg-[#6ea44c] text-white py-4 rounded-2xl font-bold shadow-lg flex justify-center items-center gap-2">確認送出訂單</button>
    </div>
</div>

<div class="cart-floating-btn" onclick="openCart()"><span class="material-symbols-rounded text-3xl">shopping_bag</span><span id="cart-count" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full border-2 border-white hidden">0</span></div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyUq36i64Z-JGcERE_rZOdphVtVDX8L-lguc7eiUIdoAERqI1ZK8GWAL-HgbC75cuMHFg/exec"; 
    const siteBaseUrl = "{{ site.baseurl | default: '' }}";
    let cart = [];
    let globalProducts = [];
    let shippingRules = [];
    let selectedMethod = '';

    document.addEventListener('DOMContentLoaded', () => {
        initShop();
        const checkoutBtn = document.getElementById('trigger-checkout-btn');
        if(checkoutBtn) { checkoutBtn.addEventListener('click', openCheckout); }
    });

    async function initShop() {
        try {
            const res = await fetch(GAS_URL);
            const data = await res.json();
            if (!data || !data.products) {
                document.getElementById('products-loader').innerText = "載入失敗，請重新整理";
                return;
            }
            globalProducts = data.products;
            shippingRules = (data.shipping_rules || []).map(r => ({
                ...r,
                method: (r.method && r.method.toString().includes('2025-')) ? '7-11' : r.method
            }));
            renderProducts(globalProducts);
            document.getElementById('products-loader').classList.add('hidden');
            renderTopAuth();
        } catch (e) { 
            document.getElementById('products-loader').innerText = "連線錯誤";
        }
    }

    function renderProducts(products) {
        if (!products || !Array.isArray(products)) return;
        const container = document.getElementById('category-container');
        const grouped = products.reduce((acc, p) => {
            const cat = p.category || "精選選物";
            if (!acc[cat]) acc[cat] = [];
            acc[cat].push(p);
            return acc;
        }, {});

        container.innerHTML = Object.keys(grouped).map(cat => `
            <section class="space-y-6">
                <h3 class="text-xl font-bold border-l-4 border-[#6ea44c] pl-3">${cat}</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-10">
                    ${grouped[cat].map(p => {
                        const stock = parseInt(p.stock) || 999;
                        const isSoldOut = stock <= 0;
                        return `
                        <div class="bg-white rounded-2xl border border-gray-100 overflow-hidden shadow-sm flex flex-col mobile-product-card transition hover:shadow-lg">
                            <div class="card-info-group p-5">
                                <h4 class="font-bold text-gray-800 mb-1 text-sm line-clamp-1">${p.product_name}</h4>
                                <div class="brand-green font-bold text-lg font-mono">NT$ ${p.price}</div>
                            </div>
                            <div class="card-bottom-row p-5 flex gap-2">
                                <div class="qty-control">
                                    <button class="qty-btn" onclick="adjQty('${p.product_id}', -1)">-</button>
                                    <span id="iq-${p.product_id}" class="text-xs font-bold px-2">1</span>
                                    <button class="qty-btn" onclick="adjQty('${p.product_id}', 1)">+</button>
                                </div>
                                <button onclick="addToCart('${p.product_id}')" class="add-btn flex-1 bg-[#6ea44c] text-white rounded-xl text-xs font-bold ${isSoldOut ? 'bg-gray-100 text-gray-300 cursor-not-allowed' : ''}" ${isSoldOut ? 'disabled' : ''}>${isSoldOut ? '補貨中' : '加入購物車'}</button>
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            </section>
        `).join('');
    }

    function adjQty(pid, delta) {
        const el = document.getElementById(`iq-${pid}`);
        let v = parseInt(el.innerText) + delta;
        if(v < 1) v = 1;
        el.innerText = v;
    }

    function addToCart(pid) {
        const p = globalProducts.find(x => x.product_id === pid);
        const qty = parseInt(document.getElementById(`iq-${pid}`).innerText);
        const inCart = cart.find(x => x.id === pid);
        if (inCart) inCart.qty += qty; else cart.push({ id: pid, name: p.product_name, price: p.price, qty: qty });
        updateCartUI();
        openCart();
    }

    function updateCartUI() {
        const count = cart.reduce((s, i) => s + i.qty, 0);
        const elCount = document.getElementById('cart-count');
        elCount.innerText = count;
        elCount.classList.toggle('hidden', count === 0);
        let total = cart.reduce((s, i) => s + i.price * i.qty, 0);
        document.getElementById('cart-total-price').innerText = "NT$ " + total.toLocaleString();
    }

    function openCheckout() {
        const u = JSON.parse(localStorage.getItem('keicha_v2_user'));
        if(!u) { openLoginPanel(); return; }
        if(cart.length === 0) { alert("購物車目前是空的"); return; }
        updateCheckoutDisplay(u);
        selectedMethod = '';
        updateSummary();
        closeAllPanels();
        document.getElementById('checkout-panel').classList.add('open');
        document.getElementById('global-overlay').classList.add('open');
    }

    function updateCheckoutDisplay(u) {
        document.getElementById('checkout-info-name').innerText = u.name || '未填寫';
        document.getElementById('checkout-info-email').innerText = u.email || '未填寫';
        document.getElementById('checkout-info-phone').innerText = u.phone;
    }

    function selectShipMethod(id) {
        selectedMethod = (id === 'fami') ? '全家' : (id === 'addr' ? '宅配' : '7-11');
        document.querySelectorAll('.ship-opt-card').forEach(el => el.classList.remove('border-[#6ea44c]'));
        document.getElementById(`opt-${id}`).classList.add('border-[#6ea44c]');
        updateSummary();
    }

    function updateSummary() {
        const subtotal = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
        document.getElementById('summary-total').innerText = `NT$ ${subtotal.toLocaleString()}`;
    }

    async function handlePlaceOrder() {
        const u = JSON.parse(localStorage.getItem('keicha_v2_user'));
        const line = document.getElementById('order-line-name').value.trim();
        
        if(!u.name || !u.email || !selectedMethod || !line) return alert("請完整填寫收件資訊與收件方式");

        const btn = document.getElementById('btn-submit-order');
        const originalText = btn.innerHTML;
        btn.innerHTML = "正在傳送訂單...";
        btn.disabled = true;

        const subtotal = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
        const payload = {
            action: 'checkout',
            name: u.name,
            phone: u.phone,
            email: u.email,
            store: selectedMethod,
            temp: "常溫",
            items: cart.map(i => `${i.name}x${i.qty}`).join(', '),
            subtotal: subtotal,
            shipping: 0,
            date: new Date().toLocaleString('zh-TW'),
            note: document.getElementById('order-note').value,
            line_name: line,
            logistics: selectedMethod,
            join_member: true // 修正重點：觸發後端寫入機制
        };

        try {
            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
            const result = await res.json();
            if(result && result.success) {
                alert("下單成功，感謝您的訂購");
                cart = []; updateCartUI(); closeAllPanels();
            } else {
                alert("訂單傳送失敗，請稍後再試");
            }
        } catch(e) { 
            alert("連線錯誤，請檢查網路狀態"); 
        }
        btn.innerHTML = originalText;
        btn.disabled = false;
    }

    function handleQuickLogin() {
        const phone = document.getElementById('login-phone').value.trim();
        if(!/^09\d{8}$/.test(phone)) return alert("請輸入正確的手機號碼");
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'login', phone }) })
            .then(res => res.json()).then(res => {
                if(res.success) { localStorage.setItem('keicha_v2_user', JSON.stringify(res.data)); renderTopAuth(); closeAllPanels(); }
            });
    }

    function renderTopAuth() {
        const u = JSON.parse(localStorage.getItem('keicha_v2_user'));
        document.getElementById('top-auth-zone').innerHTML = u ? `<button onclick="openUserPanel()" class="brand-green font-bold text-sm">${u.name || u.phone}</button>` : `<button onclick="openLoginPanel()" class="text-gray-400 text-sm font-bold">登入/註冊</button>`;
    }

    function openLoginPanel() { closeAllPanels(); document.getElementById('login-panel').classList.add('open'); document.getElementById('global-overlay').classList.add('open'); }
    function openUserPanel() { document.getElementById('user-panel').classList.add('open'); document.getElementById('global-overlay').classList.add('open'); }
    function openCart() { document.getElementById('cart-sidebar').classList.add('open'); document.getElementById('global-overlay').classList.add('open'); }
    function closeAllPanels() { document.querySelectorAll('.side-panel, .overlay').forEach(p => p.classList.remove('open')); }
    
    window.addToCart = addToCart;
    window.adjQty = adjQty;
    window.handleQuickLogin = handleQuickLogin;
    window.handlePlaceOrder = handlePlaceOrder;
    window.selectShipMethod = selectShipMethod;
    window.openCart = openCart;
    window.closeAllPanels = closeAllPanels;
</script>
