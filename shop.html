---
layout: default
title: KEICHA 網路商店
---

<style>
    /* 品牌與基礎樣式 */
    .brand-green { color: #6ea44c; }
    .bg-brand-green { background-color: #6ea44c; }
    .bg-brand-green-10 { background-color: rgba(110, 164, 76, 0.1); }
    
    /* 側邊面板基礎與動畫 */
    .side-panel {
        position: fixed; top: 0; right: 0; height: 100%; width: 100%; max-width: 420px;
        background-color: white; z-index: 200; transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column;
        box-shadow: -4px 0 15px rgba(0,0,0,0.1);
    }
    .side-panel.open { transform: translateX(0); }
    .overlay {
        position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 190;
        opacity: 0; visibility: hidden; transition: opacity 0.3s; backdrop-filter: blur(4px);
    }
    .overlay.open { opacity: 1; visibility: visible; }

    /* 商品列表 Layout：電腦四欄，手機一欄(搭配橫式卡片) */
    .product-grid { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 1.5rem; }
    @media (min-width: 640px) { .product-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (min-width: 1024px) { .product-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); } }

    /* 手機版橫式卡片樣式修正 */
    @media (max-width: 767px) {
        .mobile-product-card { display: flex !important; flex-direction: column !important; padding: 16px; gap: 12px; }
        .card-top-row { display: flex !important; align-items: center !important; gap: 16px; width: 100%; }
        .card-img-group { width: 100px !important; height: 100px !important; flex-shrink: 0; border-radius: 12px; overflow: hidden; background: #f9f9f9; }
        .card-img-group img { width: 100%; height: 100%; object-fit: cover; }
        .card-info-group { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .card-bottom-row { display: flex !important; gap: 10px; width: 100%; margin-top: 4px; }
        .card-bottom-row .qty-control { flex: 1; justify-content: space-between; }
        .card-bottom-row .add-btn { flex: 1.5; }
    }

    /* 數量控制共用樣式 */
    .qty-control { display: flex; align-items: center; background: #f3f4f6; border-radius: 12px; padding: 4px; gap: 8px; }
    .qty-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: white; border-radius: 8px; font-weight: bold; cursor: pointer; border: 1px solid #e5e7eb; font-size: 1.2rem; }

    /* 懸浮購物車按鈕 */
    .cart-floating-btn {
        position: fixed; bottom: 2rem; right: 2rem; width: 4.5rem; height: 4.5rem;
        background-color: #6ea44c; color: white; border-radius: 50%;
        display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100;
        box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    }
</style>

<header class="bg-white border-b border-gray-100 sticky top-0 z-[60]">
    <div class="container mx-auto px-4 max-w-6xl py-5 flex justify-between items-center">
        <h1 class="text-2xl font-bold tracking-tight text-gray-800 cursor-pointer" onclick="location.reload()">KEICHA</h1>
        <div id="top-auth-zone" class="flex items-center gap-4">
            </div>
    </div>
</header>

<main class="max-w-6xl mx-auto p-4 md:px-10 md:py-12 min-h-[80vh]">
    <div id="products-loader" class="flex flex-col justify-center items-center h-64 space-y-4">
        <div class="w-12 h-12 border-4 border-gray-200 border-t-[#6ea44c] rounded-full animate-spin"></div>
        <p class="text-gray-400 text-sm font-bold">正在為您準備今日選物...</p>
    </div>
    <div id="category-container" class="space-y-16"></div>
</main>

<div class="cart-floating-btn" onclick="openCart()">
    <span class="material-symbols-rounded text-3xl">shopping_bag</span>
    <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-6 h-6 flex items-center justify-center rounded-full border-2 border-white hidden font-bold">0</span>
</div>

<div id="global-overlay" class="overlay" onclick="closeAllPanels()"></div>
{% include panel-login.html %}
{% include panel-user.html %}
{% include panel-cart.html %}
{% include panel-checkout.html %}

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyUq36i64Z-JGcERE_rZOdphVtVDX8L-lguc7eiUIdoAERqI1ZK8GWAL-HgbC75cuMHFg/exec"; 
    const siteBaseUrl = "{{ site.baseurl | default: '' }}";
    let cart = []; 
    let globalProducts = []; 
    let shippingRules = []; 
    let selectedMethod = '';

    // --- 初始化流程 ---
    async function initShop() {
        try {
            const res = await fetch(GAS_URL);
            const data = await res.json();
            if (!data || !data.success) throw new Error("資料獲取失敗");
            
            globalProducts = data.products;
            shippingRules = data.shipping_rules || [];
            
            // 雲端同步會員資料 (解決卡在舊快取問題)
            const localUser = JSON.parse(localStorage.getItem('keicha_v2_user'));
            if (localUser && localUser.phone) syncUserData(localUser.phone);

            renderProducts(globalProducts);
            document.getElementById('products-loader').classList.add('hidden');
            renderTopAuth();
        } catch (e) {
            console.error(e);
            document.getElementById('products-loader').innerHTML = `<p class="text-red-400 font-bold">載入失敗，請重新整理頁面</p>`;
        }
    }

    async function syncUserData(phone) {
        try {
            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'login', phone }) });
            const result = await res.json();
            if (result.success) {
                localStorage.setItem('keicha_v2_user', JSON.stringify(result.data));
                renderTopAuth();
            }
        } catch (e) { console.warn("Member sync failed"); }
    }

    // --- 商品渲染 ---
    function renderProducts(prods) {
        const container = document.getElementById('category-container');
        const grouped = prods.reduce((acc, p) => {
            const cat = p.category || "精選選物";
            if (!acc[cat]) acc[cat] = [];
            acc[cat].push(p);
            return acc;
        }, {});

        container.innerHTML = Object.keys(grouped).map(cat => `
            <section class="space-y-6">
                <h3 class="text-xl font-bold border-l-4 border-[#6ea44c] pl-3 text-gray-800">${cat}</h3>
                <div class="product-grid">
                    ${grouped[cat].map(p => {
                        let img = p.image_url || "";
                        if (img && !img.startsWith('http')) img = siteBaseUrl + (img.startsWith('/') ? img : '/' + img);
                        return `
                        <div class="bg-white rounded-2xl border border-gray-100 overflow-hidden flex flex-col mobile-product-card transition hover:shadow-lg">
                            <div class="card-top-row">
                                ${img ? `<div class="card-img-group"><img src="${img}" alt="${p.product_name}"></div>` : ''}
                                <div class="card-info-group md:p-5">
                                    <h4 class="font-bold text-gray-800 text-sm md:text-base mb-1 line-clamp-1">${p.product_name}</h4>
                                    <p class="brand-green font-bold text-lg font-mono">NT$ ${p.price}</p>
                                </div>
                            </div>
                            <div class="card-bottom-row md:p-5 md:border-t md:flex md:gap-2">
                                <div class="qty-control">
                                    <button class="qty-btn" onclick="adjQty('${p.product_id}',-1)">-</button>
                                    <span id="iq-${p.product_id}" class="text-xs font-bold px-2">1</span>
                                    <button class="qty-btn" onclick="adjQty('${p.product_id}',1)">+</button>
                                </div>
                                <button onclick="addToCart('${p.product_id}')" class="add-btn flex-1 py-3 bg-[#6ea44c] text-white rounded-xl text-xs font-bold shadow-md active:scale-95 transition">加入購物車</button>
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            </section>`).join('');
    }

    // --- 購物車與數量邏輯 ---
    function adjQty(pid, delta) {
        const el = document.getElementById(`iq-${pid}`);
        let v = parseInt(el.innerText) + delta;
        if (v < 1) v = 1;
        el.innerText = v;
    }

    function addToCart(pid) {
        const p = globalProducts.find(x => x.product_id === pid);
        const qty = parseInt(document.getElementById(`iq-${pid}`).innerText);
        const inCart = cart.find(x => x.id === pid);
        
        let fImg = p.image_url || "";
        if (fImg && !fImg.startsWith('http')) fImg = siteBaseUrl + (fImg.startsWith('/') ? fImg : '/' + fImg);

        if (inCart) inCart.qty += qty;
        else cart.push({ id: pid, name: p.product_name, price: p.price, qty: qty, img: fImg, category: p.category });
        
        updateCartUI();
        openCart();
    }

    function updateCartUI() {
        const count = cart.reduce((s, i) => s + i.qty, 0);
        document.getElementById('cart-count').innerText = count;
        document.getElementById('cart-count').classList.toggle('hidden', count === 0);
        
        let total = 0;
        const container = document.getElementById('cart-items-container');
        
        if (cart.length === 0) {
            container.innerHTML = `<div class="flex flex-col items-center justify-center h-48 text-gray-300"><span class="material-symbols-rounded text-5xl">shopping_basket</span><p class="mt-2 font-bold">購物車還沒有東西</p></div>`;
            document.getElementById('cart-total-price').innerText = "NT$ 0";
            return;
        }

        container.innerHTML = cart.map((i, idx) => {
            total += i.price * i.qty;
            return `
            <div class="flex items-center gap-4 border-b border-gray-50 pb-4">
                <img src="${i.img || ''}" class="w-16 h-16 object-cover rounded-xl bg-gray-50">
                <div class="flex-1 min-w-0">
                    <div class="text-sm font-bold text-gray-800 truncate">${i.name}</div>
                    <div class="text-xs brand-green font-mono mt-1">NT$ ${i.price.toLocaleString()}</div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="qty-control scale-75 origin-right">
                        <button class="qty-btn" onclick="updateCartQty(${idx}, -1)">-</button>
                        <span class="text-xs font-bold w-4 text-center">${i.qty}</span>
                        <button class="qty-btn" onclick="updateCartQty(${idx}, 1)">+</button>
                    </div>
                    <button onclick="removeFromCart(${idx})" class="material-symbols-rounded text-gray-300 hover:text-red-400 p-1">close</button>
                </div>
            </div>`;
        }).join('');
        document.getElementById('cart-total-price').innerText = "NT$ " + total.toLocaleString();
    }

    function updateCartQty(idx, delta) {
        cart[idx].qty += delta;
        if (cart[idx].qty <= 0) cart.splice(idx, 1);
        updateCartUI();
    }

    function removeFromCart(idx) { cart.splice(idx, 1); updateCartUI(); }

    // --- 運費與結帳邏輯 ---
    function calculateFinalShipping(method, subtotal) {
        if (!method || shippingRules.length === 0) return 0;
        const cartCats = [...new Set(cart.map(i => i.category.trim()))];
        let activeRule = null; let maxBase = -1;
        
        cartCats.forEach(cat => {
            const rule = shippingRules.find(r => r.method.toString().includes(method) && r.category.trim() === cat);
            if (rule && parseFloat(rule.base) > maxBase) { maxBase = parseFloat(rule.base); activeRule = rule; }
        });
        
        if (!activeRule) activeRule = shippingRules.find(r => r.method.toString().includes(method) && r.category === 'default');
        if (!activeRule) return 0;

        let fee = parseFloat(activeRule.base);
        if (activeRule.t3 && subtotal >= parseFloat(activeRule.t3)) fee = parseFloat(activeRule.f3);
        else if (activeRule.t2 && subtotal >= parseFloat(activeRule.t2)) fee = parseFloat(activeRule.f2);
        else if (activeRule.t1 && subtotal >= parseFloat(activeRule.t1)) fee = parseFloat(activeRule.f1);
        return fee;
    }

    function setShipMethod(id) { 
        selectedMethod = id; 
        renderShipOptions(JSON.parse(localStorage.getItem('keicha_v2_user'))); 
        updateSummary(); 
    }

    function updateSummary() {
        const sub = cart.reduce((s, i) => s + (i.price * i.qty), 0);
        const ship = calculateFinalShipping(selectedMethod, sub);
        document.getElementById('sum-subtotal').innerText = "NT$ " + sub.toLocaleString();
        document.getElementById('sum-shipping').innerText = selectedMethod ? "NT$ " + ship.toLocaleString() : "請選擇收件方式";
        document.getElementById('sum-total').innerText = "NT$ " + (sub + (selectedMethod ? ship : 0)).toLocaleString();
    }

    // --- 元件控制與面板切換 ---
    function openLoginPanel() { closeAllPanels(); document.getElementById('login-panel').classList.add('open'); document.getElementById('global-overlay').classList.add('open'); }
    function openCart() { closeAllPanels(); document.getElementById('cart-sidebar').classList.add('open'); document.getElementById('global-overlay').classList.add('open'); }
    function openCheckout() { if(cart.length === 0) return alert("購物車目前是空的"); const u = JSON.parse(localStorage.getItem('keicha_v2_user')); if(!u) return openLoginPanel(); renderShipOptions(u); updateSummary(); closeAllPanels(); document.getElementById('checkout-panel').classList.add('open'); document.getElementById('global-overlay').classList.add('open'); }
    function openUserPanel() { renderUserFields(); document.getElementById('user-panel').classList.add('open'); document.getElementById('global-overlay').classList.add('open'); }
    function closeAllPanels() { document.querySelectorAll('.side-panel, .overlay').forEach(p => p.classList.remove('open')); }

    function renderTopAuth() {
        const u = JSON.parse(localStorage.getItem('keicha_v2_user'));
        document.getElementById('top-auth-zone').innerHTML = u ? 
            `<button onclick="openUserPanel()" class="flex items-center gap-1 brand-green font-bold text-sm"><span class="material-symbols-rounded">account_circle</span> ${u.name || u.phone}</button>` : 
            `<button onclick="openLoginPanel()" class="text-gray-400 text-sm font-bold">登入 / 註冊</button>`;
    }

    async function handleQuickLogin() {
        const phone = document.getElementById('login-phone').value.trim();
        if(!/^09\d{8}$/.test(phone)) return alert("請輸入正確的手機號碼格式");
        const btn = document.getElementById('login-submit-btn');
        btn.innerText = "驗證中..."; btn.disabled = true;
        
        try {
            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'login', phone }) });
            const data = await res.json();
            if(data.success) {
                localStorage.setItem('keicha_v2_user', JSON.stringify(data.data));
                renderTopAuth();
                closeAllPanels();
            }
        } catch (e) { alert("登入失敗，請稍後再試"); }
        btn.innerText = "登入 / 獲取資料"; btn.disabled = false;
    }

    async function handlePlaceOrder() {
        const line = document.getElementById('checkout-line').value.trim();
        if(!selectedMethod) return alert("請選擇收件方式");
        if(!line) return alert("請填寫您的 LINE 名稱以供聯繫");

        const btn = document.getElementById('place-order-btn');
        btn.innerText = "訂單送出中..."; btn.disabled = true;

        const u = JSON.parse(localStorage.getItem('keicha_v2_user'));
        const sub = cart.reduce((s, i) => s + (i.price * i.qty), 0);
        const ship = calculateFinalShipping(selectedMethod, sub);
        
        const payload = {
            action: 'checkout',
            name: u.name,
            phone: u.phone,
            store: (selectedMethod === '宅配' ? u.shipping_address : (selectedMethod === '7-11' ? u.store_711 : u.store_fami)) + " " + (selectedMethod === '7-11' ? (u.store_711_note||'') : (u.store_fami_note||'')),
            items: cart.map(i => `${i.name}x${i.qty}`).join(','),
            subtotal: sub,
            shipping: ship,
            date: new Date().toLocaleString('zh-TW'),
            note: document.getElementById('checkout-note').value,
            line_name: line
        };

        try {
            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
            const result = await res.json();
            if(result.success) {
                alert("感謝您的訂購！訂單已成功送出。");
                cart = []; updateCartUI(); closeAllPanels();
            }
        } catch(e) { alert("下單失敗，請聯繫客服"); }
        btn.innerText = "確認下單"; btn.disabled = false;
    }

    // 將資料保存邏輯接上
    async function saveFullUser() {
        const u = JSON.parse(localStorage.getItem('keicha_v2_user'));
        const updated = {
            ...u,
            name: document.getElementById('upd-name').value,
            email: document.getElementById('upd-email').value,
            store_711: document.getElementById('upd-711').value,
            store_711_note: document.getElementById('upd-711-note').value,
            store_fami: document.getElementById('upd-fami').value,
            store_fami_note: document.getElementById('upd-fami-note').value,
            shipping_address: document.getElementById('upd-addr').value
        };
        const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'save', ...updated }) });
        const result = await res.json();
        if(result.success) {
            localStorage.setItem('keicha_v2_user', JSON.stringify(updated));
            renderTopAuth();
            alert("雲端資料已同步成功");
        }
    }

    function handleLogout() {
        if(confirm("確定要登出並清除本地緩存嗎？")) {
            localStorage.removeItem('keicha_v2_user');
            location.reload();
        }
    }

    window.onload = initShop;
</script>
