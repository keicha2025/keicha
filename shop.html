// 更新購物車 UI 渲染函數
function updateCartUI() {
    const container = document.getElementById('cart-items-container');
    const count = cart.reduce((s, i) => s + i.qty, 0);
    document.getElementById('cart-count').innerText = count;
    document.getElementById('cart-count').classList.toggle('hidden', count === 0);
    
    let total = 0;
    container.innerHTML = cart.map((i, idx) => {
        total += i.price * i.qty;
        return `
        <div class="flex gap-4 items-center border-b pb-4">
            <img src="${i.img || ''}" class="w-14 h-14 object-cover rounded-lg bg-gray-50">
            
            <div class="flex-1 text-sm">
                <b class="line-clamp-1">${i.name}</b>
                <span class="brand-green font-mono">NT$ ${i.price.toLocaleString()}</span>
            </div>
            
            <div class="flex items-center gap-2">
                <div class="qty-control scale-75 origin-right">
                    <button class="qty-btn" onclick="updateCartQty(${idx}, -1)">-</button>
                    <span class="text-xs font-bold px-1">${i.qty}</span>
                    <button class="qty-btn" onclick="updateCartQty(${idx}, 1)">+</button>
                </div>
                <button onclick="removeFromCart(${idx})" class="material-symbols-rounded text-gray-400 hover:text-red-500 text-base p-1">
                    close
                </button>
            </div>
        </div>`;
    }).join('');
    document.getElementById('cart-total-price').innerText = "NT$ " + total.toLocaleString();
}

// 快速登入驗證 (含 09 驗證)
async function handleQuickLogin() {
    const phone = document.getElementById('login-phone').value.trim();
    const phoneRule = /^09\d{8}$/; // 驗證 09 開頭 10 碼
    
    if (!phone) return alert("請輸入手機號碼");
    if (!phoneRule.test(phone)) return alert("手機號碼格式錯誤，請輸入 09 開頭的 10 碼數字");

    const icon = document.getElementById('login-icon');
    const btn = document.getElementById('login-submit-btn');
    const text = document.getElementById('login-text');

    icon.classList.add('animate-spin');
    text.innerText = "驗證中...";
    btn.disabled = true;

    try {
        const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'login', phone }) });
        const result = await res.json();
        if(result.success) { 
            localStorage.setItem('keicha_v2_user', JSON.stringify(result.data)); 
            renderTopAuth(); 
            closeAllPanels(); 
        }
    } catch(e) { alert("登入失敗"); }
    finally {
        icon.classList.remove('animate-spin');
        text.innerText = "獲取資料";
        btn.disabled = false;
    }
}
