---
layout: default
title: KEICHA 網路商店
---

<style>
    /* --- [保留] 目標網頁原有基礎樣式 --- */
    .brand-green { color: #6ea44c; }
    .bg-brand-green { background-color: #6ea44c; }
    
    .side-panel {
        position: fixed; top: 0; right: 0; height: 100%; width: 100%; max-width: 420px;
        background-color: white; z-index: 200; transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column;
        box-shadow: -4px 0 15px rgba(0,0,0,0.1);
    }
    .side-panel.open { transform: translateX(0); }
    
    .overlay {
        position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 190;
        opacity: 0; visibility: hidden; transition: opacity 0.3s; backdrop-filter: blur(4px);
    }
    .overlay.open { opacity: 1; visibility: visible; }

    /* 購物車與商品卡片專用樣式 (移植自 Source) */
    .qty-control { 
        display: flex; align-items: center; justify-content: space-between;
        background: #ffffff; border: 1px solid #e5e7eb; border-radius: 0.75rem;
        padding: 0 8px; height: 48px; box-sizing: border-box;
    }
    .qty-btn { 
        width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; 
        background: transparent; border-radius: 8px; font-weight: bold; cursor: pointer; border: none;
        color: #6ea44c; transition: background-color 0.2s;
    }
    .qty-btn:hover { background-color: #f3f4f6; }
    .add-btn { height: 48px !important; display: flex; align-items: center; justify-content: center; padding: 0 16px; }

    .cart-item-row { display: flex; align-items: center; gap: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #f3f4f6; }
    .cart-item-img { width: 64px; height: 64px; object-fit: cover; border-radius: 8px; background-color: #f9fafb; }
    .cart-qty-control { display: flex; align-items: center; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 2px; }
    .cart-qty-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #6ea44c; cursor: pointer; }
    .cart-qty-num { width: 30px; text-align: center; font-size: 13px; font-weight: 700; color: #374151; }

    /* 手機版適配 (移植自 Source) */
    @media (max-width: 767px) {
        .mobile-product-card { display: flex !important; flex-direction: column !important; padding: 16px !important; gap: 12px !important; }
        .card-top-row { display: flex !important; flex-direction: row !important; gap: 16px !important; width: 100%; }
        .card-img-group { width: 100px !important; height: 100px !important; flex-shrink: 0 !important; border-radius: 12px !important; overflow: hidden; }
        .card-info-group { flex: 1 !important; display: flex !important; flex-direction: column !important; min-height: 100px; }
        .card-bottom-row { display: flex !important; flex-direction: row !important; gap: 12px !important; width: 100%; }
    }

    .animate-spin-custom { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>

<div class="bg-white border-b border-gray-100 shadow-sm">
    <div class="container mx-auto px-4 max-w-6xl py-4 flex justify-between items-center">
        <h1 class="text-xl md:text-2xl font-bold tracking-tight text-[#6ea44c]">KEICHA 抹茶代購</h1>
        <div id="top-auth-zone"></div>
    </div>
</div>

<section class="py-8 bg-white border-b border-gray-100">
    <div class="container mx-auto px-4 max-w-5xl">
        <h2 class="text-xl font-bold text-center mb-6 text-gray-800 flex items-center justify-center gap-2">
            <span class="material-symbols-rounded text-[#6ea44c]">storefront</span> 品牌總覽
        </h2>
        <div id="status-loader" class="flex justify-center h-20">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10 animate-spin-custom border-t-[#6ea44c]"></div>
        </div>
        <div id="status-grid-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </div>
</section>

<main class="max-w-5xl mx-auto px-4 py-8 pb-32">
    <div id="product-list-container" class="space-y-12"></div>
</main>

<div id="global-overlay" class="overlay" onclick="closeAllPanels()"></div>

<div id="login-panel" class="side-panel">
    <div class="p-6 bg-[#6ea44c] text-white flex justify-between items-center">
        <h3 class="font-bold flex items-center gap-2 text-white"><span class="material-symbols-rounded">login</span> 會員登入</h3>
        <button onclick="closeAllPanels()" class="material-symbols-rounded text-white">close</button>
    </div>
    <div class="p-8 space-y-6">
        <div class="text-center space-y-2"><p class="text-gray-600 font-bold">歡迎來到 KEICHA</p><p class="text-xs text-gray-400">請輸入手機號碼快速登入</p></div>
        <input type="tel" id="login-phone" placeholder="例如：0912345678" class="w-full p-4 bg-gray-50 border rounded-2xl text-lg font-bold outline-none focus:ring-1 ring-[#6ea44c]">
        <button onclick="handleQuickLogin()" id="login-submit-btn" class="w-full bg-[#6ea44c] text-white py-4 rounded-2xl font-bold shadow-lg flex justify-center items-center gap-2">
            <span id="login-text">下一步</span><span id="login-icon" class="material-symbols-rounded">arrow_forward</span>
        </button>
    </div>
</div>

<div id="cart-sidebar" class="side-panel">
    <div class="p-6 border-b flex justify-between items-center bg-white sticky top-0 z-10">
        <h3 class="font-bold flex items-center gap-2 text-gray-800"><span class="material-symbols-rounded">shopping_cart</span> 購物車</h3>
        <button onclick="closeAllPanels()" class="material-symbols-rounded text-gray-400 hover:text-gray-600">close</button>
    </div>
    <div id="cart-items-container" class="flex-grow overflow-y-auto p-6 space-y-6"></div>
    <div class="p-6 border-t bg-gray-50 space-y-3">
        <div class="flex justify-between items-center font-bold mb-2">
            <span class="text-gray-600">商品小計</span>
            <span id="cart-total-price" class="text-xl brand-green">NT$ 0</span>
        </div>
        <button onclick="openCheckout()" class="w-full bg-[#6ea44c] text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl active:scale-[0.98] transition-all flex items-center justify-center gap-2">
            前往結帳 <span class="material-symbols-rounded text-sm">arrow_forward</span>
        </button>
        <button onclick="closeAllPanels()" class="btn-outline-brand flex items-center justify-center gap-2">
            <span class="material-symbols-rounded text-sm">arrow_back</span> 返回商店
        </button>
    </div>
</div>

<div class="cart-floating-btn" onclick="openCart()">
    <span class="material-symbols-rounded text-3xl">shopping_bag</span>
    <span id="cart-count" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full border-2 border-white hidden">0</span>
</div>

<script>
    // --- 核心分工 ---
    const DISPLAY_API_URL = "https://script.google.com/macros/s/AKfycbxnxbcdCdxH2Qmuek5Up8BqTWeOLUcLR30jfUi0lMbMn5ocn9tY1f_c7yEyd9KSZ4Um/exec"; // 商品庫
    const ORDER_API_URL = "https://script.google.com/macros/s/AKfycbyUq36i64Z-JGcERE_rZOdphVtVDX8L-lguc7eiUIdoAERqI1ZK8GWAL-HgbC75cuMHFg/exec"; // 會員+訂單後台
    const BASE_REPO_URL = "assets/images/"; 

    let cart = [];
    let tempQtyMap = {};
    let globalProducts = [];
    let shippingRules = [];
    let selectedMethod = '';

    document.addEventListener('DOMContentLoaded', () => {
        initShop();
    });

    // --- 1. 初始化讀取 (使用 DISPLAY_API) ---
    async function initShop() {
        const statusLoader = document.getElementById('status-loader');
        try {
            const res = await fetch(DISPLAY_API_URL);
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            
            globalProducts = data.products || [];
            
            // 讀取運費規則 (可能在 DISPLAY 或 ORDER API，抹茶版通常在 ORDER API 內，故需額外 fetch)
            fetch(ORDER_API_URL).then(r => r.json()).then(oData => {
                if(oData.success && oData.shipping_rules) shippingRules = oData.shipping_rules;
            });

            renderStatusOverview(data.brands);
            renderProductSections(data.brands);
            data.brands.forEach(brand => {
                renderProductCards(brand.key, data.products.filter(p => p.brand_key === brand.key));
            });

            if (statusLoader) statusLoader.style.display = 'none';
            renderTopAuth();
        } catch (e) { 
            console.error("Init Error:", e);
        }
    }

    // --- 2. 會員登入 (使用 ORDER_API) ---
    function handleQuickLogin() {
        const phone = document.getElementById('login-phone').value.trim();
        if(!/^09\d{8}$/.test(phone)) return alert("請輸入正確的手機號碼");
        
        const icon = document.getElementById('login-icon');
        const text = document.getElementById('login-text');
        icon.classList.add('animate-spin'); text.innerText = "驗證中...";
        
        fetch(ORDER_API_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: 'login', phone: phone }) 
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) { 
                localStorage.setItem('keicha_v2_user', JSON.stringify(data.data)); 
                renderTopAuth(); 
                closeAllPanels(); 
                alert(`歡迎回來，${data.data.name || '抹茶好友'}！資料已自動帶入。`);
            } else {
                alert("是新朋友呢！請填寫資料，下單後將自動註冊。");
                localStorage.setItem('keicha_v2_user', JSON.stringify({ phone: phone }));
                renderTopAuth();
                closeAllPanels();
                setTimeout(() => openUserPanel(), 500); 
            }
        })
        .catch(() => alert("系統忙碌中"))
        .finally(() => { 
            icon.classList.remove('animate-spin'); text.innerText = "下一步"; 
        });
    }

    // --- 3. 資料儲存 (使用 ORDER_API) ---
    async function saveDataCommon(section, btnPrefix, isCheckout) {
        const u = JSON.parse(localStorage.getItem('keicha_v2_user'));
        const btn = document.getElementById(`${btnPrefix}-${section}`);
        const originalText = btn.innerHTML;
        
        let updates = {};
        let inputPrefix = isCheckout ? 'chk-input' : 'upd';

        if (section === 'info') {
            updates.name = document.getElementById(`${inputPrefix}-name`).value;
            updates.email = document.getElementById(`${inputPrefix}-email`).value;
        } else if (section === '711') {
            const val = document.getElementById(`${inputPrefix}-711`).value.trim();
            if (!/^\d{6}$/.test(val)) return alert('店號需為6位數字');
            updates.store_711 = val;
            const noteEl = document.getElementById(`${inputPrefix}-711-note`);
            if(noteEl) updates.store_711_note = noteEl.value;
        } // 其他物流類推...

        btn.innerHTML = `儲存中...`;
        btn.disabled = true;

        const newData = { ...u, ...updates };
        try {
            const res = await fetch(ORDER_API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: 'save', ...newData }) 
            });
            const result = await res.json();
            if(result.success) {
                localStorage.setItem('keicha_v2_user', JSON.stringify(newData));
                if(isCheckout) { updateCheckoutDisplay(newData); toggleCheckoutEdit(section); }
                else { renderUserFields(); toggleEdit(section); renderTopAuth(); }
            }
        } catch(e) { alert("儲存失敗"); }
        btn.innerHTML = originalText;
        btn.disabled = false;
    }

    // --- 4. 下單結帳 (使用 ORDER_API) ---
    async function handlePlaceOrder() {
        const u = JSON.parse(localStorage.getItem('keicha_v2_user'));
        const line = document.getElementById('order-line-name').value.trim();
        if(!u.name || !selectedMethod || !line) return alert("請填寫完整資訊");

        const btn = document.getElementById('btn-submit-order');
        btn.innerHTML = `訂單傳送中...`;
        btn.disabled = true;

        const subtotal = calculateCartSubtotal();
        const ship = calculateFinalShipping(selectedMethod, subtotal);
        
        // 抹茶版格式：商品名 x數量 ($單價)
        const itemsStr = cart.map(item => {
            const unitPrice = (item.qty >= 2 && item.price_multi > 0) ? item.price_multi : item.price;
            return `${item.name} x${item.qty} ($${unitPrice})`;
        }).join('\n');

        const payload = {
            action: 'checkout',
            name: u.name, phone: u.phone, email: u.email,
            store: selectedMethod === '宅配' ? u.shipping_address : (selectedMethod === '7-11' ? u.store_711 : u.store_fami),
            items: itemsStr,
            subtotal: subtotal,
            shipping: ship,
            temp: "常溫",
            date: new Date().toISOString(),
            product_note: document.getElementById('order-note').value,
            line_name: line,
            logistics: selectedMethod
        };

        try {
            const res = await fetch(ORDER_API_URL, { method: 'POST', body: JSON.stringify(payload) });
            const result = await res.json();
            if(result.success) {
                alert(`下單成功！訂單編號: ${result.orderId}`);
                cart = []; updateCartUI(); closeAllPanels();
            }
        } catch(e) { alert("系統忙碌中"); }
        btn.innerHTML = `確認送出訂單`;
        btn.disabled = false;
    }

    // --- 商品渲染與購物車邏輯 (略，與前次提供一致) ---
    // ... (包含 renderStatusOverview, renderProductCards, addToCart, updateCartUI 等) ...

    function renderTopAuth() {
        const u = JSON.parse(localStorage.getItem('keicha_v2_user'));
        document.getElementById('top-auth-zone').innerHTML = u ? `<button onclick="openUserPanel()" class="flex items-center gap-1 brand-green font-bold text-sm"><span class="material-symbols-rounded text-lg">account_circle</span> ${u.name || u.phone}</button>` : `<button onclick="openLoginPanel()" class="text-gray-400 text-sm font-bold">登入/註冊</button>`;
    }
    
    function closeAllPanels() { document.querySelectorAll('.side-panel, .overlay').forEach(p => p.classList.remove('open')); }
    function openCart() { document.getElementById('cart-sidebar').classList.add('open'); document.getElementById('global-overlay').classList.add('open'); }
    function openUserPanel() { renderUserFields(); document.getElementById('user-panel').classList.add('open'); document.getElementById('global-overlay').classList.add('open'); }
</script>
