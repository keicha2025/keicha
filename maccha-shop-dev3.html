<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEICHA 抹茶代購下單區</title>
    <link rel="icon" href="data:,">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: '#6ea44c',
                        brandDark: '#5a8a3e',
                        brandBg: '#e8f5e9', // 淺綠背景
                        brandLight: '#f1f8f1',
                    },
                    fontFamily: {
                        sans: ['var(--font-body)', 'sans-serif'],
                        brand: ['var(--font-brand)', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --font-brand: "Zen Maru Gothic", sans-serif;
            --font-body: "Noto Sans TC", sans-serif;
        }

        body { font-family: var(--font-body); background-color: #ffffff; overflow-x: hidden; }
        .font-brand-text { font-family: var(--font-brand); font-weight: 700; }

        /* Loading Spinner */
        .loader { border-top-color: #6ea44c; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Side Panel */
        .side-panel {
            position: fixed; top: 0; right: 0; height: 100%; width: 100%; max-width: 480px; /* 稍微加寬適配新UI */
            background-color: white; z-index: 200; transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column;
            box-shadow: -4px 0 25px rgba(0,0,0,0.15);
        }
        .side-panel.open { transform: translateX(0); }
        
        .overlay {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 190;
            opacity: 0; visibility: hidden; transition: opacity 0.3s; backdrop-filter: blur(4px);
        }
        .overlay.open { opacity: 1; visibility: visible; }

        /* Global UI Elements */
        .btn-primary {
            background-color: #6ea44c; color: white; font-weight: bold;
            box-shadow: 0 4px 6px -1px rgba(110, 164, 76, 0.4); transition: all 0.2s;
        }
        .btn-primary:hover { background-color: #5a8a3e; }
        .btn-primary:active { transform: scale(0.98); }

        .cart-floating-btn {
            position: fixed; bottom: 2rem; right: 2rem; width: 4rem; height: 4rem;
            background-color: #6ea44c; color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: transform 0.2s;
        }
        .cart-floating-btn:active { transform: scale(0.95); }

        /* Input UI Style (新版結帳頁用) */
        .input-ui {
            width: 100%; padding: 12px 16px; border-radius: 12px;
            border: 1px solid #e2e8f0; background-color: #f8fafc;
            color: #334155; font-size: 15px; outline: none; transition: all 0.2s;
        }
        .input-ui:focus {
            background-color: #fff; border-color: #6ea44c; 
            box-shadow: 0 0 0 3px rgba(110, 164, 76, 0.15);
        }

        /* Logistics Card Style */
        .logistics-card {
            border: 1px solid #e2e8f0; border-radius: 16px; background: white; overflow: hidden; transition: all 0.2s;
        }
        .logistics-card:hover { border-color: #cbd5e1; }
        .logistics-card.active {
            border-color: #6ea44c; background-color: #fcfdfc;
            box-shadow: 0 4px 12px rgba(110, 164, 76, 0.08);
        }
        .logistics-card.active .logistics-price { color: #6ea44c; }

        .btn-query-store {
            padding: 0 16px; background-color: #f1f5f9; color: #64748b;
            border-radius: 10px; font-size: 13px; font-weight: 600;
            display: flex; align-items: center; gap: 4px; transition: all 0.2s; text-decoration: none;
        }
        .btn-query-store:hover { background-color: #e2e8f0; color: #334155; }

        /* Full Screen Loading Overlay */
        #checkout-loading-overlay {
            position: absolute; inset: 0; background: rgba(255,255,255,0.9);
            z-index: 50; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #checkout-loading-overlay.active { opacity: 1; pointer-events: auto; }

        /* Cart Group Styles */
        .cart-brand-group { margin-bottom: 24px; border-bottom: 1px dashed #eee; padding-bottom: 16px; }
        .cart-brand-group:last-child { border-bottom: none; }
        
        /* 優惠 Banner 樣式 */
        .discount-banner {
            background-color: #e8f5e9; color: #2e7d32;
            font-size: 13px; font-weight: bold;
            padding: 6px 12px; border-radius: 8px;
            margin-bottom: 12px; display: inline-flex; items-center; gap: 6px;
        }
    </style>
</head>
<body>

    <div id="overlay" class="overlay" onclick="closeAllPanels()"></div>

    <div class="bg-white border-b border-gray-100 shadow-sm sticky top-0 z-40">
        <div class="container mx-auto px-4 max-w-6xl py-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl md:text-2xl font-bold tracking-tight text-brand">
                    <span class="font-brand-text">KEICHA</span> 抹茶代購
                </h1>
                <p class="text-xs text-brand/60 mt-0.5">同品牌任選 2 件 • 即享多入優惠價</p>
            </div>
            </div>
    </div>

    <main class="max-w-5xl mx-auto px-4 py-8 pb-32">
        <div id="status-loader" class="flex justify-center h-20">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div>
        </div>
        <div id="product-list-container" class="space-y-12"></div>
    </main>

    <div class="cart-floating-btn" onclick="openCart()">
        <span class="material-symbols-rounded text-3xl">shopping_bag</span>
        <span id="cart-badge" class="absolute top-0 right-0 bg-white text-brand text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full border border-gray-100 hidden">0</span>
    </div>

    <div id="cart-sidebar" class="side-panel">
        <div class="p-5 border-b flex justify-between items-center bg-white sticky top-0 z-10">
            <h3 class="font-bold flex items-center gap-2 text-gray-800 text-lg">
                <span class="material-symbols-rounded">shopping_cart</span> 購物車
            </h3>
            <button onclick="closeAllPanels()" class="material-symbols-rounded text-gray-400 hover:text-gray-600">close</button>
        </div>
        
        <div id="cart-items-container" class="flex-grow overflow-y-auto p-5">
            </div>

        <div class="p-5 border-t bg-gray-50 space-y-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <div class="flex justify-between items-center font-bold mb-2">
                <span class="text-gray-600">預估小計</span>
                <span id="bar-total" class="text-xl text-brand font-mono">NT$ 0</span>
            </div>
            <button onclick="openCheckout()" class="w-full btn-primary py-4 rounded-xl flex items-center justify-center text-lg">
                前往結帳
            </button>
            <button onclick="closeAllPanels()" class="w-full bg-white border border-brand text-brand font-bold py-3 rounded-xl hover:bg-brandBg transition text-sm">
                繼續選購
            </button>
        </div>
    </div>

    <div id="checkout-panel" class="side-panel">
        <div class="flex flex-col h-full relative">
            
            <div id="checkout-loading-overlay">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-brand h-12 w-12 mb-4"></div>
                <p class="text-brand font-bold tracking-widest animate-pulse">資料讀取中...</p>
            </div>

            <div class="p-5 bg-white border-b border-gray-100 flex justify-between items-center z-10 shrink-0">
                <h3 class="font-bold flex items-center gap-2 text-lg text-gray-800">
                    <span class="material-symbols-rounded text-brand">shopping_cart_checkout</span> 
                    結帳確認
                </h3>
                <button onclick="closeAllPanels()" class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100 transition">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>

            <form id="order-form" onsubmit="return false;" class="flex-1 overflow-y-auto bg-white pb-40"> 
                <div class="p-5 space-y-8">
                    
                    <section class="bg-gray-50 p-4 rounded-2xl border border-gray-100 space-y-4">
                        <div class="bg-white rounded-xl border border-brandBg overflow-hidden">
                            <ul id="checkout-readonly-list" class="divide-y divide-brandBg bg-[rgba(110,164,76,0.05)]">
                                </ul>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-3 flex items-center gap-1">
                                <span class="material-symbols-rounded text-sm text-brand">smartphone</span> 會員查詢 / 手機號碼
                            </label>
                            <div class="flex gap-2">
                                <input type="tel" id="input-phone" class="input-ui font-bold text-lg tracking-wider" placeholder="09xxxxxxxx" maxlength="10" pattern="^09\d{8}$" required="">
                                <button type="button" onclick="lookupPhoneData(this)" class="bg-brand text-white w-14 rounded-xl flex items-center justify-center hover:bg-brandDark transition disabled:opacity-50">
                                    <span class="material-symbols-rounded">arrow_forward</span>
                                </button>
                            </div>
                            <p id="phone-msg" class="text-xs mt-2 pl-1 h-4 font-medium transition-colors duration-300"></p>
                        </div>
                    </section>

                    <div id="checkout-sections-after-phone" class="hidden space-y-8">
                        
                        <section>
                            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                                <span class="w-1 h-4 bg-brand rounded-full"></span> 配送方式
                            </h4>
                            <div class="space-y-3">
                                <select id="input-logistics" class="hidden"><option value="7-11">7-11</option><option value="全家">全家</option><option value="郵寄/宅配">宅配</option></select>
                                
                                <div class="logistics-card cursor-pointer group" onclick="selectLogistics('7-11', this)">
                                    <div class="p-4 flex justify-between items-center">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-full bg-brandLight flex items-center justify-center text-brand">
                                                <span class="material-symbols-rounded">local_shipping</span>
                                            </div>
                                            <div class="font-bold text-gray-800 text-sm">7-11 店到店</div>
                                        </div>
                                        <span class="text-brand font-bold text-sm logistics-price" data-type="7-11">$60</span>
                                    </div>
                                    <div class="logistics-detail hidden border-t border-brand/20 bg-brandLight/20 p-4 space-y-3" onclick="event.stopPropagation()">
                                        <div class="flex gap-2">
                                            <input type="text" class="input-ui flex-1 text-center font-mono tracking-widest" placeholder="輸入6碼店號" maxlength="6" pattern="^\d{6}$" inputmode="numeric" id="store-id-711" onchange="syncStoreInput()">
                                            <a href="https://www.ibon.com.tw/mobile/retail_inquiry.aspx" target="_blank" class="btn-query-store">
                                                <span class="material-symbols-rounded text-base">map</span> 查詢店號
                                            </a>
                                        </div>
                                        <input type="text" class="input-ui text-sm" placeholder="門市名稱 / 備註" id="store-name-711" onchange="syncStoreInput()">
                                    </div>
                                </div>

                                <div class="logistics-card cursor-pointer group" onclick="selectLogistics('全家', this)">
                                    <div class="p-4 flex justify-between items-center">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-full bg-brandLight flex items-center justify-center text-brand">
                                                <span class="material-symbols-rounded">store</span>
                                            </div>
                                            <div class="font-bold text-gray-800 text-sm">全家 店到店</div>
                                        </div>
                                        <span class="text-brand font-bold text-sm logistics-price" data-type="全家">$60</span>
                                    </div>
                                    <div class="logistics-detail hidden border-t border-brand/20 bg-brandLight/20 p-4 space-y-3" onclick="event.stopPropagation()">
                                        <div class="flex gap-2">
                                            <input type="text" class="input-ui flex-1 text-center font-mono tracking-widest" placeholder="輸入6碼店號" maxlength="6" pattern="^\d{6}$" inputmode="numeric" id="store-id-fami" onchange="syncStoreInput()">
                                            <a href="https://www.family.com.tw/marketing/inquiry.aspx" target="_blank" class="btn-query-store">
                                                <span class="material-symbols-rounded text-base">map</span> 查詢店號
                                            </a>
                                        </div>
                                        <input type="text" class="input-ui text-sm" placeholder="門市名稱 / 備註" id="store-name-fami" onchange="syncStoreInput()">
                                    </div>
                                </div>

                                <div class="logistics-card cursor-pointer group" onclick="selectLogistics('郵寄/宅配', this)">
                                    <div class="p-4 flex justify-between items-center">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-full bg-brandLight flex items-center justify-center text-brand">
                                                <span class="material-symbols-rounded">local_shipping</span>
                                            </div>
                                            <div class="font-bold text-gray-800 text-sm">宅配到府</div>
                                        </div>
                                        <span class="text-brand font-bold text-sm logistics-price" data-type="宅配">$100</span>
                                    </div>
                                    <div class="logistics-detail hidden border-t border-brand/20 bg-brandLight/20 p-4" onclick="event.stopPropagation()">
                                        <textarea id="store-addr" class="input-ui text-sm min-h-[80px]" placeholder="請輸入完整收件地址 (含郵遞區號)" onchange="syncStoreInput()"></textarea>
                                    </div>
                                </div>
                                
                                <input type="hidden" name="store" id="input-store" required="" value="">
                                <input type="hidden" name="store_note" id="input-store-note" value="">
                            </div>
                        </section>

                        <section class="space-y-4">
                            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                                <span class="w-1 h-4 bg-brand rounded-full"></span> 收件資料
                            </h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 mb-1.5 block ml-1">收件人全名 <span class="text-brand">*</span></label>
                                    <input type="text" id="input-name" required="" class="input-ui" placeholder="請輸入真實姓名">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500 mb-1.5 block ml-1">電子信箱 <span class="text-brand">*</span></label>
                                    <input type="email" id="input-email" required="" class="input-ui" placeholder="接收訂單通知">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500 mb-1.5 block ml-1">LINE 顯示名稱</label>
                                    <input type="text" id="input-line" class="input-ui" placeholder="方便聯絡 (選填)">
                                </div>
                            </div>
                        </section>

                        <section class="space-y-4">
                            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                                <span class="w-1 h-4 bg-brand rounded-full"></span> 其他
                            </h4>
                            <textarea id="input-note" class="input-ui min-h-[80px]" placeholder="訂單備註 (選填)..."></textarea>
                            
                            <label class="flex items-center gap-3 p-4 bg-gray-50 border border-gray-100 rounded-xl cursor-pointer hover:bg-gray-100 transition">
                                <div class="relative flex items-center">
                                    <input type="checkbox" id="join-member" class="peer h-5 w-5 cursor-pointer appearance-none rounded border border-gray-300 checked:bg-brand checked:border-brand transition-all" checked="">
                                    <span class="material-symbols-rounded absolute text-white opacity-0 peer-checked:opacity-100 pointer-events-none text-base left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2">check</span>
                                </div>
                                <span class="text-sm text-gray-600 font-medium">同意儲存資料，下次自動帶入</span>
                            </label>
                        </section>
                    </div>
                </div>
            </form>

            <div class="panel-footer shrink-0 p-5 bg-white border-t border-gray-100 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] relative z-20">
                <div class="panel-footer-btn-wrapper">
                    <div class="flex justify-between items-end mb-4">
                        <div class="text-xs text-gray-400 font-medium" id="footer-logistics-name">尚未選擇物流</div>
                        <div class="text-right flex items-baseline gap-2">
                            <span class="text-xs text-gray-400">總金額</span>
                            <span class="text-2xl font-bold text-brand font-mono">NT$ <span id="modal-total">0</span></span>
                        </div>
                    </div>
                    <button id="btn-submit" onclick="submitOrder(this)" disabled class="w-full bg-brand text-white font-bold py-4 rounded-xl text-lg shadow-lg shadow-brand/20 hover:bg-brandDark active:scale-[0.98] transition flex justify-center items-center gap-2 disabled:opacity-50 disabled:bg-gray-300 disabled:shadow-none disabled:cursor-not-allowed">
                        <span class="material-symbols-rounded">verified</span> 確認送出訂單
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyUq36i64Z-JGcERE_rZOdphVtVDX8L-lguc7eiUIdoAERqI1ZK8GWAL-HgbC75cuMHFg/exec";
        const BASE_REPO_URL = "assets/images/"; 

        let cart = [];
        let shippingFee = 0;
        let shippingRules = [];
        let brandsData = []; // 儲存品牌資訊

        // 1. 初始化讀取
        window.addEventListener('load', () => {
            fetch(API_URL) 
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        shippingRules = data.shipping_rules || [];
                        brandsData = data.brands || []; // 假設 API 會回傳 brands
                        renderProductList(data);
                    }
                })
                .catch(err => console.error("Error:", err))
                .finally(() => {
                    document.getElementById('status-loader').style.display = 'none';
                });
        });

        // 2. 渲染商品 (包含修正 addToCart 參數)
        function renderProductList(data) {
            const container = document.getElementById('product-list-container');
            container.innerHTML = '';
            
            // 依照 API 回傳的 brands 渲染區塊 (若 API 結構不同請自行調整)
            // 這裡假設 API 回傳格式為 { brands: [...], products: [...] }
            // 為了相容您原本的邏輯，這裡做簡單處理
            
            const brands = data.brands || []; // 需確保後端有回傳
            const products = data.products || [];

            brands.sort((a,b) => (a.order||99) - (b.order||99)).forEach(brand => {
                const brandProducts = products.filter(p => p.brand_key === brand.key);
                if(brandProducts.length === 0) return;

                const section = document.createElement('section');
                section.className = "scroll-mt-24";
                section.innerHTML = `
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-gray-800 border-b pb-4">
                        <span class="w-2 h-6 bg-brand rounded-full"></span> ${brand.name}
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${brandProducts.map(p => createProductCard(p, brand.key)).join('')}
                    </div>
                `;
                container.appendChild(section);
            });
        }

        function createProductCard(product, brandKey) {
            const productId = product.key || Math.random().toString(36).substr(2, 9);
            const price = Number(product.price) || 0;
            const priceMulti = Number(product.price_multi) || 0;
            const hasMultiPrice = (priceMulti > 0 && priceMulti < price);
            
            // 圖片處理
            let imgHTML = '';
            if (product.img) {
                const src = product.img.startsWith('http') ? product.img : BASE_REPO_URL + product.img;
                imgHTML = `<div class="w-full aspect-square bg-gray-50 overflow-hidden"><img src="${src}" class="w-full h-full object-cover transition hover:scale-105 duration-500" loading="lazy"></div>`;
            }

            // 價格顯示
            let priceHTML = hasMultiPrice 
                ? `<div class="flex flex-col items-end">
                     <span class="text-xs text-gray-400">單件 $${price}</span>
                     <span class="text-brand font-bold text-lg font-mono">2件起 $${priceMulti}</span>
                   </div>`
                : `<div class="text-right"><span class="text-brand font-bold text-lg font-mono">$${price}</span></div>`;

            // 按鈕與庫存
            const stock = Number(product.stock);
            const isSoldOut = stock <= 0 || (product.status && product.status.includes('完售'));
            const btnClass = isSoldOut ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-brand text-white hover:bg-brandDark active:scale-95 shadow-lg shadow-brand/20';
            const btnText = isSoldOut ? '完售' : '加入購物車';
            
            // ★重點修正：addToCart 參數必須完整★
            const clickEvent = isSoldOut ? '' : `onclick="addToCart('${productId}', '${product.name}', ${price}, ${priceMulti}, ${stock}, '${brandKey}', '${product.spec||''}')"`;

            return `
                <div class="bg-white rounded-2xl border border-gray-100 overflow-hidden shadow-sm flex flex-col hover:shadow-md transition group">
                    ${imgHTML}
                    <div class="p-4 flex flex-col flex-1 gap-3">
                        <h4 class="font-bold text-gray-800 line-clamp-1">${product.name} ${product.spec ? `<span class="text-gray-400 text-xs font-normal ml-1">${product.spec}</span>` : ''}</h4>
                        ${product.note ? `<p class="text-xs text-gray-400 line-clamp-2">${product.note}</p>` : ''}
                        <div class="mt-auto pt-2 flex items-end justify-between border-t border-gray-50">
                             ${priceHTML}
                             <button class="px-4 py-2 rounded-xl text-sm font-bold transition ${btnClass}" ${clickEvent}>${btnText}</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // 3. 購物車邏輯 (修正版)
        function addToCart(productId, name, price, priceMulti, stock, brandKey, spec) {
            const existing = cart.find(item => item.productId === productId);
            if (existing) {
                if (existing.qty < stock) existing.qty++;
                else alert("庫存不足");
            } else {
                cart.push({
                    productId, name, price, priceMulti, stock, brandKey, spec, qty: 1
                });
            }
            updateCartUI();
            openCart();
            if(navigator.vibrate) navigator.vibrate(50);
        }

        function calculateCartTotals() {
            // 1. 統計每個品牌的總數量
            const brandCounts = {};
            cart.forEach(item => {
                if (!brandCounts[item.brandKey]) brandCounts[item.brandKey] = 0;
                brandCounts[item.brandKey] += item.qty;
            });

            // 2. 計算小計
            let subtotal = 0;
            cart.forEach(item => {
                // 新邏輯：只要該品牌總數 > 1，就套用優惠價
                const isDiscount = brandCounts[item.brandKey] > 1 && item.priceMulti > 0;
                const finalPrice = isDiscount ? item.priceMulti : item.price;
                subtotal += finalPrice * item.qty;
                item.appliedPrice = finalPrice; // 暫存實際套用的價格供顯示用
                item.isDiscounted = isDiscount;
            });

            return { subtotal, brandCounts };
        }

        function updateCartUI() {
            const { subtotal, brandCounts } = calculateCartTotals();
            
            // Badge
            const totalQty = cart.reduce((sum, i) => sum + i.qty, 0);
            const badge = document.getElementById('cart-badge');
            badge.innerText = totalQty;
            badge.classList.toggle('hidden', totalQty === 0);

            // Subtotal
            document.querySelectorAll('#bar-total').forEach(el => el.innerText = "NT$ " + subtotal.toLocaleString());
            document.getElementById('modal-total').innerText = (subtotal + shippingFee).toLocaleString();

            updateCartSidebarRender(brandCounts);
        }

        function updateCartSidebarRender(brandCounts) {
            const container = document.getElementById('cart-items-container');
            container.innerHTML = '';

            if (cart.length === 0) {
                container.innerHTML = '<div class="flex flex-col items-center justify-center h-64 text-gray-400"><span class="material-symbols-rounded text-4xl mb-2 opacity-30">shopping_cart</span><p>購物車是空的</p></div>';
                return;
            }

            // 依照品牌分組顯示 (解決：優惠狀態顯眼告知)
            // 先取得所有唯一的 brandKey
            const uniqueBrands = [...new Set(cart.map(i => i.brandKey))];

            uniqueBrands.forEach(bKey => {
                const items = cart.filter(i => i.brandKey === bKey);
                const isDiscountGroup = brandCounts[bKey] > 1; // 該品牌是否符合優惠

                const groupDiv = document.createElement('div');
                groupDiv.className = "cart-brand-group";
                
                // 優惠 Banner (如果符合)
                let bannerHTML = '';
                if (isDiscountGroup) {
                    bannerHTML = `<div class="discount-banner"><span class="material-symbols-rounded text-sm">verified</span> 已套用同品牌多件優惠</div>`;
                }

                groupDiv.innerHTML = `
                    ${bannerHTML}
                    <div class="space-y-4">
                        ${items.map(item => {
                            const unitPrice = item.appliedPrice;
                            const total = unitPrice * item.qty;
                            return `
                                <div class="flex gap-3">
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start">
                                            <h4 class="font-bold text-gray-700 text-sm">${item.name}</h4>
                                            <button onclick="removeFromCart('${item.productId}')" class="text-gray-300 hover:text-red-400"><span class="material-symbols-rounded text-lg">delete</span></button>
                                        </div>
                                        <div class="text-xs text-gray-400 mt-0.5">${item.spec || ''}</div>
                                        <div class="flex justify-between items-end mt-2">
                                            <div class="font-mono text-brand font-bold">
                                                $${unitPrice} 
                                                <span class="text-xs text-gray-400 font-normal">x ${item.qty}</span>
                                            </div>
                                            <div class="flex items-center border border-gray-200 rounded-lg h-7">
                                                <button onclick="changeQty('${item.productId}', -1)" class="w-7 flex items-center justify-center text-gray-500 hover:bg-gray-100">-</button>
                                                <div class="w-8 text-center text-xs font-bold">${item.qty}</div>
                                                <button onclick="changeQty('${item.productId}', 1)" class="w-7 flex items-center justify-center text-gray-500 hover:bg-gray-100">+</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                container.appendChild(groupDiv);
            });
        }

        function changeQty(id, delta) {
            const item = cart.find(i => i.productId === id);
            if (item) {
                const newQty = item.qty + delta;
                if (newQty > 0) {
                    if (newQty <= item.stock) item.qty = newQty;
                    else alert("庫存不足");
                } else {
                    removeFromCart(id);
                    return;
                }
            }
            updateCartUI();
        }

        function removeFromCart(id) {
            if(confirm('確定移除此商品？')) {
                cart = cart.filter(i => i.productId !== id);
                updateCartUI();
            }
        }

        // 4. 面板控制
        function openPanel(id) {
            document.getElementById('overlay').classList.add('open');
            document.getElementById(id).classList.add('open');
        }
        function closeAllPanels() {
            document.getElementById('overlay').classList.remove('open');
            document.querySelectorAll('.side-panel').forEach(el => el.classList.remove('open'));
        }
        function openCart() {
            openPanel('cart-sidebar');
        }

        // 5. 新版結帳流程 logic
        function openCheckout() {
            if (cart.length === 0) return alert("購物車是空的");
            
            // 1. 渲染唯讀清單
            const listEl = document.getElementById('checkout-readonly-list');
            listEl.innerHTML = '';
            // 計算一次確保價格正確
            const { subtotal } = calculateCartTotals(); 
            
            cart.forEach(item => {
                listEl.innerHTML += `
                    <li class="px-4 py-3 text-sm text-brandDark font-medium flex items-start gap-2">
                        <span class="material-symbols-rounded text-brand text-base mt-0.5">check_circle</span>
                        <div class="flex-1">
                            ${item.brandKey}｜${item.name} ${item.spec ? '｜'+item.spec : ''}
                            <div class="text-xs text-gray-500 mt-0.5">
                                $${item.appliedPrice} x ${item.qty} = <span class="font-bold">$${item.appliedPrice * item.qty}</span>
                            </div>
                        </div>
                    </li>
                `;
            });

            // 2. 初始化狀態：隱藏後續區塊，重置欄位
            document.getElementById('checkout-sections-after-phone').classList.add('hidden');
            document.getElementById('input-phone').value = '';
            document.getElementById('phone-msg').innerText = '';
            document.getElementById('btn-submit').disabled = true;
            document.getElementById('footer-logistics-name').innerText = "尚未選擇物流";
            shippingFee = 0;
            updateCartUI(); // 重算總價 (含歸零運費)

            closeAllPanels();
            openPanel('checkout-panel');
        }

        // 查詢會員
        function lookupPhoneData(btn) {
            const phoneInput = document.getElementById('input-phone');
            const phone = phoneInput.value.trim();
            const msgEl = document.getElementById('phone-msg');
            
            // 驗證格式
            if (!/^09\d{8}$/.test(phone)) {
                msgEl.innerText = "格式錯誤，請輸入 09 開頭共 10 碼";
                msgEl.className = "text-xs mt-2 pl-1 h-4 font-medium text-red-500";
                return;
            }

            // 顯示遮罩 Loading
            const overlay = document.getElementById('checkout-loading-overlay');
            overlay.classList.add('active');

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "login", phone: phone })
            })
            .then(res => res.json())
            .then(res => {
                // 無論是否為新會員，都展開後續區塊
                document.getElementById('checkout-sections-after-phone').classList.remove('hidden');
                document.getElementById('btn-submit').disabled = false; // 允許送出(需再選物流)

                if (res.success && !res.isNew) {
                    const data = res.data;
                    msgEl.innerText = `歡迎回來，${data.name}`;
                    msgEl.className = "text-xs mt-2 pl-1 h-4 font-medium text-brand";
                    
                    // 帶入資料
                    document.getElementById('input-name').value = data.name || '';
                    document.getElementById('input-email').value = data.email || '';
                    
                    // 帶入物流偏好 (如果有)
                    if (data.store_711) {
                        // 這裡可以做更細緻的預選，目前先不強制，讓用戶自己點選以觸發事件
                    }
                } else {
                    msgEl.innerText = "新朋友您好，請繼續填寫資料";
                    msgEl.className = "text-xs mt-2 pl-1 h-4 font-medium text-gray-500";
                }
            })
            .catch(err => {
                alert("連線錯誤");
            })
            .finally(() => {
                setTimeout(() => {
                    overlay.classList.remove('active');
                }, 500); // 稍微延遲讓動畫跑完
            });
        }

        // 物流選擇 UI 控制
        function selectLogistics(type, cardEl) {
            // 1. UI 狀態切換
            document.querySelectorAll('.logistics-card').forEach(el => {
                el.classList.remove('active');
                el.querySelector('.logistics-detail').classList.add('hidden');
            });
            cardEl.classList.add('active');
            cardEl.querySelector('.logistics-detail').classList.remove('hidden');

            // 2. 更新 select 與變數
            const select = document.getElementById('input-logistics');
            select.value = type;
            
            // 3. 計算運費
            const { subtotal } = calculateCartTotals();
            // 簡單查找規則 (根據您的 GAS 結構)
            const rule = shippingRules.find(r => r.category === '抹茶' && type.includes(r.method));
            let fee = 60;
            if (type.includes('宅配')) fee = 100;
            
            // 套用門檻
            if (rule) {
                fee = Number(rule.base);
                if (rule.t3 && subtotal >= rule.t3) fee = Number(rule.f3);
                else if (rule.t2 && subtotal >= rule.t2) fee = Number(rule.f2);
                else if (rule.t1 && subtotal >= rule.t1) fee = Number(rule.f1);
            }
            shippingFee = fee;

            // 4. 更新 Footer 顯示
            document.getElementById('footer-logistics-name').innerText = `已選擇：${type} (運費 $${fee})`;
            updateCartUI(); // 更新總金額
            
            // 5. 觸發 input sync 確保 hidden value 正確
            syncStoreInput();
        }

        // 同步店鋪資料到 hidden input
        function syncStoreInput() {
            const type = document.getElementById('input-logistics').value;
            let storeVal = "";
            let noteVal = "";

            if (type === '7-11') {
                const id = document.getElementById('store-id-711').value;
                // const name = document.getElementById('store-name-711').value; // 改為分開存
                storeVal = id;
                noteVal = document.getElementById('store-name-711').value;
            } else if (type === '全家') {
                const id = document.getElementById('store-id-fami').value;
                storeVal = id;
                noteVal = document.getElementById('store-name-fami').value;
            } else {
                storeVal = document.getElementById('store-addr').value;
            }

            document.getElementById('input-store').value = storeVal;
            document.getElementById('input-store-note').value = noteVal;
        }

        function submitOrder(btn) {
            // 驗證
            const phone = document.getElementById('input-phone').value;
            const name = document.getElementById('input-name').value;
            const type = document.getElementById('input-logistics').value;
            const store = document.getElementById('input-store').value;

            if (!phone || !name) return alert("請填寫完整聯絡資訊");
            if (!store) return alert("請填寫取貨店號或地址");

            btn.disabled = true;
            btn.innerHTML = '<span class="loader h-5 w-5 border-2 border-white rounded-full"></span>';

            const { subtotal } = calculateCartTotals();
            
            // 組合商品字串
            const itemsStr = cart.map(item => {
                return `${item.brandKey}｜${item.name}${item.spec ? '｜'+item.spec : ''} x${item.qty} ($${item.appliedPrice})`;
            }).join('\n');

            const payload = {
                action: "checkout",
                phone, name, 
                email: document.getElementById('input-email').value,
                line_name: document.getElementById('input-line').value,
                logistics: type,
                store: store, // 純店號或地址
                store_note: document.getElementById('input-store-note').value, // 店名
                items: itemsStr,
                subtotal, shipping: shippingFee,
                date: new Date().toISOString(),
                product_note: document.getElementById('input-note').value,
                join_member: document.getElementById('join-member').checked
            };

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    alert(`訂單建立成功！\n編號：${data.orderId}`);
                    cart = [];
                    updateCartUI();
                    closeAllPanels();
                } else {
                    alert("失敗：" + data.msg);
                }
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-rounded">verified</span> 確認送出訂單';
            });
        }
    </script>
</body>
</html>
