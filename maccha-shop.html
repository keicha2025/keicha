<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEICHA 抹茶代購 - 線上下單</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brandGreen: '#1a4d2e',
                        brandLight: '#e8f5e9',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #f9f9f7; }
        
        /* Loading */
        .loader { border-top-color: #1a4d2e; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 底部浮動購物列 */
        .sticky-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(255, 255, 255, 0.98);
            border-top: 1px solid #e5e7eb;
            padding: 1rem;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 40;
        }
        .pb-safe { padding-bottom: 120px; }

        /* Modal 樣式 */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 50;
            display: none; justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: white; width: 95%; max-width: 600px; max-height: 90vh;
            border-radius: 8px; overflow-y: auto; padding: 1.5rem;
            position: relative; animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="pb-safe">

    <div id="structured-data-container"></div>

    <header class="bg-white shadow-sm py-6 mb-8 border-b border-gray-100 sticky top-0 z-30">
        <div class="max-w-6xl mx-auto px-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 tracking-wide">KEICHA</h1>
                <p class="text-xs text-gray-500">日本直送 • 新鮮代購</p>
            </div>
            <button onclick="openCheckout()" class="relative p-2 text-brandGreen hover:bg-gray-100 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <span id="cart-badge" class="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
            </button>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4">
        <div class="mb-8">
            <h2 class="text-lg font-bold mb-4 text-gray-700 border-l-4 border-brandGreen pl-3 flex items-center">
                目前代購狀態
                <span id="status-loader" class="ml-3 loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-4 w-4"></span>
            </h2>
            <div id="status-grid-container" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
        </div>

        <div id="product-list-container" class="space-y-12"></div>
    </main>

    <div class="sticky-bar">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div>
                <div class="text-gray-500 text-xs">預估總金額 (不含運)</div>
                <div class="text-2xl font-bold text-brandGreen">
                    NT$ <span id="bar-total">0</span>
                </div>
            </div>
            <button onclick="openCheckout()" class="bg-brandGreen text-white px-8 py-3 rounded-lg hover:bg-green-800 font-bold shadow-lg transition-transform transform active:scale-95 flex items-center gap-2">
                <span>前往結帳</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
    </div>

    <div id="checkout-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800">確認訂單</h3>
                <button onclick="closeCheckout()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg mb-6 max-h-40 overflow-y-auto">
                <h4 class="text-sm font-bold text-gray-500 mb-2">購買清單</h4>
                <ul id="checkout-cart-list" class="text-sm space-y-2 text-gray-700">
                    </ul>
            </div>

            <form id="order-form" onsubmit="submitOrder(event)">
                <div class="mb-6 p-4 border border-brandGreen rounded-lg bg-brandLight bg-opacity-30">
                    <label class="block text-sm font-bold text-brandGreen mb-1">會員快速帶入</label>
                    <div class="flex gap-2">
                        <input type="tel" id="member-phone-search" class="flex-1 border rounded px-3 py-2 text-sm" placeholder="輸入手機號碼">
                        <button type="button" onclick="checkMember()" class="bg-brandGreen text-white px-4 py-2 rounded text-sm hover:bg-green-800">查詢</button>
                    </div>
                    <p id="member-msg" class="text-xs mt-1 text-gray-500"></p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">取件人姓名 <span class="text-red-500">*</span></label>
                        <input type="text" name="name" id="input-name" required class="w-full border rounded px-3 py-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">手機號碼 <span class="text-red-500">*</span></label>
                        <input type="tel" name="phone" id="input-phone" required class="w-full border rounded px-3 py-2 text-sm">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-600 mb-1">Email (接收訂單通知) <span class="text-red-500">*</span></label>
                    <input type="email" name="email" id="input-email" required class="w-full border rounded px-3 py-2 text-sm">
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-600 mb-1">LINE ID / 暱稱 (方便聯絡)</label>
                    <input type="text" name="line_name" id="input-line" class="w-full border rounded px-3 py-2 text-sm">
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-600 mb-1">物流方式 <span class="text-red-500">*</span></label>
                    <select name="logistics" id="input-logistics" onchange="updateShippingFee()" class="w-full border rounded px-3 py-2 text-sm bg-white">
                        <option value="7-11">7-11 店到店</option>
                        <option value="全家">全家 店到店</option>
                        <option value="郵寄/宅配">郵寄/宅配</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-600 mb-1">取件店號/店名/地址 <span class="text-red-500">*</span></label>
                    <input type="text" name="store" id="input-store" required placeholder="例：123456 統一門市" class="w-full border rounded px-3 py-2 text-sm">
                    <p class="text-xs text-gray-400 mt-1">若選擇宅配請填寫完整地址</p>
                </div>
                
                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-600 mb-1">備註 (可留空)</label>
                    <textarea name="note" id="input-note" rows="2" class="w-full border rounded px-3 py-2 text-sm"></textarea>
                </div>

                <div class="border-t pt-4 mb-6">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600">商品小計</span>
                        <span>NT$ <span id="modal-subtotal">0</span></span>
                    </div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600">運費</span>
                        <span>NT$ <span id="modal-shipping">計算中...</span></span>
                    </div>
                    <div class="flex justify-between text-xl font-bold mt-2 text-brandGreen">
                        <span>總金額</span>
                        <span>NT$ <span id="modal-total">0</span></span>
                    </div>
                </div>

                <div class="mb-6 flex items-center">
                    <input type="checkbox" id="join-member" name="join_member" class="w-4 h-4 text-brandGreen border-gray-300 rounded focus:ring-brandGreen" checked>
                    <label for="join-member" class="ml-2 text-sm text-gray-700">同時加入/更新會員資料 (方便下次訂購)</label>
                </div>

                <button type="submit" id="btn-submit" class="w-full bg-brandGreen text-white py-3 rounded-lg font-bold hover:bg-green-800 transition-colors flex justify-center items-center">
                    送出訂單
                </button>
            </form>
        </div>
    </div>

    <script>
        // ------------------------------------------------
        // 1. 設定區 (Config)
        // ------------------------------------------------
        const DISPLAY_API_URL = "https://script.google.com/macros/s/您的DISPLAY_GAS_ID/exec"; 
        const ORDER_API_URL = "https://script.google.com/macros/s/AKfycbyUq36i64Z-JGcERE_rZOdphVtVDX8L-lguc7eiUIdoAERqI1ZK8GWAL-HgbC75cuMHFg/exec"; 
        const BASE_REPO_URL = "assets/images/"; 

        // ------------------------------------------------
        // 2. 全域變數
        // ------------------------------------------------
        let cart = []; 
        let shippingFee = 0; 
        let shippingRules = []; // 存放從後端抓來的規則

        // ------------------------------------------------
        // 3. 購物車邏輯
        // ------------------------------------------------
        function addToCart(brandKey, name, price, priceMulti, stock, maxLimit) {
            const existingItem = cart.find(item => item.name === name && item.brand_key === brandKey);
            let currentQty = existingItem ? existingItem.qty : 0;

            if (currentQty >= stock) {
                alert("抱歉，庫存不足！");
                return;
            }
            if (currentQty >= maxLimit) {
                alert(`此商品每人限購 ${maxLimit} 件`);
                return;
            }

            if (existingItem) {
                existingItem.qty++;
            } else {
                cart.push({
                    brand_key: brandKey,
                    name: name,
                    price: price,
                    price_multi: priceMulti,
                    qty: 1
                });
            }
            
            updateCartUI();
            if (navigator.vibrate) navigator.vibrate(50);
        }

        function calculateSubtotal() {
            const brandCounts = {};
            cart.forEach(item => {
                brandCounts[item.brand_key] = (brandCounts[item.brand_key] || 0) + item.qty;
            });

            let subtotal = 0;
            cart.forEach(item => {
                const brandTotalQty = brandCounts[item.brand_key] || 0;
                const unitPrice = brandTotalQty >= 2 ? item.price_multi : item.price;
                subtotal += unitPrice * item.qty;
            });
            return subtotal;
        }

        function updateCartUI() {
            const subtotal = calculateSubtotal();
            const badge = document.getElementById('cart-badge');
            
            // 更新底部與 Navbar 數字
            document.getElementById('bar-total').innerText = subtotal.toLocaleString();
            
            const totalQty = cart.reduce((acc, item) => acc + item.qty, 0);
            if(badge) {
                badge.innerText = totalQty;
                badge.classList.toggle('hidden', totalQty === 0);
            }
        }

        // ------------------------------------------------
        // 4. 結帳與會員邏輯 (整合後端)
        // ------------------------------------------------
        
        function openCheckout() {
            if (cart.length === 0) {
                alert("購物車是空的喔！");
                return;
            }
            
            // 渲染購物車明細
            const listEl = document.getElementById('checkout-cart-list');
            listEl.innerHTML = '';
            
            const brandCounts = {};
            cart.forEach(item => brandCounts[item.brand_key] = (brandCounts[item.brand_key] || 0) + item.qty);

            cart.forEach(item => {
                const brandTotalQty = brandCounts[item.brand_key] || 0;
                const unitPrice = brandTotalQty >= 2 ? item.price_multi : item.price;
                const sub = unitPrice * item.qty;
                
                const li = document.createElement('li');
                li.className = "flex justify-between border-b border-gray-100 pb-1";
                li.innerHTML = `
                    <span>${item.name} x ${item.qty}</span>
                    <span class="font-bold text-gray-600">$${sub}</span>
                `;
                listEl.appendChild(li);
            });

            // 打開時，確保運費是根據當前小計與物流方式計算的
            updateShippingFee();
            document.getElementById('checkout-modal').classList.add('active');
        }

        function closeCheckout() {
            document.getElementById('checkout-modal').classList.remove('active');
        }

        /**
         * ★ 運費計算核心 (讀取後端規則)
         * 1. 抓取目前選擇的物流 (7-11, 全家, 宅配)
         * 2. 在 shippingRules 裡找對應的規則 (且 category 為 '抹茶')
         * 3. 檢查小計是否達到減免門檻 (t1, t2...)
         */
        function updateShippingFee() {
            const subtotal = calculateSubtotal();
            const selectedLogistics = document.getElementById('input-logistics').value; // e.g., "7-11"
            
            // 1. 找到對應的規則 (category = "抹茶")
            // 模糊比對物流名稱，例如 "7-11" 能對應到規則裡的 "7-11"
            const rule = shippingRules.find(r => 
                r.category === '抹茶' && selectedLogistics.includes(r.method)
            );

            // 預設運費 (若後端沒設，給個安全值)
            let finalFee = 60; 
            if (selectedLogistics.includes("宅配")) finalFee = 100;

            if (rule) {
                finalFee = Number(rule.base); // 基礎運費

                // 檢查門檻 (假設 t1 是免運門檻，若 subtotal >= t1，則運費變成 f1)
                // 這裡支援多級距: t1, t2, t3
                if (rule.t3 && subtotal >= rule.t3) {
                    finalFee = Number(rule.f3);
                } else if (rule.t2 && subtotal >= rule.t2) {
                    finalFee = Number(rule.f2);
                } else if (rule.t1 && subtotal >= rule.t1) {
                    finalFee = Number(rule.f1);
                }
            }

            shippingFee = finalFee;
            updateModalTotals();
        }

        function updateModalTotals() {
            const subtotal = calculateSubtotal();
            document.getElementById('modal-subtotal').innerText = subtotal.toLocaleString();
            document.getElementById('modal-shipping').innerText = shippingFee;
            document.getElementById('modal-total').innerText = (subtotal + shippingFee).toLocaleString();
        }

        // --- 會員查詢 ---
        function checkMember() {
            const phone = document.getElementById('member-phone-search').value.trim();
            const msgEl = document.getElementById('member-msg');
            
            if (!phone) {
                alert("請輸入電話號碼");
                return;
            }

            msgEl.innerText = "查詢中...";
            msgEl.className = "text-xs mt-1 text-blue-500";

            fetch(ORDER_API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "login", phone: phone })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const info = data.data;
                    document.getElementById('input-phone').value = info.phone; 
                    
                    if (info.name) {
                        msgEl.innerText = `歡迎回來，${info.name}！資料已帶入。`;
                        msgEl.className = "text-xs mt-1 text-green-600";
                        document.getElementById('input-name').value = info.name;
                        document.getElementById('input-email').value = info.email;
                        
                        const typeSelect = document.getElementById('input-logistics');
                        if (info.store_711) {
                            typeSelect.value = "7-11";
                            document.getElementById('input-store').value = info.store_711;
                        } else if (info.store_fami) {
                            typeSelect.value = "全家";
                            document.getElementById('input-store').value = info.store_fami;
                        } else if (info.shipping_address) {
                            typeSelect.value = "郵寄/宅配";
                            document.getElementById('input-store').value = info.shipping_address;
                        }
                        updateShippingFee(); 
                    } else {
                        msgEl.innerText = "是新朋友呢！請填寫資料，下單後自動成為會員。";
                        msgEl.className = "text-xs mt-1 text-orange-500";
                        document.getElementById('input-phone').value = phone; 
                    }
                } else {
                    msgEl.innerText = "查詢失敗，請稍後再試。";
                    msgEl.className = "text-xs mt-1 text-red-500";
                }
            })
            .catch(err => {
                console.error(err);
                msgEl.innerText = "系統連線錯誤";
            });
        }

        // --- 送出訂單 ---
        function submitOrder(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            btn.innerText = "處理中...";

            const subtotal = calculateSubtotal();
            
            const brandCounts = {};
            cart.forEach(item => brandCounts[item.brand_key] = (brandCounts[item.brand_key] || 0) + item.qty);
            
            const itemsStr = cart.map(item => {
                const brandTotalQty = brandCounts[item.brand_key] || 0;
                const finalPrice = brandTotalQty >= 2 ? item.price_multi : item.price;
                return `${item.name} x${item.qty} ($${finalPrice})`;
            }).join('\n');

            const payload = {
                action: "checkout",
                name: document.getElementById('input-name').value,
                phone: document.getElementById('input-phone').value,
                email: document.getElementById('input-email').value,
                line_name: document.getElementById('input-line').value,
                logistics: document.getElementById('input-logistics').value,
                store: document.getElementById('input-store').value,
                product_note: document.getElementById('input-note').value,
                join_member: document.getElementById('join-member').checked,
                items: itemsStr,
                subtotal: subtotal,
                shipping: shippingFee,
                temp: "常溫", 
                date: new Date().toISOString()
            };

            fetch(ORDER_API_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert(`訂單建立成功！\n訂單編號: ${data.orderId}\n請至 Email 收信確認。`);
                    cart = []; 
                    updateCartUI();
                    closeCheckout();
                } else {
                    alert("訂單建立失敗: " + data.msg);
                }
            })
            .catch(err => {
                console.error(err);
                alert("網路錯誤，請檢查連線");
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerText = "送出訂單";
            });
        }

        // ------------------------------------------------
        // 5. 頁面初始化 (抓取 Display API + System Config)
        // ------------------------------------------------
        window.addEventListener('load', () => {
            const statusLoader = document.getElementById('status-loader');

            // --- 抓取系統設定 (運費規則) ---
            fetch(ORDER_API_URL) // 直接 GET 抓取 getSystemData
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.shipping_rules) {
                        console.log("運費規則已更新:", data.shipping_rules);
                        shippingRules = data.shipping_rules;
                    }
                })
                .catch(err => console.error("無法讀取運費規則:", err));

            // --- 渲染函式 (與之前相同) ---
            function renderStatusOverview(brands) {
                const container = document.getElementById('status-grid-container');
                if (statusLoader) statusLoader.style.display = 'none';
                if (!container) return;
                container.innerHTML = '';
                brands.forEach(brand => {
                    const rawStatus = (brand.status || '').toLowerCase().trim();
                    let statusText = brand.status || '未定';
                    let statusColor = 'bg-gray-200 text-gray-600';
                    if (['available', 'open', '开团', '開團', '接收訂單中', '收單中'].includes(rawStatus)) {
                        statusText = '可訂購';
                        statusColor = 'bg-brandGreen text-white';
                    } else if (['out-of-stock', 'sold out', 'close', '關閉', '缺貨', '已結單'].includes(rawStatus)) {
                        statusText = '缺貨中';
                        statusColor = 'bg-gray-200 text-gray-600';
                    }
                    container.innerHTML += `
                        <a href="#brand-${brand.key}" class="block group transform hover:-translate-y-1 transition-transform duration-300">
                            <div class="bg-white rounded shadow-sm p-3 border border-gray-100 flex justify-between items-center">
                                <span class="font-bold text-gray-800 text-sm truncate mr-1">${brand.name}</span>
                                <span class="${statusColor} text-xs px-2 py-0.5 rounded-full">${statusText}</span>
                            </div>
                        </a>`;
                });
            }

            function renderProductSections(brands) {
                const container = document.getElementById('product-list-container');
                if (!container) return;
                container.innerHTML = '';
                brands.forEach(brand => {
                    container.innerHTML += `
                        <section id="brand-${brand.key}" class="scroll-mt-24">
                            <h2 class="text-xl md:text-2xl font-bold mb-6 flex items-center text-gray-800 border-b pb-2">
                                ${brand.name}
                            </h2>
                            <div id="${brand.key}-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                        </section>`;
                });
            }

            function renderProductCards(brandKey, products) {
                const grid = document.getElementById(`${brandKey}-grid`);
                if (!grid) return;
                const visibleProducts = products.filter(p => !p.hidden);
                if (visibleProducts.length === 0) {
                    grid.innerHTML = `<p class="text-gray-400 text-center col-span-full">尚無品項</p>`;
                    return;
                }
                visibleProducts.forEach(product => {
                    const name = product.name || '未命名';
                    const price = Number(product.price) || 0;
                    const priceMulti = Number(product.price_multi) || 0;
                    const status = product.status || '';
                    const note = product.note || '';
                    // 強制轉字串避免報錯
                    const imgPath = String(product.img || '');
                    
                    const isSoldOut = product.stock <= 0 || status === '完售';
                    
                    let imgHTML = imgPath ? `<img src="${imgPath.startsWith('http') ? imgPath : BASE_REPO_URL + imgPath}" class="absolute top-0 left-0 w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" loading="lazy">` : `<div class="w-full h-full flex items-center justify-center bg-gray-100 text-gray-400">No Image</div>`;
                    
                    // Note Badge
                    let badgeHTML = '';
                    if (!isSoldOut && note) {
                        badgeHTML = `<span class="absolute top-2 right-2 bg-brandGreen text-white text-xs px-2 py-1 rounded shadow z-10">${note}</span>`;
                    } else if (isSoldOut) {
                        badgeHTML = `<span class="absolute top-2 right-2 bg-gray-500 text-white text-xs px-2 py-1 rounded z-10">缺貨</span>`;
                    }

                    let priceHTML = (priceMulti > 0 && priceMulti < price) 
                        ? `<div class="flex flex-col items-end"><span class="text-xs text-gray-400 line-through">$${price}</span><span class="text-brandGreen font-bold">$${priceMulti}</span></div>` 
                        : `<div class="text-gray-800 font-bold">$${price}</div>`;

                    const btnClass = isSoldOut ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-brandGreen hover:bg-green-800 text-white shadow-md';
                    const clickEvent = isSoldOut ? '' : `onclick="addToCart('${product.brand_key}', '${name}', ${price}, ${priceMulti}, ${product.stock}, ${product.max_limit})"`;

                    grid.innerHTML += `
                        <div class="bg-white shadow-sm rounded-lg overflow-hidden border border-gray-100 group flex flex-col relative">
                            ${badgeHTML}
                            <div class="w-full pt-[100%] relative bg-gray-50 border-b border-gray-100">${imgHTML}</div>
                            <div class="p-4 flex-grow flex flex-col justify-between">
                                <div>
                                    <h3 class="font-bold text-gray-800 leading-tight mb-1">${name}</h3>
                                    ${product.spec ? `<p class="text-xs text-gray-500 mb-2">${product.spec}</p>` : ''}
                                </div>
                                <div class="mt-2 flex items-center justify-between">
                                    ${priceHTML}
                                    <button class="px-3 py-1.5 rounded text-sm ${btnClass}" ${clickEvent}>${isSoldOut ? '完售' : '加入 +1'}</button>
                                </div>
                            </div>
                        </div>`;
                });
            }

            // 初始化抓取 Display API
            fetch(DISPLAY_API_URL)
                .then(res => res.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    renderStatusOverview(data.brands);
                    renderProductSections(data.brands);
                    data.brands.forEach(brand => {
                        renderProductCards(brand.key, data.products.filter(p => p.brand_key === brand.key));
                    });
                })
                .catch(err => {
                    console.error(err);
                    if(document.getElementById('status-grid-container')) 
                        document.getElementById('status-grid-container').innerHTML = `<p class="text-red-500">載入失敗</p>`;
                });
        });
    </script>
</body>
</html>
