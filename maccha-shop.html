<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEICHA 抹茶代購選品</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自定義樣式區 */
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #f9f9f7; }
        
        /* Loading 遮罩 */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #1a4d2e; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 商品卡片優化 */
        .product-card {
            background: white; border-radius: 8px; overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s;
            display: flex; flex-direction: column;
        }
        .product-img-box {
            width: 100%; padding-top: 100%; /* 1:1 正方形 */
            position: relative; background: #eee;
        }
        .product-img-box img {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;
        }
        .product-info { padding: 1rem; flex-grow: 1; display: flex; flex-direction: column; }
        .product-info h3 { font-size: 1.1rem; font-weight: bold; color: #333; margin-bottom: 0.25rem; }
        .product-spec { font-size: 0.85rem; color: #888; margin-bottom: 0.5rem; }
        
        /* 價格樣式 */
        .price-group { margin-top: auto; margin-bottom: 1rem; }
        .price-single { display: block; color: #555; text-decoration: line-through; font-size: 0.8rem; }
        .price-multi { display: block; color: #d32f2f; font-weight: bold; font-size: 1.1rem; }
        .price-normal { color: #333; font-weight: bold; font-size: 1.1rem; }
        
        /* 按鈕樣式 */
        .btn-add {
            background-color: #1a4d2e; color: white; padding: 0.5rem; text-align: center;
            border-radius: 4px; cursor: pointer; transition: background 0.2s; width: 100%;
        }
        .btn-add:hover { background-color: #143b23; }
        .btn-disabled {
            background-color: #ccc; color: #666; padding: 0.5rem; text-align: center;
            border-radius: 4px; cursor: not-allowed; width: 100%;
        }

        /* 狀態小卡 */
        .status-card {
            padding: 1rem; border-radius: 8px; text-align: center; font-weight: bold;
        }
        .status-active { background-color: #e8f5e9; color: #1b5e20; border: 1px solid #c8e6c9; }
        .status-closed { background-color: #ffebee; color: #b71c1c; border: 1px solid #ffcdd2; }

        /* 底部浮動區 */
        .sticky-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; border-top: 1px solid #ddd; padding: 1rem;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100;
        }
    </style>
</head>
<body class="pb-32">

    <div id="loading-overlay">
        <div class="spinner"></div>
        <p class="mt-4 text-gray-600">正在從後台讀取商品資料...</p>
    </div>

    <header class="bg-white shadow-sm py-6 mb-6">
        <div class="max-w-4xl mx-auto px-4 text-center">
            <h1 class="text-3xl font-bold text-gray-800 tracking-wide">KEICHA 抹茶代購</h1>
            <p class="text-gray-500 mt-2">日本直送 • 新鮮代購</p>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4">
        
        <div class="mb-8">
            <h2 class="text-xl font-bold mb-4 text-gray-700 border-l-4 border-green-700 pl-3">目前代購狀態</h2>
            <div id="status-grid-container" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                </div>
        </div>

        <div id="product-list-container" class="space-y-12">
            </div>

    </main>

    <div class="sticky-bar">
        <div class="max-w-4xl mx-auto flex flex-col gap-3">
            <div class="flex items-center justify-between">
                <span class="font-bold text-gray-700">預估總金額：</span>
                <div class="text-2xl font-bold text-red-600">
                    NT$ <input type="text" id="gen-price-input" value="0" readonly class="w-24 text-right bg-transparent border-none focus:ring-0">
                </div>
            </div>
            
            <div class="flex gap-2">
                <input type="text" id="gen-name-input" 
                       class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm bg-gray-50 text-gray-600"
                       placeholder="選擇商品後，這裡會自動產生賣貨便品名..." readonly>
                <button onclick="copyToClipboard()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm whitespace-nowrap">
                    複製
                </button>
            </div>
            <p class="text-xs text-gray-400 text-center">
                * 若有同品牌多件優惠，金額會自動計算，請複製總金額填入賣貨便。
            </p>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. 設定區 (請修改這裡!)
        // ==========================================
        
        // ⚠️ 請填入您的 GAS 部署網址
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxnxbcdCdxH2Qmuek5Up8BqTWeOLUcLR30jfUi0lMbMn5ocn9tY1f_c7yEyd9KSZ4Um/exec"; 
        
        // 圖片路徑前綴 (若您用 GitHub 請保持，若用外部圖床請留空 "")
        const BASE_REPO_URL = "assets/images/"; 

        // ==========================================
        // 2. 系統變數
        // ==========================================
        let productsData = []; // 原始資料
        let cart = [];         // 購物車

        // ==========================================
        // 3. 初始化 (進入點)
        // ==========================================
        document.addEventListener('DOMContentLoaded', initShop);

        async function initShop() {
            const loadingOverlay = document.getElementById('loading-overlay');
            console.log("系統啟動：開始抓取資料...");

            try {
                // 抓取 GAS 資料
                const response = await fetch(GAS_API_URL);
                const data = await response.json();

                console.log("資料回傳成功:", data);

                // 錯誤檢查
                if (!data || data.error) {
                    throw new Error(data.error || "API 回傳格式錯誤");
                }
                
                if (!data.brands || !data.products) {
                    throw new Error("資料缺少 brands 或 products 欄位");
                }

                // 渲染畫面
                renderStatusGrid(data.brands);
                renderProductSections(data.brands, data.products);
                
                // 存入全域變數
                productsData = data.products;

            } catch (error) {
                console.error("初始化失敗:", error);
                alert("讀取資料失敗：" + error.message + "\n請檢查 GAS 網址或稍後再試。");
            } finally {
                // 無論成功失敗，都強制關閉 Loading
                if(loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
            }
        }

        // ==========================================
        // 4. 渲染邏輯
        // ==========================================
        function renderStatusGrid(brands) {
            const container = document.getElementById('status-grid-container');
            if(!container) return;

            container.innerHTML = brands.map(brand => {
                const isActive = brand.status === '收單中';
                return `
                    <div class="status-card ${isActive ? 'status-active' : 'status-closed'}">
                        <div class="text-sm">${brand.name}</div>
                        <div class="text-xs mt-1">${brand.status}</div>
                    </div>
                `;
            }).join('');
        }

        function renderProductSections(brands, products) {
            const container = document.getElementById('product-list-container');
            if(!container) return;
            container.innerHTML = '';

            brands.forEach(brand => {
                // 過濾該品牌的商品
                const brandProducts = products.filter(p => p.brand_key === brand.key);
                if (brandProducts.length === 0) return;

                // 建立卡片 HTML
                const cardsHtml = brandProducts.map(product => createProductCard(product)).join('');

                // 建立區塊
                const sectionHtml = `
                    <section id="brand-${brand.key}">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                            <span class="bg-green-700 w-2 h-8 mr-3 inline-block"></span>
                            ${brand.name}
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            ${cardsHtml}
                        </div>
                    </section>
                `;
                container.innerHTML += sectionHtml;
            });
        }

        function createProductCard(product) {
            // 圖片處理
            let imgHtml = '';
            if (product.img) {
                // 若 img 是 http 開頭直接用，否則接上 Base URL
                const imgSrc = product.img.startsWith('http') ? product.img : BASE_REPO_URL + product.img;
                imgHtml = `<div class="product-img-box"><img src="${imgSrc}" alt="${product.name}" loading="lazy"></div>`;
            } else {
                // 無圖預設
                imgHtml = `<div class="product-img-box flex items-center justify-center bg-gray-100 text-gray-400">尚無圖片</div>`;
            }

            // 價格顯示邏輯
            let priceHtml = '';
            // 如果 原價 == 多件價，只顯示單一價格
            if (product.price === product.price_multi) {
                priceHtml = `<div class="price-normal">NT$ ${product.price}</div>`;
            } else {
                priceHtml = `
                    <div class="price-group">
                        <span class="price-single">單件 $${product.price}</span>
                        <span class="price-multi">兩件以上 $${product.price_multi}</span>
                    </div>`;
            }

            // 按鈕狀態
            const isSoldOut = product.stock <= 0 || product.status === '完售';
            const btnClass = isSoldOut ? 'btn-disabled' : 'btn-add';
            const btnText = isSoldOut ? '完售' : '加入清單 +1';
            // 注意：onclick 傳遞字串參數要加引號
            const clickEvent = isSoldOut ? '' : `onclick="addToCart('${product.brand_key}', '${product.name}', ${product.price}, ${product.price_multi}, ${product.stock}, ${product.max_limit})"`;

            // 規格與備註
            const specHtml = product.spec ? `<div class="product-spec">${product.spec}</div>` : '';
            const noteHtml = product.note ? `<div class="text-xs text-orange-600 mt-1">${product.note}</div>` : '';

            return `
                <div class="product-card">
                    ${imgHtml}
                    <div class="product-info">
                        <h3>${product.name}</h3>
                        ${specHtml}
                        <div class="flex-grow"></div> ${noteHtml}
                        <div class="mt-2 flex items-end justify-between">
                            ${priceHtml}
                        </div>
                        <div class="mt-3">
                            <button class="${btnClass}" ${clickEvent}>${btnText}</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // 5. 購物車邏輯 (含同品牌優惠)
        // ==========================================
        
        function addToCart(brandKey, name, price, priceMulti, stock, maxLimit) {
            const existingItem = cart.find(item => item.name === name && item.brand_key === brandKey);
            let currentQty = existingItem ? existingItem.qty : 0;

            // 檢查庫存與限購
            if (currentQty >= stock) {
                alert("庫存不足！");
                return;
            }
            if (currentQty >= maxLimit) {
                alert(`此商品每人限購 ${maxLimit} 件`);
                return;
            }

            // 加入購物車
            if (existingItem) {
                existingItem.qty++;
            } else {
                cart.push({
                    brand_key: brandKey,
                    name: name,
                    price: price,
                    price_multi: priceMulti,
                    qty: 1
                });
            }
            
            updateCartUI();
        }

        function calculateTotal() {
            // 1. 統計各品牌總件數
            const brandCounts = {};
            cart.forEach(item => {
                brandCounts[item.brand_key] = (brandCounts[item.brand_key] || 0) + item.qty;
            });

            // 2. 計算金額
            let total = 0;
            cart.forEach(item => {
                const brandTotalQty = brandCounts[item.brand_key] || 0;
                // 若該品牌滿 2 件，全用 price_multi 計價
                const unitPrice = brandTotalQty >= 2 ? item.price_multi : item.price;
                total += unitPrice * item.qty;
            });

            return total;
        }

        function updateCartUI() {
            // 計算總額
            const total = calculateTotal();
            document.getElementById('gen-price-input').value = total;

            // 生成字串
            const strList = cart.map(item => `${item.name} x ${item.qty}`).join(', ');
            document.getElementById('gen-name-input').value = strList;
        }

        // 複製功能
        function copyToClipboard() {
            const nameInput = document.getElementById('gen-name-input');
            const priceInput = document.getElementById('gen-price-input');
            
            if (!nameInput.value) {
                alert("購物車是空的喔！");
                return;
            }
            
            // 這裡簡單實作複製「品名字串」
            nameInput.select();
            document.execCommand('copy');
            alert(`已複製代購清單！\n\n品名：${nameInput.value}\n總金額：${priceInput.value}\n\n請前往賣貨便貼上。`);
        }

    </script>
</body>
</html>
