<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEICHA 抹茶代購下單區</title>
    <link rel="icon" href="data:,">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brandGreen: '#6ea44c',
                        brandLight: '#e8f5e9',
                    },
                    fontFamily: {
                        sans: ['var(--font-body)', 'sans-serif'],
                        brand: ['var(--font-brand)', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --font-brand: "Zen Maru Gothic", sans-serif;
            --font-body: "Noto Sans TC", sans-serif;
            --brand-green: #6ea44c;
        }

        body { 
            font-family: var(--font-body); 
            background-color: #ffffff; 
            overflow-x: hidden; 
        }
        
        .font-brand-text {
            font-family: var(--font-brand);
            font-weight: 700;
        }

        /* 品牌色輔助類 */
        .text-brand { color: var(--brand-green); }
        .bg-brand { background-color: var(--brand-green); }
        .border-brand { border-color: var(--brand-green); }
        .brand-green { color: var(--brand-green); }
        .bg-brandGreen { background-color: var(--brand-green); }
        .bg-brand-10 { background-color: rgba(110, 164, 76, 0.1); }
        
        /* Loading 動畫 */
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-custom { animation: spin 1s linear infinite; }
        .loader { border-top-color: var(--brand-green); animation: spin 1.5s linear infinite; }

        /* 側邊面板系統 */
        .side-panel {
            position: fixed; top: 0; right: 0; height: 100%; width: 100%; max-width: 420px;
            background-color: #f9fafb; z-index: 200; transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column;
            box-shadow: -10px 0 30px rgba(0,0,0,0.05);
        }
        .side-panel.open { transform: translateX(0); }
        
        .overlay {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 190;
            opacity: 0; visibility: hidden; transition: opacity 0.3s; backdrop-filter: blur(4px);
        }
        .overlay.open { opacity: 1; visibility: visible; }

        /* 元件樣式 */
        .btn-outline-brand { 
            background-color: white; color: var(--brand-green); border: 2px solid var(--brand-green); 
            width: 100%; padding: 0.8rem; border-radius: 0.75rem; 
            font-weight: bold; transition: all 0.2s; font-size: 0.875rem; 
        }
        .btn-outline-brand:hover { background-color: rgba(110, 164, 76, 0.05); }

        .btn-primary {
            background-color: var(--brand-green); color: white; font-weight: bold;
            box-shadow: 0 4px 15px -1px rgba(110, 164, 76, 0.3);
            transition: all 0.2s;
        }
        .btn-primary:hover { background-color: #5a8a3e; }
        .btn-primary:active { transform: scale(0.95); }
        .btn-primary:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }

        .checkout-inline-input { 
            width: 100%; padding: 12px; border: 1px solid #e5e7eb; 
            border-radius: 12px; font-size: 0.95rem; outline: none; transition: all 0.2s; 
        }
        .checkout-inline-input:focus { border-color: var(--brand-green); ring: 2px solid rgba(110, 164, 76, 0.1); background-color: white; }
        
        .ship-opt-card.selected { border-color: var(--brand-green); background-color: white; ring: 2px; ring-color: var(--brand-green); }

        .cart-floating-btn {
            position: fixed; bottom: 2rem; right: 2rem; width: 4rem; height: 4rem;
            background-color: var(--brand-green); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100;
            box-shadow: 0 8px 25px rgba(110, 164, 76, 0.4); transition: transform 0.2s;
        }
        .cart-floating-btn:active { transform: scale(0.95); }

        .qty-control { 
            display: flex; align-items: center; justify-content: space-between;
            background: #ffffff; border: 1px solid #e5e7eb; border-radius: 0.75rem;
            padding: 0 8px; height: 48px; box-sizing: border-box;
        }
        .qty-btn { 
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; 
            background: transparent; border-radius: 8px; font-weight: bold; cursor: pointer; border: none;
            color: var(--brand-green); transition: background-color 0.2s;
        }
        .qty-btn:hover { background-color: #f3f4f6; }
        .add-btn { height: 48px !important; display: flex; align-items: center; justify-content: center; padding: 0 16px; }

        .info-card { background: white; border-radius: 1.25rem; border: 1px solid #f1f1f1; padding: 1.25rem; box-shadow: 0 4px 12px rgba(0,0,0,0.02); }

        /* 手機版適配 */
        @media (max-width: 767px) {
            .mobile-product-card { display: flex !important; flex-direction: column !important; padding: 16px !important; gap: 12px !important; }
            .card-top-row { display: flex !important; flex-direction: row !important; gap: 16px !important; width: 100%; }
            .card-img-group { width: 100px !important; height: 100px !important; flex-shrink: 0 !important; border-radius: 12px !important; overflow: hidden; background-color: #f9fafb; }
            .card-info-group { flex: 1 !important; display: flex !important; flex-direction: column !important; justify-content: flex-start; min-height: 100px; }
            .card-bottom-row { display: flex !important; flex-direction: row !important; gap: 12px !important; width: 100%; padding: 0 !important; border-top: none !important; }
            .qty-control { flex: 1 !important; }
            .add-btn { flex: 1.5 !important; }
        }
    </style>
</head>
<body>

    <div id="overlay" class="overlay" onclick="closeAllPanels()"></div>

    <div class="bg-white border-b border-gray-100 shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 max-w-6xl py-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl md:text-2xl font-bold tracking-tight text-brand">
                    <span class="font-brand-text">KEICHA</span> 抹茶代購下單區
                </h1>
                <p class="text-xs text-brand/60 mt-0.5">同品牌任選 2 件 • 即享多入優惠價</p>
            </div>
            <div id="top-auth-zone">
                <button onclick="handleLoginBtnClick()" class="flex items-center gap-1 text-brand font-bold text-sm bg-brand-10 px-4 py-2 rounded-full hover:bg-brand-10/80 transition active:scale-95">
                    <span class="material-symbols-rounded text-lg">account_circle</span> 
                    <span id="header-user-name" class="hidden md:inline">會員登入</span>
                </button>
            </div>
        </div>
    </div>

    <section class="py-8 bg-white border-b border-gray-100">
        <div class="container mx-auto px-4 max-w-5xl">
            <h2 class="text-xl font-bold text-center mb-6 text-gray-800 flex items-center justify-center gap-2">
                <span class="material-symbols-rounded text-brand">storefront</span> 品牌總覽
            </h2>
            <div id="status-loader" class="flex justify-center h-20">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div>
            </div>
            <div id="status-grid-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            <div id="status-error" class="hidden text-center text-brand text-sm mt-4"></div>
        </div>
    </section>

    <main class="max-w-5xl mx-auto px-4 py-8 pb-32">
        <div id="product-list-container" class="space-y-12"></div>
    </main>

    <div class="cart-floating-btn" onclick="openCart()">
        <span class="material-symbols-rounded text-3xl">shopping_bag</span>
        <span id="cart-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold w-6 h-6 flex items-center justify-center rounded-full border-4 border-white hidden">0</span>
    </div>

    <div id="login-panel" class="side-panel">
        <div class="p-6 bg-white border-b flex justify-between items-center sticky top-0 z-10">
            <h3 class="font-bold flex items-center gap-2 text-gray-800"><span class="material-symbols-rounded text-brand">login</span> 會員登入</h3>
            <button onclick="closeAllPanels()" class="material-symbols-rounded text-gray-400">close</button>
        </div>
        <div class="p-8 space-y-8 flex-grow overflow-y-auto">
            <div class="text-center space-y-2">
                <div class="w-16 h-16 bg-brand-10 rounded-3xl flex items-center justify-center mx-auto mb-4">
                    <span class="material-symbols-rounded text-3xl text-brand">potted_plant</span>
                </div>
                <p class="text-gray-800 font-bold text-xl">歡迎來到 <span class="font-brand-text text-brand">KEICHA</span></p>
                <p class="text-sm text-gray-400">請輸入手機號碼快速登入/註冊</p>
            </div>
            <div class="space-y-4">
                <input type="tel" id="member-phone-search" placeholder="例如：0912345678" class="checkout-inline-input text-center text-lg font-bold font-mono tracking-wider">
                <p id="member-msg" class="text-xs text-center min-h-[1.5em]"></p>
                <button onclick="checkMember(this)" class="w-full btn-primary py-4 rounded-2xl flex justify-center items-center gap-2">
                    <span class="btn-text">下一步</span><span class="material-symbols-rounded btn-icon">arrow_forward</span>
                </button>
            </div>
        </div>
    </div>

    <div id="member-center-panel" class="side-panel">
        <div class="p-6 bg-white border-b flex justify-between items-center sticky top-0 z-10">
            <h3 class="font-bold flex items-center gap-2 text-gray-800"><span class="material-symbols-rounded text-brand">person</span> 會員中心</h3>
            <button onclick="closeAllPanels()" class="material-symbols-rounded text-gray-400">close</button>
        </div>
        <div class="p-6 space-y-6 flex-grow overflow-y-auto bg-gray-50/50">
            <div class="bg-brand p-6 rounded-[2rem] text-white shadow-lg shadow-green-900/10">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-white/20 rounded-2xl flex items-center justify-center text-2xl font-bold font-brand-text">09</div>
                    <div>
                        <div id="display-user-phone" class="text-xl font-mono font-bold tracking-tight">0921-***-***</div>
                        <div class="text-xs opacity-70">KEICHA 正式會員</div>
                    </div>
                </div>
            </div>

            <div class="info-card relative">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-sm font-bold text-gray-800 flex items-center gap-2"><span class="material-symbols-rounded text-lg text-gray-400">badge</span> 基本資訊</h4>
                    <button class="text-brand p-1 hover:bg-brand-10 rounded-lg transition"><span class="material-symbols-rounded text-xl">edit_square</span></button>
                </div>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between"><span class="text-gray-400">收件姓名</span><span id="display-user-name" class="font-bold text-gray-700">尚未填寫</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">電子信箱</span><span id="display-user-email" class="font-bold text-gray-700">尚未填寫</span></div>
                </div>
            </div>

            <div class="info-card">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-sm font-bold text-gray-800 flex items-center gap-2"><span class="material-symbols-rounded text-lg text-gray-400">local_shipping</span> 常用物流設定</h4>
                    <button class="text-brand p-1 hover:bg-brand-10 rounded-lg transition"><span class="material-symbols-rounded text-xl">edit_square</span></button>
                </div>
                <div class="space-y-4">
                    <div id="display-user-store" class="text-xs bg-gray-50 p-3 rounded-xl text-gray-500 border border-dashed border-gray-200 text-center">尚未設定常用門市</div>
                    <div class="flex gap-2">
                        <a href="https://www.ibon.com.tw/mobile/retail_inquiry.aspx" target="_blank" class="flex-1 py-2 rounded-full bg-white border border-gray-200 text-[10px] font-bold text-gray-600 flex items-center justify-center gap-1 hover:bg-gray-50 transition shadow-sm">
                            <span class="material-symbols-rounded text-sm">search</span> 查詢 7-11
                        </a>
                        <a href="https://www.family.com.tw/marketing/inquiry.aspx" target="_blank" class="flex-1 py-2 rounded-full bg-white border border-gray-200 text-[10px] font-bold text-gray-600 flex items-center justify-center gap-1 hover:bg-gray-50 transition shadow-sm">
                            <span class="material-symbols-rounded text-sm">search</span> 查詢全家
                        </a>
                    </div>
                </div>
            </div>
            
            <button onclick="logout()" class="w-full py-4 text-gray-400 text-sm font-bold hover:text-red-400 transition flex items-center justify-center gap-2">
                <span class="material-symbols-rounded text-lg">logout</span> 登出會員帳號
            </button>
        </div>
    </div>

    <div id="cart-sidebar" class="side-panel">
        <div class="p-6 border-b flex justify-between items-center bg-white sticky top-0 z-10">
            <h3 class="font-bold flex items-center gap-2 text-gray-800"><span class="material-symbols-rounded text-brand">shopping_cart</span> 購物車清單</h3>
            <button onclick="closeAllPanels()" class="material-symbols-rounded text-gray-400 hover:text-gray-600">close</button>
        </div>
        <div id="cart-items-container" class="flex-grow overflow-y-auto p-6 space-y-4 bg-gray-50/30">
            <div class="text-center text-gray-400 mt-10">購物車是空的</div>
        </div>
        <div class="p-6 border-t bg-white space-y-3 shadow-[0_-8px_30px_rgba(0,0,0,0.04)] rounded-t-[2rem]">
            <div class="flex justify-between items-center font-bold mb-2 px-2">
                <span class="text-gray-500">預估小計</span>
                <span id="bar-total" class="text-2xl text-brand font-mono tracking-tighter">NT$ 0</span>
            </div>
            <button onclick="openCheckout()" class="w-full btn-primary py-4 rounded-2xl flex items-center justify-center gap-2 text-lg">
                前往結帳 <span class="material-symbols-rounded">arrow_forward</span>
            </button>
            <button onclick="closeAllPanels()" class="w-full py-2 text-gray-400 text-sm font-bold">返回商店繼續選購</button>
        </div>
    </div>

    <div id="checkout-panel" class="side-panel">
        <div class="p-6 bg-white border-b flex justify-between items-center sticky top-0 z-20">
            <h3 class="font-bold flex items-center gap-2 text-gray-800"><span class="material-symbols-rounded text-brand">shopping_cart_checkout</span> 結帳確認</h3>
            <button onclick="closeAllPanels()" class="material-symbols-rounded text-gray-400">close</button>
        </div>
        <form id="order-form" onsubmit="submitOrder(event)" class="contents">
            <div class="p-6 flex-1 overflow-y-auto space-y-8 bg-gray-50/50">
                <div class="bg-brand-10 p-5 rounded-2xl border border-brand/10">
                    <h4 class="text-[10px] font-black text-brand uppercase tracking-widest mb-3 flex items-center gap-1">
                        <span class="material-symbols-rounded text-sm">list_alt</span> 購買品項
                    </h4>
                    <ul id="checkout-cart-list" class="text-sm space-y-3 text-gray-700"></ul>
                </div>

                <div class="hidden">
                    <select id="input-logistics" onchange="updateShippingFee()"><option value="7-11">7-11</option><option value="全家">全家</option><option value="郵寄/宅配">宅配</option></select>
                    <input type="checkbox" id="join-member" checked>
                </div>

                <section class="space-y-4">
                    <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">收件資訊</h4>
                    <div class="space-y-3">
                        <input type="text" id="input-name" required class="checkout-inline-input" placeholder="收件人真實姓名">
                        <input type="tel" id="input-phone" required class="checkout-inline-input font-mono" placeholder="手機號碼 09xxxxxxxx">
                        <input type="email" id="input-email" required class="checkout-inline-input" placeholder="電子信箱 (訂單通知用)">
                        <input type="text" id="input-line" class="checkout-inline-input" placeholder="LINE ID / 暱稱 (方便聯繫)">
                    </div>
                </section>

                <section class="space-y-3">
                    <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">配送方式</h4>
                    
                    <div onclick="uiSelectLogistics('7-11')" id="card-7-11" class="ship-opt-card p-4 rounded-2xl border-2 border-transparent bg-white cursor-pointer shadow-sm hover:border-brand/30 transition-all flex items-center gap-3">
                        <div class="w-10 h-10 bg-brand-10 rounded-full flex items-center justify-center text-brand"><span class="material-symbols-rounded">store</span></div>
                        <div class="font-bold text-sm text-gray-800">7-11 店到店</div>
                    </div>
                    <div id="area-7-11" class="hidden p-4 bg-white rounded-2xl border border-gray-100 shadow-sm space-y-3">
                        <div class="flex gap-2">
                            <input type="text" id="store-711-code" class="checkout-inline-input flex-1 text-sm font-mono" placeholder="請填寫 6 碼店號" onchange="syncStoreValue()">
                            <a href="https://www.ibon.com.tw/mobile/retail_inquiry.aspx" target="_blank" class="bg-gray-800 text-white px-4 py-2 rounded-xl text-xs flex items-center font-bold">查詢</a>
                        </div>
                        <input type="text" id="store-711-name" class="checkout-inline-input text-sm" placeholder="門市名稱 (選填)" onchange="syncStoreValue()">
                    </div>

                    <div onclick="uiSelectLogistics('全家')" id="card-fami" class="ship-opt-card p-4 rounded-2xl border-2 border-transparent bg-white cursor-pointer shadow-sm hover:border-brand/30 transition-all flex items-center gap-3">
                        <div class="w-10 h-10 bg-brand-10 rounded-full flex items-center justify-center text-brand"><span class="material-symbols-rounded">convenience_store</span></div>
                        <div class="font-bold text-sm text-gray-800">全家 店到店</div>
                    </div>
                    <div id="area-fami" class="hidden p-4 bg-white rounded-2xl border border-gray-100 shadow-sm space-y-3">
                        <div class="flex gap-2">
                            <input type="text" id="store-fami-code" class="checkout-inline-input flex-1 text-sm font-mono" placeholder="請填寫 6 碼店號" onchange="syncStoreValue()">
                            <a href="https://www.family.com.tw/marketing/inquiry.aspx" target="_blank" class="bg-gray-800 text-white px-4 py-2 rounded-xl text-xs flex items-center font-bold">查詢</a>
                        </div>
                        <input type="text" id="store-fami-name" class="checkout-inline-input text-sm" placeholder="門市名稱 (選填)" onchange="syncStoreValue()">
                    </div>

                    <div onclick="uiSelectLogistics('郵寄/宅配')" id="card-addr" class="ship-opt-card p-4 rounded-2xl border-2 border-transparent bg-white cursor-pointer shadow-sm hover:border-brand/30 transition-all flex items-center gap-3">
                        <div class="w-10 h-10 bg-brand-10 rounded-full flex items-center justify-center text-brand"><span class="material-symbols-rounded">home</span></div>
                        <div class="font-bold text-sm text-gray-800">郵寄 / 宅配</div>
                    </div>
                    <div id="area-addr" class="hidden p-4 bg-white rounded-2xl border border-gray-100 shadow-sm">
                        <textarea id="store-addr-full" class="checkout-inline-input text-sm" rows="2" placeholder="請填寫完整收件地址" onchange="syncStoreValue()"></textarea>
                    </div>
                    
                    <input type="hidden" name="store" id="input-store" required>
                </section>

                <section class="bg-gray-800 p-6 rounded-[2rem] text-white space-y-4 shadow-xl shadow-gray-200">
                    <div class="flex justify-between text-sm opacity-60"><span>商品小計</span><span>NT$ <span id="modal-subtotal">0</span></span></div>
                    <div class="flex justify-between text-sm opacity-60"><span>運費</span><span>NT$ <span id="modal-shipping">0</span></span></div>
                    <div class="flex justify-between text-xl font-bold pt-4 border-t border-white/10">
                        <span>應付總額</span>
                        <span class="text-brand font-mono">NT$ <span id="modal-total">0</span></span>
                    </div>
                </section>
                
                <textarea id="input-note" class="checkout-inline-input text-sm bg-white" rows="2" placeholder="訂單備註 (選填)"></textarea>
            </div>
            <div class="p-6 bg-white border-t rounded-t-[2rem]">
                <button type="submit" id="btn-submit" class="w-full btn-primary py-5 rounded-2xl flex justify-center items-center gap-2 text-lg">
                    <span class="btn-text">確認送出訂單</span><span class="material-symbols-rounded btn-icon">verified</span>
                </button>
            </div>
        </form>
    </div>

    <script>
        // --- 核心變數 ---
        let cart = []; 
        let shippingFee = 0; 
        let shippingRules = []; 
        let tempQtyMap = {}; 
        let isLoggedIn = false; // 登入狀態暫存
        const DISPLAY_API_URL = "https://script.google.com/macros/s/AKfycbxnxbcdCdxH2Qmuek5Up8BqTWeOLUcLR30jfUi0lMbMn5ocn9tY1f_c7yEyd9KSZ4Um/exec"; 
        const ORDER_API_URL = "https://script.google.com/macros/s/AKfycbyUq36i64Z-JGcERE_rZOdphVtVDX8L-lguc7eiUIdoAERqI1ZK8GWAL-HgbC75cuMHFg/exec"; 
        const BASE_REPO_URL = "assets/images/"; 

        // --- 介面切換 ---
        function openPanel(panelId) {
            document.getElementById('overlay').classList.add('open');
            document.getElementById(panelId).classList.add('open');
        }

        function closeAllPanels() {
            document.getElementById('overlay').classList.remove('open');
            document.querySelectorAll('.side-panel').forEach(p => p.classList.remove('open'));
        }

        function handleLoginBtnClick() {
            if (isLoggedIn) {
                openPanel('member-center-panel');
            } else {
                openPanel('login-panel');
            }
        }

        // --- 功能邏輯：登入與按鈕狀態 ---
        function toggleBtnLoading(btn, isLoading) {
            const btnText = btn.querySelector('.btn-text');
            const btnIcon = btn.querySelector('.btn-icon');
            btn.disabled = isLoading;
            if (isLoading) {
                btn.dataset.originalIcon = btnIcon.innerText;
                btn.dataset.originalText = btnText.innerText;
                btnText.innerText = '處理中...';
                btnIcon.innerText = 'progress_activity';
                btnIcon.classList.add('animate-spin-custom');
            } else {
                btnText.innerText = btn.dataset.originalText;
                btnIcon.innerText = btn.dataset.originalIcon;
                btnIcon.classList.remove('animate-spin-custom');
            }
        }

        function checkMember(btn) {
            const phone = document.getElementById('member-phone-search').value.trim();
            const msgEl = document.getElementById('member-msg');
            
            if (!/^09\d{8}$/.test(phone)) {
                alert("手機格式錯誤：請輸入 09 開頭的 10 碼數字");
                return;
            }

            toggleBtnLoading(btn, true);
            msgEl.innerText = "查詢中...";
            msgEl.className = "text-xs mt-1 text-gray-400"; 

            fetch(ORDER_API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "login", phone: phone })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const info = data.data;
                    isLoggedIn = true;
                    // 資料帶入
                    document.getElementById('input-phone').value = info.phone; 
                    document.getElementById('display-user-phone').innerText = info.phone.replace(/(\d{4})(\d{3})(\d{3})/, "$1-***-$3");
                    document.getElementById('header-user-name').innerText = info.name || "會員";
                    if (info.name) {
                        document.getElementById('display-user-name').innerText = info.name;
                        document.getElementById('input-name').value = info.name;
                        document.getElementById('input-email').value = info.email || "";
                        document.getElementById('display-user-email').innerText = info.email || "尚未填寫";
                    }
                    if (info.store_711) {
                        document.getElementById('display-user-store').innerText = "常用門市：" + info.store_711;
                    }
                    closeAllPanels();
                    openPanel('member-center-panel');
                    alert(`歡迎回來，${info.name || '會員'}！`);
                } else {
                    msgEl.innerText = "是新朋友呢！請在結帳時填寫資料，下單後將自動存為會員。";
                    msgEl.className = "text-xs mt-1 text-brand font-bold";
                    setTimeout(() => {
                        closeAllPanels();
                        document.getElementById('input-phone').value = phone;
                        openCart();
                    }, 1500);
                }
            })
            .catch(err => {
                console.error(err);
                msgEl.innerText = "連線失敗，請檢查網路";
            })
            .finally(() => toggleBtnLoading(btn, false));
        }

        function logout() {
            isLoggedIn = false;
            document.getElementById('header-user-name').innerText = "會員登入";
            closeAllPanels();
            alert("已登出帳號");
        }

        // --- 購物車與訂單邏輯 ---
        function adjQty(productId, change) {
            if (!tempQtyMap[productId]) tempQtyMap[productId] = 1;
            let newQty = tempQtyMap[productId] + change;
            if (newQty < 1) newQty = 1; 
            tempQtyMap[productId] = newQty;
            const qtyDisplay = document.getElementById(`iq-${productId}`);
            if (qtyDisplay) { qtyDisplay.innerText = newQty; }
        }

        function addToCart(productId, name, price, priceMulti, stock, maxLimit) {
            const qtyToAdd = tempQtyMap[productId] || 1;
            const existingItem = cart.find(item => item.name === name);
            let currentCartQty = existingItem ? existingItem.qty : 0;
            if (currentCartQty + qtyToAdd > stock) { alert("庫存不足！"); return; }
            if (currentCartQty + qtyToAdd > maxLimit) { alert(`限購 ${maxLimit} 件`); return; }
            if (existingItem) { existingItem.qty += qtyToAdd; } 
            else { cart.push({ productId, name, price, price_multi: priceMulti, qty: qtyToAdd }); }
            tempQtyMap[productId] = 1;
            const qEl = document.getElementById(`iq-${productId}`); if(qEl) qEl.innerText = 1;
            updateCartUI();
            openCart();
        }

        function calculateSubtotal() {
            return cart.reduce((acc, item) => acc + (item.qty >= 2 ? item.price_multi : item.price) * item.qty, 0);
        }

        function updateCartUI() {
            const sub = calculateSubtotal();
            const badge = document.getElementById('cart-badge');
            const totalQty = cart.reduce((a, b) => a + b.qty, 0);
            document.querySelectorAll('#bar-total').forEach(el => el.innerText = "NT$ " + sub.toLocaleString());
            if(badge) { badge.innerText = totalQty; badge.classList.toggle('hidden', totalQty === 0); }
            updateCartSidebarRender();
        }

        function updateCartSidebarRender() {
            const container = document.getElementById('cart-items-container');
            container.innerHTML = cart.length === 0 ? '<div class="text-center text-gray-400 mt-10">購物車是空的</div>' : '';
            cart.forEach(item => {
                const total = (item.qty * (item.qty >= 2 ? item.price_multi : item.price));
                container.innerHTML += `
                    <div class="flex gap-4 p-4 bg-white rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800 text-sm line-clamp-1">${item.name}</h4>
                            <div class="flex justify-between items-end mt-2">
                                <div class="text-brand font-bold">NT$ ${total}</div>
                                <div class="text-[10px] font-bold bg-gray-100 text-gray-400 px-2 py-1 rounded-lg">x${item.qty}</div>
                            </div>
                        </div>
                    </div>`;
            });
        }

        function openCheckout() {
            if (cart.length === 0) { alert("購物車是空的！"); return; }
            const listEl = document.getElementById('checkout-cart-list');
            listEl.innerHTML = '';
            cart.forEach(item => {
                const price = item.qty >= 2 ? item.price_multi : item.price;
                listEl.innerHTML += `<li class="flex justify-between"><span>${item.name} <span class="text-[10px] text-gray-400">x${item.qty}</span></span><span class="font-bold">$${price * item.qty}</span></li>`;
            });
            updateShippingFee();
            closeAllPanels();
            openPanel('checkout-panel');
        }

        function uiSelectLogistics(value) {
            document.getElementById('input-logistics').value = value;
            updateShippingFee();
            document.querySelectorAll('.ship-opt-card').forEach(el => el.classList.remove('selected', 'ring-2', 'ring-brand'));
            document.querySelectorAll('[id^="area-"]').forEach(el => el.classList.add('hidden'));
            if(value === '7-11') { document.getElementById('card-7-11').classList.add('selected', 'ring-2', 'ring-brand'); document.getElementById('area-7-11').classList.remove('hidden'); }
            else if(value === '全家') { document.getElementById('card-fami').classList.add('selected', 'ring-2', 'ring-brand'); document.getElementById('area-fami').classList.remove('hidden'); }
            else { document.getElementById('card-addr').classList.add('selected', 'ring-2', 'ring-brand'); document.getElementById('area-addr').classList.remove('hidden'); }
            syncStoreValue();
        }

        function syncStoreValue() {
            const logistics = document.getElementById('input-logistics').value;
            let val = "";
            if(logistics === '7-11') val = document.getElementById('store-711-code').value + " " + document.getElementById('store-711-name').value;
            else if(logistics === '全家') val = document.getElementById('store-fami-code').value + " " + document.getElementById('store-fami-name').value;
            else val = document.getElementById('store-addr-full').value;
            document.getElementById('input-store').value = val.trim();
        }

        function updateShippingFee() {
            const sub = calculateSubtotal();
            const logis = document.getElementById('input-logistics').value;
            const rule = shippingRules.find(r => r.category === '抹茶' && logis.includes(r.method));
            shippingFee = logis.includes("宅配") ? 100 : 60;
            if (rule) {
                shippingFee = Number(rule.base);
                if (rule.t3 && sub >= rule.t3) shippingFee = Number(rule.f3);
                else if (rule.t2 && sub >= rule.t2) shippingFee = Number(rule.f2);
                else if (rule.t1 && sub >= rule.t1) shippingFee = Number(rule.f1);
            }
            document.getElementById('modal-subtotal').innerText = sub.toLocaleString();
            document.getElementById('modal-shipping').innerText = shippingFee;
            document.getElementById('modal-total').innerText = (sub + shippingFee).toLocaleString();
        }

        function submitOrder(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            const phone = document.getElementById('input-phone').value.trim();
            const logis = document.getElementById('input-logistics').value;
            const storeCode = (logis === '7-11') ? document.getElementById('store-711-code').value.trim() : (logis === '全家' ? document.getElementById('store-fami-code').value.trim() : "ADDR");

            if (!/^09\d{8}$/.test(phone)) { alert("手機號碼格式錯誤！"); return; }
            if ((logis === '7-11' || logis === '全家') && !/^\d{6}$/.test(storeCode)) { alert("請填寫正確的 6 碼店號！"); return; }

            toggleBtnLoading(btn, true);
            const sub = calculateSubtotal();
            const itemsStr = cart.map(i => `${i.name} x${i.qty} ($${i.qty >= 2 ? i.price_multi : i.price})`).join('\n');
            const payload = {
                action: "checkout",
                name: document.getElementById('input-name').value,
                phone: phone,
                email: document.getElementById('input-email').value,
                line_name: document.getElementById('input-line').value,
                logistics: logis,
                store: document.getElementById('input-store').value,
                product_note: document.getElementById('input-note').value,
                join_member: document.getElementById('join-member').checked,
                items: itemsStr, subtotal: sub, shipping: shippingFee, temp: "常溫", date: new Date().toISOString()
            };

            fetch(ORDER_API_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert(`訂單建立成功！\n訂單編號: ${data.orderId}`);
                    cart = []; updateCartUI(); closeAllPanels(); document.getElementById('order-form').reset();
                } else { alert("失敗: " + data.msg); }
            })
            .catch(err => { console.error(err); alert("網路錯誤"); })
            .finally(() => toggleBtnLoading(btn, false));
        }

        // --- 初始化與資料載入 ---
        window.addEventListener('load', () => {
            fetch(ORDER_API_URL).then(res => res.json()).then(data => { if(data.shipping_rules) shippingRules = data.shipping_rules; });
            fetch(DISPLAY_API_URL).then(res => res.json()).then(data => {
                if (data.error) return;
                const container = document.getElementById('status-grid-container');
                const listContainer = document.getElementById('product-list-container');
                container.innerHTML = ''; listContainer.innerHTML = '';
                document.getElementById('status-loader').style.display = 'none';

                data.brands.sort((a,b) => (a.order||999) - (b.order||999)).forEach(brand => {
                    const isAvail = ['available','open','開團','收單中','可訂購'].includes((brand.status||'').toLowerCase().trim());
                    container.innerHTML += `
                        <a href="#brand-${brand.key}" class="block group transform hover:-translate-y-1 transition duration-300">
                            <div class="bg-white rounded-2xl p-4 border border-gray-100 flex justify-between items-center shadow-sm group-hover:shadow-md">
                                <span class="font-bold text-gray-800">${brand.name}</span>
                                <span class="${isAvail ? 'bg-brandGreen text-white' : 'bg-gray-100 text-gray-400'} text-[10px] font-bold px-3 py-1 rounded-full">${isAvail ? '可訂購' : '缺貨中'}</span>
                            </div>
                        </a>`;
                    
                    const brandGridId = `${brand.key}-grid`;
                    listContainer.innerHTML += `<section id="brand-${brand.key}" class="scroll-mt-24"><h2 class="text-xl font-bold mb-6 flex items-center gap-2"><span class="w-1.5 h-6 bg-brand rounded-full"></span>${brand.name}</h2><div id="${brandGridId}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></section>`;
                    
                    const brandProducts = data.products.filter(p => p.brand_key === brand.key);
                    const grid = document.getElementById(brandGridId);
                    brandProducts.forEach(p => {
                        const pid = p.key || Math.random().toString(36).substr(2,7);
                        const isSoldOut = (p.stock !== undefined && Number(p.stock) <= 0) || (p.status||'').includes('完售');
                        const hasImg = p.img !== '';
                        const hasMulti = (Number(p.price_multi) > 0 && Number(p.price_multi) < Number(p.price));
                        
                        grid.innerHTML += `
                            <div class="bg-white rounded-2xl border border-gray-100 overflow-hidden shadow-sm flex flex-col mobile-product-card transition hover:shadow-lg group relative">
                                ${p.tag ? `<span class="absolute top-3 right-3 bg-brandGreen text-white text-[10px] font-black px-2 py-0.5 rounded-full z-10">${p.tag}</span>` : ''}
                                <div class="card-top-row md:contents ${hasImg ? 'items-center' : ''}">
                                    ${hasImg ? `<div class="card-img-group"><img src="${p.img.startsWith('http')?p.img:BASE_REPO_URL+p.img}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500"></div>` : ''}
                                    <div class="card-info-group p-5 flex flex-col gap-2">
                                        <h4 class="font-bold text-gray-800 text-lg leading-tight line-clamp-1">${p.name}${p.spec ? `<span class="text-[10px] text-gray-400 font-normal ml-1">${p.spec}</span>` : ''}</h4>
                                        <p class="text-[10px] text-gray-400 line-clamp-2 min-h-[2.5em] leading-relaxed">${p.note || ''}</p>
                                        <div class="mt-auto text-right">
                                            ${hasMulti ? `<div class="flex flex-col"><span class="text-[10px] text-gray-400 line-through">$${p.price}</span><span class="text-brand font-bold font-mono">2件起 $${p.price_multi}</span></div>` : `<span class="text-brand font-bold font-mono">NT$ ${p.price}</span>`}
                                        </div>
                                    </div>
                                </div>
                                <div class="card-bottom-row md:p-5 md:pt-0 md:flex md:gap-2">
                                    <div class="qty-control"><button class="qty-btn" onclick="adjQty('${pid}',-1)" ${isSoldOut?'disabled':''}>-</button><span id="iq-${pid}" class="text-xs font-bold px-2">1</span><button class="qty-btn" onclick="adjQty('${pid}',1)" ${isSoldOut?'disabled':''}>+</button></div>
                                    <button class="add-btn flex-1 rounded-xl text-xs font-bold ${isSoldOut?'bg-gray-100 text-gray-400':'bg-brand text-white'}" ${isSoldOut?'':`onclick="addToCart('${pid}','${p.name}',${p.price},${p.price_multi},${p.stock},${p.max_limit})"`}>${isSoldOut?'已完售':'加入購物車'}</button>
                                </div>
                            </div>`;
                    });
                });
            });
        });
    </script>
</body>
</html>
