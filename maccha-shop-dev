<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEICHA 網路商店</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            DEFAULT: '#6ea44c',
                            light: '#8bc34a',
                            dark: '#558b3e',
                            bg: '#f9f9f7'
                        }
                    },
                    fontFamily: {
                        sans: ['"Microsoft JhengHei"', '"Heiti TC"', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        /* 基礎設定 */
        body { background-color: #f9f9f7; -webkit-tap-highlight-color: transparent; }
        .material-symbols-rounded { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }

        /* 側邊面板與遮罩動畫 */
        .side-panel {
            position: fixed; top: 0; right: 0; height: 100%; width: 100%; max-width: 420px;
            background-color: white; z-index: 50; transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
            box-shadow: -4px 0 25px rgba(0,0,0,0.1);
        }
        .side-panel.open { transform: translateX(0); }

        .overlay {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.4); z-index: 40;
            opacity: 0; visibility: hidden; transition: all 0.3s;
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
        }
        .overlay.open { opacity: 1; visibility: visible; }

        /* 數量控制組件樣式 */
        .qty-control-group {
            display: flex; align-items: center; justify-content: space-between;
            background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px;
            height: 48px; padding: 0 4px; width: 100%;
        }
        .qty-btn {
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            border-radius: 8px; color: #6ea44c; cursor: pointer; transition: background 0.2s;
        }
        .qty-btn:hover { background-color: #f3f4f6; }
        .qty-val { font-weight: bold; color: #374151; width: 24px; text-align: center; font-size: 14px; }

        /* 載入動畫 */
        .spinner { border: 3px solid #e5e7eb; border-top: 3px solid #6ea44c; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 隱藏滾動條但保留功能 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 懸浮購物車按鈕 */
        .float-cart-btn {
            position: fixed; bottom: 24px; right: 24px; width: 64px; height: 64px;
            background-color: #6ea44c; border-radius: 50%; color: white;
            box-shadow: 0 4px 20px rgba(110, 164, 76, 0.4);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 30; transition: transform 0.2s;
        }
        .float-cart-btn:active { transform: scale(0.95); }
    </style>
</head>
<body class="pb-24 md:pb-10">

    <nav class="sticky top-0 z-30 bg-white/90 backdrop-blur-md border-b border-gray-100">
        <div class="container mx-auto px-4 h-16 flex items-center justify-between max-w-6xl">
            <div class="flex items-center gap-2">
                <span class="material-symbols-rounded text-brand text-3xl">local_cafe</span>
                <h1 class="text-xl font-bold tracking-wide text-gray-800">KEICHA</h1>
            </div>
            <div id="top-auth-zone">
                </div>
        </div>
    </nav>

    <div id="announcement-bar" class="hidden bg-yellow-50 border-b border-yellow-100 py-2">
        <p id="announcement-text" class="text-center text-xs font-bold text-yellow-700 container mx-auto px-4"></p>
    </div>

    <main class="container mx-auto px-4 py-8 max-w-6xl min-h-screen">
        <div id="loading-state" class="flex flex-col items-center justify-center py-20">
            <div class="spinner w-10 h-10 border-4"></div>
            <p class="text-gray-400 text-sm mt-4 font-bold">正在準備抹茶...</p>
        </div>
        
        <div id="product-grid" class="hidden space-y-12">
            </div>
    </main>

    <div id="overlay" class="overlay" onclick="closeAllPanels()"></div>

    <div id="panel-login" class="side-panel">
        <div class="p-6 bg-brand text-white flex justify-between items-center shadow-sm">
            <h3 class="font-bold text-lg flex items-center gap-2">
                <span class="material-symbols-rounded">login</span> 會員登入
            </h3>
            <button onclick="closeAllPanels()" class="material-symbols-rounded opacity-80 hover:opacity-100">close</button>
        </div>
        <div class="p-8 flex flex-col gap-6 pt-12">
            <div class="text-center space-y-1">
                <h4 class="text-xl font-bold text-gray-800">歡迎回到 KEICHA</h4>
                <p class="text-sm text-gray-400">請輸入手機號碼以快速登入或註冊</p>
            </div>
            <div class="relative">
                <span class="material-symbols-rounded absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">smartphone</span>
                <input type="tel" id="login-phone" placeholder="0912345678" 
                    class="w-full pl-12 pr-4 py-4 bg-gray-50 border border-gray-200 rounded-2xl text-lg font-bold outline-none focus:ring-2 focus:ring-brand focus:border-transparent transition-all">
            </div>
            <button onclick="handleLogin()" id="btn-login-submit" 
                class="w-full bg-brand text-white py-4 rounded-2xl font-bold text-lg shadow-lg shadow-brand/20 hover:bg-brand-dark active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                下一步 <span class="material-symbols-rounded">arrow_forward</span>
            </button>
        </div>
    </div>

    <div id="panel-cart" class="side-panel">
        <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-white z-10">
            <h3 class="font-bold text-lg flex items-center gap-2 text-gray-800">
                <span class="material-symbols-rounded">shopping_bag</span> 購物車
            </h3>
            <button onclick="closeAllPanels()" class="material-symbols-rounded text-gray-400 hover:text-gray-600">close</button>
        </div>
        
        <div id="cart-list" class="flex-1 overflow-y-auto p-5 space-y-6 no-scrollbar">
            </div>

        <div class="p-6 bg-gray-50 border-t border-gray-100 space-y-4">
            <div class="flex justify-between items-end">
                <span class="text-sm font-bold text-gray-500">小計</span>
                <span id="cart-subtotal" class="text-2xl font-bold text-brand font-mono">NT$ 0</span>
            </div>
            <button onclick="openCheckout()" 
                class="w-full bg-brand text-white py-4 rounded-2xl font-bold text-lg shadow-lg shadow-brand/20 hover:bg-brand-dark active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                前往結帳 <span class="material-symbols-rounded">shopping_cart_checkout</span>
            </button>
        </div>
    </div>

    <div id="panel-user" class="side-panel">
        <div class="p-6 bg-brand text-white flex justify-between items-center shadow-sm">
            <h3 class="font-bold text-lg flex items-center gap-2">
                <span class="material-symbols-rounded">person</span> 會員中心
            </h3>
            <button onclick="closeAllPanels()" class="material-symbols-rounded opacity-80 hover:opacity-100">close</button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6 space-y-8 no-scrollbar bg-gray-50/50">
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                <div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">基本資料</div>
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-bold text-brand mb-1 block">手機號碼 (帳號)</label>
                        <div id="user-phone" class="font-mono font-bold text-lg text-gray-800"></div>
                    </div>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 mb-1 block">收件人姓名</label>
                            <input type="text" id="user-name" placeholder="尚未設定" 
                                class="w-full bg-gray-50 border-b-2 border-transparent focus:border-brand outline-none py-1 font-bold text-gray-700 transition-colors">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 mb-1 block">電子信箱</label>
                            <input type="email" id="user-email" placeholder="尚未設定" 
                                class="w-full bg-gray-50 border-b-2 border-transparent focus:border-brand outline-none py-1 font-bold text-gray-700 transition-colors">
                        </div>
                    </div>
                </div>
                <button onclick="saveUserInfo()" id="btn-save-user" class="mt-4 w-full py-2 rounded-xl bg-gray-100 text-gray-600 text-xs font-bold hover:bg-brand hover:text-white transition-colors">儲存基本資料</button>
            </div>

            <div class="space-y-4">
                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest ml-1">預設物流設定</h4>
                
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-rounded text-brand">local_shipping</span>
                            <span class="font-bold text-sm text-gray-700">7-11 門市</span>
                        </div>
                        <a href="https://www.ibon.com.tw/mobile/retail_inquiry.aspx" target="_blank" class="text-[10px] bg-gray-100 hover:bg-brand hover:text-white px-3 py-1 rounded-full font-bold transition-colors">查詢店號</a>
                    </div>
                    <div class="space-y-3">
                        <input type="text" id="store-711-code" placeholder="請輸入 6 碼店號" maxlength="6"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-100 text-sm font-bold outline-none focus:ring-1 focus:ring-brand">
                        <input type="text" id="store-711-name" placeholder="門市名稱備註 (選填)" 
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-100 text-sm outline-none focus:ring-1 focus:ring-brand">
                        <button onclick="saveStoreInfo('7-11')" class="w-full py-2 bg-brand text-white rounded-xl text-xs font-bold shadow-sm">儲存設定</button>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-rounded text-blue-500">store</span>
                            <span class="font-bold text-sm text-gray-700">全家 門市</span>
                        </div>
                        <a href="https://www.family.com.tw/marketing/inquiry.aspx" target="_blank" class="text-[10px] bg-gray-100 hover:bg-blue-500 hover:text-white px-3 py-1 rounded-full font-bold transition-colors">查詢店號</a>
                    </div>
                    <div class="space-y-3">
                        <input type="text" id="store-fami-code" placeholder="請輸入 6 碼店號" maxlength="6"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-100 text-sm font-bold outline-none focus:ring-1 focus:ring-blue-500">
                        <input type="text" id="store-fami-name" placeholder="門市名稱備註 (選填)" 
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-100 text-sm outline-none focus:ring-1 focus:ring-blue-500">
                        <button onclick="saveStoreInfo('fami')" class="w-full py-2 bg-blue-500 text-white rounded-xl text-xs font-bold shadow-sm">儲存設定</button>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="material-symbols-rounded text-orange-500">home</span>
                        <span class="font-bold text-sm text-gray-700">宅配地址</span>
                    </div>
                    <div class="space-y-3">
                        <textarea id="store-addr" rows="2" placeholder="請輸入完整地址" 
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-100 text-sm outline-none focus:ring-1 focus:ring-orange-500 resize-none"></textarea>
                        <button onclick="saveStoreInfo('addr')" class="w-full py-2 bg-orange-500 text-white rounded-xl text-xs font-bold shadow-sm">儲存設定</button>
                    </div>
                </div>
            </div>

            <div class="pt-6">
                <button onclick="handleLogout()" class="w-full py-3 rounded-xl border border-red-100 text-red-400 text-sm font-bold hover:bg-red-50 transition-colors">登出帳號</button>
            </div>
        </div>
    </div>

    <div id="panel-checkout" class="side-panel">
        <div class="p-6 bg-brand text-white flex justify-between items-center shadow-sm z-10">
            <h3 class="font-bold text-lg flex items-center gap-2">
                <span class="material-symbols-rounded">shopping_cart_checkout</span> 訂單確認
            </h3>
            <button onclick="closeAllPanels()" class="material-symbols-rounded opacity-80 hover:opacity-100">close</button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-8 bg-gray-50/50 no-scrollbar">
            <section class="space-y-3">
                <div class="flex justify-between items-end">
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest">收件人資訊</h4>
                    <button onclick="openUserPanel()" class="text-[10px] text-brand font-bold bg-brand/10 px-2 py-1 rounded-lg">修改</button>
                </div>
                <div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm text-sm space-y-2">
                    <div class="flex justify-between"><span class="text-gray-400">姓名</span><span id="chk-name" class="font-bold text-gray-800"></span></div>
                    <div class="flex justify-between"><span class="text-gray-400">電話</span><span id="chk-phone" class="font-bold font-mono text-gray-800"></span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Email</span><span id="chk-email" class="font-bold text-gray-800 break-all"></span></div>
                </div>
            </section>

            <section class="space-y-3">
                 <h4 class="text-xs font-bold text-brand uppercase tracking-widest flex items-center gap-1">
                    LINE 名稱 <span class="bg-red-50 text-red-500 text-[10px] px-1.5 rounded">必填</span>
                 </h4>
                 <input type="text" id="order-line" placeholder="請輸入您的 LINE 顯示名稱" 
                    class="w-full p-4 bg-white border-2 border-brand/20 rounded-2xl text-sm font-bold outline-none focus:border-brand focus:ring-4 focus:ring-brand/10 transition-all">
                 <p class="text-[10px] text-gray-400 pl-1">* 為了確認訂單與聯繫出貨，請務必填寫。</p>
            </section>

            <section class="space-y-3">
                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest">選擇配送方式</h4>
                
                <div onclick="selectLogistics('7-11')" id="card-7-11" class="logistics-card bg-white p-4 rounded-2xl border-2 border-transparent cursor-pointer hover:bg-gray-50 transition-all">
                    <div class="flex justify-between items-start">
                        <div class="flex gap-3">
                            <span class="material-symbols-rounded text-brand mt-1">local_shipping</span>
                            <div>
                                <div class="font-bold text-gray-800 text-sm">7-11 店到店</div>
                                <div id="info-7-11" class="text-xs text-gray-400 mt-1">未設定</div>
                            </div>
                        </div>
                        <div class="radio-circle w-5 h-5 rounded-full border-2 border-gray-200"></div>
                    </div>
                </div>

                <div onclick="selectLogistics('fami')" id="card-fami" class="logistics-card bg-white p-4 rounded-2xl border-2 border-transparent cursor-pointer hover:bg-gray-50 transition-all">
                    <div class="flex justify-between items-start">
                        <div class="flex gap-3">
                            <span class="material-symbols-rounded text-blue-500 mt-1">store</span>
                            <div>
                                <div class="font-bold text-gray-800 text-sm">全家 店到店</div>
                                <div id="info-fami" class="text-xs text-gray-400 mt-1">未設定</div>
                            </div>
                        </div>
                        <div class="radio-circle w-5 h-5 rounded-full border-2 border-gray-200"></div>
                    </div>
                </div>

                <div onclick="selectLogistics('home')" id="card-home" class="logistics-card bg-white p-4 rounded-2xl border-2 border-transparent cursor-pointer hover:bg-gray-50 transition-all">
                    <div class="flex justify-between items-start">
                        <div class="flex gap-3">
                            <span class="material-symbols-rounded text-orange-500 mt-1">home</span>
                            <div>
                                <div class="font-bold text-gray-800 text-sm">宅配到府</div>
                                <div id="info-home" class="text-xs text-gray-400 mt-1">未設定</div>
                            </div>
                        </div>
                        <div class="radio-circle w-5 h-5 rounded-full border-2 border-gray-200"></div>
                    </div>
                </div>
            </section>

            <section class="space-y-3">
                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest">訂單備註</h4>
                <textarea id="order-note" rows="2" placeholder="如有特殊需求請在此填寫..." class="w-full p-4 bg-white rounded-2xl border border-gray-100 text-sm outline-none resize-none focus:border-brand"></textarea>
            </section>

            <section class="bg-white p-5 rounded-3xl border border-gray-100 space-y-3">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-500">商品小計</span>
                    <span id="chk-subtotal" class="font-bold text-gray-800 font-mono">NT$ 0</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-500">運費</span>
                    <span id="chk-shipping" class="font-bold text-gray-800 font-mono">NT$ 0</span>
                </div>
                <div class="pt-3 border-t border-gray-100 flex justify-between items-end">
                    <span class="text-base font-bold text-gray-800">總付款金額</span>
                    <span id="chk-total" class="text-2xl font-bold text-brand font-mono">NT$ 0</span>
                </div>
            </section>
        </div>

        <div class="p-6 bg-white border-t border-gray-100">
            <button onclick="submitOrder()" id="btn-submit-order" 
                class="w-full bg-brand text-white py-4 rounded-2xl font-bold text-lg shadow-lg shadow-brand/20 hover:bg-brand-dark active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                確認送出訂單 <span class="material-symbols-rounded">verified</span>
            </button>
        </div>
    </div>

    <div onclick="openCart()" class="float-cart-btn hover:-translate-y-1">
        <span class="material-symbols-rounded text-3xl">shopping_cart</span>
        <span id="float-badge" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full border-2 border-brand hidden">0</span>
    </div>

    <script>
        // 設定區
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyUq36i64Z-JGcERE_rZOdphVtVDX8L-lguc7eiUIdoAERqI1ZK8GWAL-HgbC75cuMHFg/exec"; 
        const BASE_IMG_URL = "assets/images/";

        // 狀態管理
        let products = [];
        let cart = [];
        let shippingRules = [];
        let selectedLogistics = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
        });

        // 1. 資料讀取
        async function fetchData() {
            try {
                const res = await fetch(GAS_URL);
                const data = await res.json();
                
                if(data.success === false) throw new Error(data.msg);

                products = data.products || [];
                shippingRules = data.shipping_rules || [];
                
                renderProducts();
                
                // 公告
                if(data.fast_config && data.fast_config.items_text) {
                    const note = data.fast_config.items_text; // 借用欄位放公告
                    if(note && note !== 'undefined') {
                        document.getElementById('announcement-bar').classList.remove('hidden');
                        document.getElementById('announcement-text').innerText = note;
                    }
                }

                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('product-grid').classList.remove('hidden');
                updateTopAuth();

            } catch (e) {
                console.error(e);
                document.getElementById('loading-state').innerHTML = `<p class="text-red-500 font-bold">載入失敗，請重新整理頁面</p>`;
            }
        }

        // 2. 商品渲染 (響應式卡片)
        function renderProducts() {
            const container = document.getElementById('product-grid');
            const grouped = groupBy(products, 'category'); // 假設有 category 欄位，沒有則分到 '精選商品'

            let html = '';
            for(const [cat, items] of Object.entries(grouped)) {
                html += `<section class="space-y-6">
                    <h2 class="text-xl font-bold text-gray-800 border-l-4 border-brand pl-3">${cat === 'undefined' ? '精選商品' : cat}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-8">
                        ${items.map(p => createProductCard(p)).join('')}
                    </div>
                </section>`;
            }
            container.innerHTML = html;
        }

        function createProductCard(p) {
            const stock = parseInt(p.stock) || 0;
            const isSoldOut = stock <= 0;
            let img = p.image_url || '';
            if(img && !img.startsWith('http')) img = BASE_IMG_URL + img;

            // 桌機版：垂直佈局；手機版：水平佈局 (Flex row)
            return `
            <div class="bg-white rounded-3xl p-3 md:p-4 shadow-sm border border-gray-100 flex md:flex-col gap-4 group transition-all hover:shadow-md">
                <div class="relative w-[100px] h-[100px] md:w-full md:aspect-square flex-shrink-0 bg-gray-50 rounded-2xl overflow-hidden">
                    ${img ? `<img src="${img}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110 ${isSoldOut ? 'grayscale opacity-50' : ''}">` : ''}
                    ${isSoldOut ? `<div class="absolute inset-0 flex items-center justify-center bg-black/10"><span class="bg-black/70 text-white text-[10px] px-2 py-1 rounded-full backdrop-blur-sm">已售完</span></div>` : ''}
                </div>

                <div class="flex-1 flex flex-col justify-between md:gap-3">
                    <div>
                        <h3 class="font-bold text-gray-800 text-sm md:text-base leading-tight mb-1 line-clamp-2">${p.product_name}</h3>
                        <div class="font-mono font-bold text-brand text-lg">NT$ ${parseInt(p.price).toLocaleString()}</div>
                    </div>

                    <div class="flex items-center gap-2 mt-auto">
                        <div class="qty-control-group flex-1 max-w-[100px]">
                            <div class="qty-btn" onclick="adjQtyTemp('${p.product_id}', -1)">-</div>
                            <div id="tmp-qty-${p.product_id}" class="qty-val">1</div>
                            <div class="qty-btn" onclick="adjQtyTemp('${p.product_id}', 1)">+</div>
                        </div>
                        <button onclick="addToCart('${p.product_id}')" ${isSoldOut?'disabled':''}
                            class="flex-1 h-[48px] bg-brand text-white rounded-xl font-bold text-sm shadow-sm hover:bg-brand-dark active:scale-95 transition-all disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed flex justify-center items-center">
                            ${isSoldOut ? '補貨中' : '加入'}
                        </button>
                    </div>
                </div>
            </div>`;
        }

        // 輔助：暫存數量調整 (還沒加入購物車前)
        function adjQtyTemp(pid, delta) {
            const el = document.getElementById(`tmp-qty-${pid}`);
            let v = parseInt(el.innerText) + delta;
            if(v < 1) v = 1;
            el.innerText = v;
        }

        // 3. 購物車邏輯
        function addToCart(pid) {
            const p = products.find(x => x.product_id == pid);
            const qtyEl = document.getElementById(`tmp-qty-${pid}`);
            const qty = parseInt(qtyEl.innerText);
            
            // 檢查庫存
            const currentInCart = cart.find(x => x.id == pid)?.qty || 0;
            if (currentInCart + qty > (p.stock || 999)) {
                alert("庫存不足！");
                return;
            }

            const exist = cart.find(x => x.id == pid);
            if(exist) exist.qty += qty;
            else cart.push({ id: pid, name: p.product_name, price: parseInt(p.price), qty: qty, img: p.image_url });

            // 重置數量
            qtyEl.innerText = 1;
            renderCart();
            
            // 提示動畫 (簡單震動)
            if(navigator.vibrate) navigator.vibrate(50);
            openPanel('cart');
        }

        function renderCart() {
            const list = document.getElementById('cart-list');
            const totalEl = document.getElementById('cart-subtotal');
            const badge = document.getElementById('float-badge');
            
            let total = 0;
            let count = 0;
            
            if(cart.length === 0) {
                list.innerHTML = `<div class="flex flex-col items-center justify-center h-40 text-gray-300"><span class="material-symbols-rounded text-5xl mb-2">production_quantity_limits</span><p class="text-xs font-bold">購物車是空的</p></div>`;
            } else {
                list.innerHTML = cart.map((item, idx) => {
                    total += item.price * item.qty;
                    count += item.qty;
                    return `
                    <div class="flex gap-4 border-b border-gray-100 pb-4 last:border-0">
                        <div class="w-16 h-16 bg-gray-50 rounded-lg flex-shrink-0 overflow-hidden">
                            ${item.img ? `<img src="${item.img.startsWith('http')?item.img:BASE_IMG_URL+item.img}" class="w-full h-full object-cover">` : ''}
                        </div>
                        <div class="flex-1 flex flex-col justify-between">
                            <div class="font-bold text-gray-800 text-sm line-clamp-1">${item.name}</div>
                            <div class="flex justify-between items-center mt-2">
                                <div class="font-mono font-bold text-brand text-sm">NT$ ${item.price}</div>
                                <div class="flex items-center gap-3 bg-gray-50 rounded-lg px-2 py-1">
                                    <button onclick="updateCart(${idx}, -1)" class="text-gray-400 hover:text-brand font-bold">-</button>
                                    <span class="text-xs font-bold w-4 text-center">${item.qty}</span>
                                    <button onclick="updateCart(${idx}, 1)" class="text-gray-400 hover:text-brand font-bold">+</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }
            
            totalEl.innerText = `NT$ ${total.toLocaleString()}`;
            badge.innerText = count;
            badge.classList.toggle('hidden', count === 0);
        }

        function updateCart(idx, delta) {
            cart[idx].qty += delta;
            if(cart[idx].qty <= 0) cart.splice(idx, 1);
            renderCart();
        }

        // 4. 面板控制
        function openPanel(id) {
            closeAllPanels();
            document.getElementById(`panel-${id}`).classList.add('open');
            document.getElementById('overlay').classList.add('open');
            
            if(id === 'user') renderUserPanel();
            if(id === 'checkout') initCheckout();
        }
        function closeAllPanels() {
            document.querySelectorAll('.side-panel').forEach(el => el.classList.remove('open'));
            document.getElementById('overlay').classList.remove('open');
        }

        // 5. 會員系統
        async function handleLogin() {
            const phone = document.getElementById('login-phone').value.trim();
            if(!/^09\d{8}$/.test(phone)) return alert("請輸入正確的 09 開頭手機號碼");

            const btn = document.getElementById('btn-login-submit');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<div class="spinner border-white"></div>`;
            
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'login', phone }) });
                const data = await res.json();
                
                if(data.success) {
                    localStorage.setItem('keicha_user', JSON.stringify(data.data));
                    updateTopAuth();
                    closeAllPanels();
                    // 如果購物車有東西，登入後自動開購物車
                    if(cart.length > 0) openPanel('cart');
                }
            } catch(e) { alert("登入失敗，請檢查網路"); }
            
            btn.innerHTML = originalText;
        }

        function updateTopAuth() {
            const u = JSON.parse(localStorage.getItem('keicha_user'));
            const container = document.getElementById('top-auth-zone');
            if(u) {
                container.innerHTML = `<button onclick="openPanel('user')" class="flex items-center gap-1 bg-brand/10 text-brand px-3 py-1.5 rounded-full text-xs font-bold hover:bg-brand hover:text-white transition-colors"><span class="material-symbols-rounded text-base">person</span> ${u.name || u.phone}</button>`;
            } else {
                container.innerHTML = `<button onclick="openPanel('login')" class="text-sm font-bold text-gray-500 hover:text-brand transition-colors">登入 / 註冊</button>`;
            }
        }

        function handleLogout() {
            if(confirm("確定要登出嗎？")) {
                localStorage.removeItem('keicha_user');
                location.reload();
            }
        }

        // 會員資料儲存 (含 Regex 驗證)
        async function saveUserInfo() {
            const u = JSON.parse(localStorage.getItem('keicha_user'));
            const updates = {
                name: document.getElementById('user-name').value,
                email: document.getElementById('user-email').value
            };
            await updateUserRemote({ ...u, ...updates }, 'btn-save-user');
        }

        async function saveStoreInfo(type) {
            const u = JSON.parse(localStorage.getItem('keicha_user'));
            let updates = {};
            let btnId = '';

            if(type === '7-11') {
                const code = document.getElementById('store-711-code').value.trim();
                // ★ 驗證 6 碼數字
                if(!/^\d{6}$/.test(code)) return alert("店號必須為 6 碼數字");
                updates.store_711 = code;
                updates.store_711_note = document.getElementById('store-711-name').value;
                btnId = '7-11'; // 使用父層按鈕觸發有點複雜，這裡簡化處理
            } else if(type === 'fami') {
                const code = document.getElementById('store-fami-code').value.trim();
                if(!/^\d{6}$/.test(code)) return alert("店號必須為 6 碼數字");
                updates.store_fami = code;
                updates.store_fami_note = document.getElementById('store-fami-name').value;
            } else {
                updates.shipping_address = document.getElementById('store-addr').value;
            }

            // 這裡直接重刷整個 User Panel 太麻煩，簡單 alert 成功就好
            await updateUserRemote({ ...u, ...updates }, null);
            alert("設定已儲存");
        }

        async function updateUserRemote(newData, btnId) {
            if(btnId) {
                const btn = document.getElementById(btnId);
                btn.innerText = "儲存中...";
                btn.disabled = true;
            }
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'save', ...newData }) });
                const result = await res.json();
                if(result.success) {
                    localStorage.setItem('keicha_user', JSON.stringify(newData));
                }
            } catch(e) { alert("儲存失敗"); }
            
            if(btnId) {
                const btn = document.getElementById(btnId);
                btn.innerText = "儲存基本資料";
                btn.disabled = false;
            }
        }

        function renderUserPanel() {
            const u = JSON.parse(localStorage.getItem('keicha_user'));
            if(!u) return;
            document.getElementById('user-phone').innerText = u.phone;
            document.getElementById('user-name').value = u.name || '';
            document.getElementById('user-email').value = u.email || '';
            
            document.getElementById('store-711-code').value = u.store_711 || '';
            document.getElementById('store-711-name').value = u.store_711_note || '';
            
            document.getElementById('store-fami-code').value = u.store_fami || '';
            document.getElementById('store-fami-name').value = u.store_fami_note || '';
            
            document.getElementById('store-addr').value = u.shipping_address || '';
        }

        // 6. 結帳流程
        function openCheckout() {
            if(cart.length === 0) return alert("購物車是空的");
            const u = JSON.parse(localStorage.getItem('keicha_user'));
            if(!u) return openPanel('login');

            openPanel('checkout');
            
            // 填入預設資料
            document.getElementById('chk-name').innerText = u.name || "未填寫 (請至會員中心設定)";
            document.getElementById('chk-phone').innerText = u.phone;
            document.getElementById('chk-email').innerText = u.email || "未填寫";
            
            document.getElementById('info-7-11').innerText = u.store_711 ? `已設定：${u.store_711} ${u.store_711_note||''}` : "尚未設定 (請至會員中心)";
            document.getElementById('info-fami').innerText = u.store_fami ? `已設定：${u.store_fami} ${u.store_fami_note||''}` : "尚未設定 (請至會員中心)";
            document.getElementById('info-home').innerText = u.shipping_address ? `已設定` : "尚未設定";

            updateCheckoutTotal();
        }

        function selectLogistics(type) {
            const u = JSON.parse(localStorage.getItem('keicha_user'));
            
            // 檢查是否有資料
            if(type === '7-11' && !u.store_711) return alert("請先至會員中心設定 7-11 店號");
            if(type === 'fami' && !u.store_fami) return alert("請先至會員中心設定 全家 店號");
            if(type === 'home' && !u.shipping_address) return alert("請先至會員中心設定 宅配地址");

            selectedLogistics = type;
            
            // UI 狀態更新
            document.querySelectorAll('.logistics-card').forEach(el => {
                el.classList.remove('border-brand', 'bg-brand/5');
                el.classList.add('border-transparent');
                el.querySelector('.radio-circle').classList.remove('bg-brand', 'border-brand');
            });
            
            const activeCard = document.getElementById(`card-${type}`);
            activeCard.classList.remove('border-transparent');
            activeCard.classList.add('border-brand', 'bg-brand/5');
            activeCard.querySelector('.radio-circle').classList.add('bg-brand', 'border-brand');

            updateCheckoutTotal();
        }

        function updateCheckoutTotal() {
            const subtotal = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
            let shipping = 0;
            
            if(selectedLogistics) {
                // 簡易運費邏輯 (可搭配後端 shippingRules 做複雜計算)
                shipping = selectedLogistics === 'home' ? 100 : 60;
                
                // 滿額免運範例
                // if(subtotal >= 2000) shipping = 0;
            }

            document.getElementById('chk-subtotal').innerText = `NT$ ${subtotal.toLocaleString()}`;
            document.getElementById('chk-shipping').innerText = `NT$ ${shipping}`;
            document.getElementById('chk-total').innerText = `NT$ ${(subtotal + shipping).toLocaleString()}`;
        }

        async function submitOrder() {
            const u = JSON.parse(localStorage.getItem('keicha_user'));
            const lineName = document.getElementById('order-line').value.trim();
            const note = document.getElementById('order-note').value.trim();

            if(!u.name || !u.email) return alert("請先補齊會員姓名與 Email 資料");
            if(!selectedLogistics) return alert("請選擇配送方式");
            // ★ 必填 LINE 檢查
            if(!lineName) return alert("請填寫 LINE 名稱，以便核對訂單");

            const btn = document.getElementById('btn-submit-order');
            btn.innerHTML = `<div class="spinner border-white"></div> 處理中...`;
            btn.disabled = true;

            const subtotal = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
            const shipping = selectedLogistics === 'home' ? 100 : 60;

            const payload = {
                action: 'checkout',
                name: u.name,
                phone: u.phone,
                email: u.email,
                line_name: lineName,
                note: note,
                logistics: selectedLogistics,
                store: selectedLogistics === 'home' ? u.shipping_address : (selectedLogistics === '7-11' ? u.store_711 : u.store_fami),
                items: cart.map(i => `${i.name} x${i.qty}`).join(', '),
                subtotal: subtotal,
                shipping: shipping,
                date: new Date().toLocaleString()
            };

            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await res.json();
                if(result.success) {
                    alert("訂單已送出！我們會盡快與您聯繫。");
                    cart = [];
                    renderCart();
                    closeAllPanels();
                } else {
                    alert("訂單送出失敗: " + result.msg);
                }
            } catch(e) {
                alert("網路錯誤");
            }

            btn.innerHTML = `確認送出訂單 <span class="material-symbols-rounded">verified</span>`;
            btn.disabled = false;
        }

        function groupBy(array, key) {
            return array.reduce((result, currentValue) => {
                (result[currentValue[key]] = result[currentValue[key]] || []).push(currentValue);
                return result;
            }, {});
        }
    </script>
</body>
</html>
