<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KEICHA 抹茶代購下單區</title>
    <link rel="icon" href="data:,">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: '#6ea44c',
                        brandLight: '#e8f5e9',
                        brandDark: '#5d8d41',
                        brandBg: 'rgba(110,164,76,0.1)',
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                        brand: ['Zen Maru Gothic', 'sans-serif'],
                    },
                    boxShadow: {
                        'panel': '-4px 0 25px rgba(0,0,0,0.15)',
                        'sticky': '0 -4px 10px rgba(0,0,0,0.05)',
                    }
                }
            }
        }
    </script>

    <style>
        :root { --font-brand: "Zen Maru Gothic", sans-serif; }
        body { font-family: "Noto Sans TC", sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: 100px; background-color: #ffffff; overflow-x: hidden; }
        .font-brand-text { font-family: var(--font-brand); font-weight: 700; }
        
        /* Loading Spinner */
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #6ea44c; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Side Panel - Critical Fixes */
        .side-panel { 
            position: fixed; 
            top: 0; 
            right: 0; 
            bottom: 0;
            width: 100%; 
            max-width: 420px; 
            background: white; 
            z-index: 200; /* Priority Level: Highest */
            transform: translateX(100%); 
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1); 
            box-shadow: var(--shadow-panel); 
            display: flex; 
            flex-direction: column; 
        }
        .side-panel.open { transform: translateX(0) !important; }
        
        .overlay { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.4); 
            z-index: 150; 
            opacity: 0; 
            visibility: hidden; 
            transition: opacity 0.3s; 
            backdrop-filter: blur(2px); 
        }
        .overlay.open { opacity: 1; visibility: visible; }

        /* Custom Inputs */
        .input-ui { 
            width: 100%; padding: 12px 14px; border: 1px solid #e2e8f0; border-radius: 10px; 
            font-size: 15px; outline: none; transition: all 0.2s ease; background-color: #f8fafc; color: #334155;
        }
        .input-ui:focus { border-color: #6ea44c; background-color: white; ring: 1px solid #6ea44c; }
        .input-ui::placeholder { color: #94a3b8; }
        .input-error { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        
        /* Logistics Card UI */
        .logistics-card { 
            border: 1px solid #e2e8f0; border-radius: 12px; transition: all 0.2s ease; 
            background: white; overflow: hidden; position: relative;
        }
        .logistics-card.active { 
            border-color: #6ea44c; background-color: #fcfdfc; 
            box-shadow: 0 0 0 1px #6ea44c inset; 
        }
        .logistics-card:active { transform: scale(0.99); }

        /* Store Query Button */
        .btn-query-store {
            background-color: white; color: #6ea44c; border: 1px solid #6ea44c;
            display: flex; align-items: center; justify-content: center; gap: 4px;
            padding: 8px 12px; border-radius: 8px; font-weight: bold; font-size: 13px;
            transition: background 0.2s; text-decoration: none; white-space: nowrap;
        }
        .btn-query-store:hover { background-color: #e8f5e9; }

        /* Sticky Footer with Safe Area */
        .panel-footer { 
            background: white; padding: 16px 20px; border-top: 1px solid #f1f5f9; 
            box-shadow: var(--shadow-sticky); z-index: 20; 
            padding-bottom: calc(env(safe-area-inset-bottom) + 24px); 
        }
        .panel-footer-btn-wrapper { margin-bottom: 16px; }

        /* Product Card Styles */
        .card-img-group { width: 100px; height: 100px; flex-shrink: 0; border-radius: 12px; overflow: hidden; background-color: #f9fafb; }
        @media (min-width: 768px) { .card-img-group { width: 100%; height: auto; aspect-ratio: 1/1; } }
    </style>
</head>
<body class="bg-white text-gray-800">

    <div id="overlay" class="overlay" onclick="closeAllPanels()"></div>

    <div class="sticky top-0 z-30 bg-white/95 backdrop-blur-sm border-b border-gray-100 shadow-sm">
        <div class="container mx-auto px-4 max-w-5xl py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-tight text-brand flex items-center gap-2">
                <span class="font-brand-text text-2xl">KEICHA</span>
            </h1>
            <div class="flex items-center gap-2">
                 <button type="button" onclick="openLoginPanel()" class="p-2 text-brand hover:bg-brandLight rounded-full transition cursor-pointer">
                    <span class="material-symbols-rounded text-2xl pointer-events-none">person</span>
                 </button>
                 
                 <button type="button" onclick="openCart()" class="relative p-2 text-brand hover:bg-brandLight rounded-full transition cursor-pointer">
                    <span class="material-symbols-rounded text-2xl pointer-events-none">shopping_bag</span>
                    <span id="header-cart-badge" class="absolute top-0 right-0 bg-brand text-white text-[10px] font-bold w-4 h-4 flex items-center justify-center rounded-full hidden pointer-events-none">0</span>
                </button>
            </div>
        </div>
    </div>

    <section class="py-8 bg-white border-b border-gray-100">
        <div class="container mx-auto px-4 max-w-5xl">
            <h2 class="text-xl font-bold text-center mb-6 text-gray-800 flex items-center justify-center gap-2">
                <span class="material-symbols-rounded text-brand">storefront</span> 品牌總覽
            </h2>
            <div id="status-loader" class="flex justify-center h-20 items-center">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div>
            </div>
            <div id="status-grid-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>
    </section>

    <main class="max-w-5xl mx-auto px-4 py-8 pb-32">
        <div id="product-list-container" class="space-y-12"></div>
    </main>

    <div id="cart-sidebar" class="side-panel">
        <div class="flex flex-col h-full">
            <div class="p-5 border-b border-gray-50 flex justify-between items-center bg-white relative shrink-0">
                <div class="absolute left-0 top-1/2 -translate-y-1/2 h-6 w-1 bg-brand rounded-r"></div>
                <div class="flex items-center gap-2 text-gray-800 font-bold text-xl pl-3">
                    <span class="material-symbols-rounded text-brand">list_alt</span>
                    購物清單
                </div>
                <button onclick="closeAllPanels()" class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100 transition cursor-pointer">
                    <span class="material-symbols-rounded text-2xl pointer-events-none">close</span>
                </button>
            </div>

            <div id="cart-items-wrapper" class="flex-1 overflow-y-auto p-0 pb-4">
                </div>

            <div class="panel-footer bg-gray-50 shrink-0">
                <div class="panel-footer-btn-wrapper space-y-4">
                    <div class="flex justify-between items-center px-1">
                        <span class="text-gray-500 font-medium text-sm">商品小計</span>
                        <span class="text-xl font-bold text-brand font-mono">NT$ <span id="cart-subtotal">0</span></span>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="closeAllPanels()" class="col-span-1 bg-white text-gray-500 border border-gray-200 font-bold py-3.5 rounded-xl hover:bg-gray-50 transition flex justify-center items-center gap-2">
                            繼續選購
                        </button>
                        <button onclick="openCheckout()" class="col-span-1 bg-brand text-white font-bold py-3.5 rounded-xl shadow-lg shadow-brand/20 hover:bg-brandDark active:scale-[0.98] transition flex justify-center items-center gap-2">
                            前往結帳 <span class="material-symbols-rounded text-sm">arrow_forward</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="login-panel" class="side-panel">
        <div class="flex flex-col h-full">
            <div class="p-5 flex justify-end shrink-0">
                <button onclick="closeAllPanels()" class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100 transition">
                    <span class="material-symbols-rounded text-2xl">close</span>
                </button>
            </div>
            
            <div class="p-8 flex flex-col items-center justify-center flex-1 -mt-20 overflow-y-auto">
                <div class="w-16 h-16 bg-brandLight rounded-full flex items-center justify-center text-brand mb-6 shrink-0">
                    <span class="material-symbols-rounded text-3xl">person</span>
                </div>
                
                <div id="login-state-default" class="w-full text-center">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">會員查詢 / 登入</h3>
                    <p class="text-sm text-gray-400 mb-8">輸入手機號碼管理訂單與資料</p>
                    
                    <div class="flex gap-2 mb-4">
                         <input type="tel" id="login-phone" class="input-ui font-bold text-lg tracking-wider text-center" placeholder="09xxxxxxxx" maxlength="10" pattern="^09\d{8}$">
                    </div>
                    
                    <button onclick="performLogin()" id="btn-login-action" class="w-full bg-brand text-white font-bold py-4 rounded-xl shadow-lg shadow-brand/20 hover:bg-brandDark transition mb-4">
                        查詢會員資料
                    </button>
                    <p id="login-msg" class="text-xs h-4 text-red-500"></p>
                </div>

                <div id="login-state-welcome" class="hidden w-full text-center space-y-6">
                    <h3 class="text-xl font-bold text-brand mb-2">歡迎回來，<span id="welcome-name"></span></h3>
                    <p class="text-sm text-gray-500">請選擇接下來要做的事：</p>
                    
                    <button onclick="openMemberPanel()" class="w-full bg-brand text-white font-bold py-4 rounded-xl shadow-lg shadow-brand/20 hover:bg-brandDark transition flex items-center justify-center gap-2">
                        <span class="material-symbols-rounded">edit_square</span> 現在輸入收件資料
                    </button>
                    <button onclick="closeAllPanels()" class="w-full bg-white border border-gray-200 text-gray-600 font-bold py-4 rounded-xl hover:bg-gray-50 transition">
                        稍後再說
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="member-panel" class="side-panel">
        <div class="flex flex-col h-full relative">
            <div class="p-5 bg-brand text-white flex justify-between items-center z-10 shadow-md shrink-0">
                <h3 class="font-bold flex items-center gap-2 text-lg">
                    <span class="material-symbols-rounded">manage_accounts</span> 會員資料管理
                </h3>
                <button onclick="closeAllPanels()" class="text-white/80 hover:text-white transition">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto bg-gray-50 p-5 space-y-6 pb-32">
                <section class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 space-y-4">
                    <h4 class="text-sm font-bold text-gray-800 flex items-center gap-2 border-b border-gray-100 pb-2">
                        <span class="material-symbols-rounded text-brand text-lg">badge</span> 基本資料
                    </h4>
                    <input type="text" id="mem-name" class="input-ui" placeholder="姓名">
                    <input type="tel" id="mem-phone" class="input-ui bg-gray-100 text-gray-500 cursor-not-allowed" disabled placeholder="手機">
                    <input type="email" id="mem-email" class="input-ui" placeholder="Email">
                    <input type="text" id="mem-line" class="input-ui" placeholder="LINE 顯示名稱">
                </section>

                <section class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 space-y-4">
                    <h4 class="text-sm font-bold text-gray-800 flex items-center gap-2 border-b border-gray-100 pb-2">
                        <span class="material-symbols-rounded text-brand text-lg">local_shipping</span> 7-11 預設門市
                    </h4>
                    <div class="flex gap-2">
                        <input type="text" id="mem-711-id" class="input-ui flex-1 font-mono text-center" placeholder="6碼店號" maxlength="6">
                        <a href="https://www.ibon.com.tw/mobile/retail_inquiry.aspx" target="_blank" class="btn-query-store">查詢</a>
                    </div>
                    <input type="text" id="mem-711-note" class="input-ui text-sm" placeholder="門市名稱">
                </section>

                <section class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 space-y-4">
                    <h4 class="text-sm font-bold text-gray-800 flex items-center gap-2 border-b border-gray-100 pb-2">
                        <span class="material-symbols-rounded text-brand text-lg">store</span> 全家 預設門市
                    </h4>
                    <div class="flex gap-2">
                        <input type="text" id="mem-fami-id" class="input-ui flex-1 font-mono text-center" placeholder="6碼店號" maxlength="6">
                        <a href="https://www.family.com.tw/marketing/inquiry.aspx" target="_blank" class="btn-query-store">查詢</a>
                    </div>
                    <input type="text" id="mem-fami-note" class="input-ui text-sm" placeholder="門市名稱">
                </section>

                <section class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 space-y-4">
                    <h4 class="text-sm font-bold text-gray-800 flex items-center gap-2 border-b border-gray-100 pb-2">
                        <span class="material-symbols-rounded text-brand text-lg">home</span> 宅配 預設地址
                    </h4>
                    <textarea id="mem-addr" class="input-ui min-h-[80px]" placeholder="完整地址..."></textarea>
                </section>
            </div>

            <div class="panel-footer shrink-0">
                <button onclick="saveMemberData(this)" class="w-full bg-brand text-white font-bold py-4 rounded-xl text-lg shadow-lg shadow-brand/20 hover:bg-brandDark transition flex justify-center items-center gap-2">
                    <span class="material-symbols-rounded">save</span> 儲存變更
                </button>
            </div>
        </div>
    </div>


    <div id="checkout-panel" class="side-panel">
        <div class="flex flex-col h-full relative">
            <div class="p-5 bg-white border-b border-gray-100 flex justify-between items-center z-10 shrink-0">
                <h3 class="font-bold flex items-center gap-2 text-lg text-gray-800">
                    <span class="material-symbols-rounded text-brand">shopping_cart_checkout</span> 
                    結帳確認
                </h3>
                <button onclick="closeAllPanels()" class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100 transition">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>

            <form id="order-form" onsubmit="return false;" class="flex-1 overflow-y-auto bg-white pb-40"> 
                <div class="p-5 space-y-8">
                    
                    <section class="bg-gray-50 p-4 rounded-2xl border border-gray-100 space-y-4">
                        
                        <div class="bg-white rounded-xl border border-brandBg overflow-hidden">
                            <ul id="checkout-readonly-list" class="divide-y divide-brandBg bg-[rgba(110,164,76,0.05)]">
                                </ul>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-3 flex items-center gap-1">
                                <span class="material-symbols-rounded text-sm text-brand">smartphone</span> 會員查詢 / 手機號碼
                            </label>
                            <div class="flex gap-2">
                                <input type="tel" id="input-phone" 
                                    class="input-ui font-bold text-lg tracking-wider" 
                                    placeholder="09xxxxxxxx" 
                                    maxlength="10" 
                                    pattern="^09\d{8}$"
                                    required>
                                <button type="button" onclick="lookupPhoneData(this)" 
                                    class="bg-brand text-white w-14 rounded-xl flex items-center justify-center hover:bg-brandDark transition disabled:opacity-50">
                                    <span class="material-symbols-rounded">arrow_forward</span>
                                </button>
                            </div>
                            <p id="phone-msg" class="text-xs mt-2 pl-1 h-4 font-medium transition-colors duration-300"></p>
                        </div>
                    </section>

                    <section>
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                            <span class="w-1 h-4 bg-brand rounded-full"></span> 配送方式
                        </h4>
                        <div class="space-y-3">
                            <select id="input-logistics" class="hidden"><option value="7-11">7-11</option><option value="全家">全家</option><option value="郵寄/宅配">宅配</option></select>
                            
                            <div class="logistics-card cursor-pointer group" onclick="selectLogistics('7-11', this)">
                                <div class="p-4 flex justify-between items-center">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-brandLight flex items-center justify-center text-brand">
                                            <span class="material-symbols-rounded">local_shipping</span>
                                        </div>
                                        <div class="font-bold text-gray-800 text-sm">7-11 店到店</div>
                                    </div>
                                    <span class="text-brand font-bold text-sm logistics-price" data-type="7-11">$60</span>
                                </div>
                                <div class="logistics-detail hidden border-t border-brand/20 bg-brandLight/20 p-4 space-y-3" onclick="event.stopPropagation()">
                                    <div class="flex gap-2">
                                        <input type="text" class="input-ui flex-1 text-center font-mono tracking-widest" placeholder="輸入6碼店號" maxlength="6" pattern="^\d{6}$" inputmode="numeric" id="store-id-711" onchange="syncStoreInput()">
                                        <a href="https://www.ibon.com.tw/mobile/retail_inquiry.aspx" target="_blank" class="btn-query-store">
                                            <span class="material-symbols-rounded text-base">map</span> 查詢店號
                                        </a>
                                    </div>
                                    <input type="text" class="input-ui text-sm" placeholder="門市名稱 / 備註" id="store-name-711" onchange="syncStoreInput()">
                                </div>
                            </div>

                            <div class="logistics-card cursor-pointer group" onclick="selectLogistics('全家', this)">
                                <div class="p-4 flex justify-between items-center">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-brandLight flex items-center justify-center text-brand">
                                            <span class="material-symbols-rounded">store</span>
                                        </div>
                                        <div class="font-bold text-gray-800 text-sm">全家 店到店</div>
                                    </div>
                                    <span class="text-brand font-bold text-sm logistics-price" data-type="全家">$60</span>
                                </div>
                                <div class="logistics-detail hidden border-t border-brand/20 bg-brandLight/20 p-4 space-y-3" onclick="event.stopPropagation()">
                                    <div class="flex gap-2">
                                        <input type="text" class="input-ui flex-1 text-center font-mono tracking-widest" placeholder="輸入6碼店號" maxlength="6" pattern="^\d{6}$" inputmode="numeric" id="store-id-fami" onchange="syncStoreInput()">
                                        <a href="https://www.family.com.tw/marketing/inquiry.aspx" target="_blank" class="btn-query-store">
                                            <span class="material-symbols-rounded text-base">map</span> 查詢店號
                                        </a>
                                    </div>
                                    <input type="text" class="input-ui text-sm" placeholder="門市名稱 / 備註" id="store-name-fami" onchange="syncStoreInput()">
                                </div>
                            </div>

                            <div class="logistics-card cursor-pointer group" onclick="selectLogistics('郵寄/宅配', this)">
                                <div class="p-4 flex justify-between items-center">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-brandLight flex items-center justify-center text-brand">
                                            <span class="material-symbols-rounded">local_shipping</span>
                                        </div>
                                        <div class="font-bold text-gray-800 text-sm">宅配到府</div>
                                    </div>
                                    <span class="text-brand font-bold text-sm logistics-price" data-type="宅配">$100</span>
                                </div>
                                <div class="logistics-detail hidden border-t border-brand/20 bg-brandLight/20 p-4" onclick="event.stopPropagation()">
                                    <textarea id="store-addr" class="input-ui text-sm min-h-[80px]" placeholder="請輸入完整收件地址 (含郵遞區號)" onchange="syncStoreInput()"></textarea>
                                </div>
                            </div>
                            
                            <input type="hidden" name="store" id="input-store" required>
                            <input type="hidden" name="store_note" id="input-store-note">
                        </div>
                    </section>

                    <section class="space-y-4">
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                            <span class="w-1 h-4 bg-brand rounded-full"></span> 收件資料
                        </h4>
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-gray-500 mb-1.5 block ml-1">收件人全名 <span class="text-brand">*</span></label>
                                <input type="text" id="input-name" required class="input-ui" placeholder="請輸入真實姓名">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 mb-1.5 block ml-1">電子信箱 <span class="text-brand">*</span></label>
                                <input type="email" id="input-email" required class="input-ui" placeholder="接收訂單通知">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 mb-1.5 block ml-1">LINE 顯示名稱</label>
                                <input type="text" id="input-line" class="input-ui" placeholder="方便聯絡 (選填)">
                            </div>
                        </div>
                    </section>

                    <section class="space-y-4">
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                            <span class="w-1 h-4 bg-brand rounded-full"></span> 其他
                        </h4>
                        <textarea id="input-note" class="input-ui min-h-[80px]" placeholder="訂單備註 (選填)..."></textarea>
                        
                        <label class="flex items-center gap-3 p-4 bg-gray-50 border border-gray-100 rounded-xl cursor-pointer hover:bg-gray-100 transition">
                            <div class="relative flex items-center">
                                <input type="checkbox" id="join-member" class="peer h-5 w-5 cursor-pointer appearance-none rounded border border-gray-300 checked:bg-brand checked:border-brand transition-all" checked>
                                <span class="material-symbols-rounded absolute text-white opacity-0 peer-checked:opacity-100 pointer-events-none text-base left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2">check</span>
                            </div>
                            <span class="text-sm text-gray-600 font-medium">同意儲存資料，下次自動帶入</span>
                        </label>
                    </section>
                </div>
            </form>

            <div class="panel-footer shrink-0">
                <div class="panel-footer-btn-wrapper">
                    <div class="flex justify-between items-end mb-4">
                        <div class="text-xs text-gray-400 font-medium" id="footer-logistics-name">尚未選擇物流</div>
                        <div class="text-right flex items-baseline gap-2">
                            <span class="text-xs text-gray-400">總金額</span>
                            <span class="text-2xl font-bold text-brand font-mono">NT$ <span id="modal-total">0</span></span>
                        </div>
                    </div>
                    <button onclick="submitOrder(this)" class="w-full bg-brand text-white font-bold py-4 rounded-xl text-lg shadow-lg shadow-brand/20 hover:bg-brandDark active:scale-[0.98] transition flex justify-center items-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed">
                        <span class="material-symbols-rounded">verified</span> 確認送出訂單
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ORDER_API_URL = "https://script.google.com/macros/s/AKfycbyUq36i64Z-JGcERE_rZOdphVtVDX8L-lguc7eiUIdoAERqI1ZK8GWAL-HgbC75cuMHFg/exec";
        const DISPLAY_API_URL = "https://script.google.com/macros/s/AKfycbxnxbcdCdxH2Qmuek5Up8BqTWeOLUcLR30jfUi0lMbMn5ocn9tY1f_c7yEyd9KSZ4Um/exec";
        const BASE_REPO_URL = "assets/images/"; 

        let allProducts = [];
        let cart = [];
        let shippingFee = 0;
        let shippingRules = [];
        let currentUser = null;
        let selectedLogisticsType = '';
        let tempQtyMap = {};

        // --- Core Side Panel Logic ---
        function openPanel(id) {
            const el = document.getElementById(id);
            const overlay = document.getElementById('overlay');
            if(el && overlay) {
                overlay.classList.add('open');
                el.classList.add('open');
            }
        }

        function closeAllPanels() {
            document.getElementById('overlay').classList.remove('open');
            document.querySelectorAll('.side-panel').forEach(el => el.classList.remove('open'));
        }

        function openCart() {
            renderCartItems();
            openPanel('cart-sidebar');
        }

        function openLoginPanel() {
            openPanel('login-panel');
        }

        function openMemberPanel() {
            closeAllPanels();
            openPanel('member-panel');
        }

        function openCheckout() {
            if (cart.length === 0) { alert('請先加入商品'); return; }
            
            // Reset UI
            document.querySelectorAll('.logistics-card').forEach(c => {
                c.classList.remove('active');
                c.querySelector('.logistics-detail').classList.add('hidden');
            });
            document.getElementById('input-store').value = '';
            document.getElementById('input-store-note').value = '';
            document.getElementById('footer-logistics-name').innerText = '尚未選擇物流';
            selectedLogisticsType = '';

            // Generate Readonly List
            updateCheckoutReadonlyList();
            
            closeAllPanels();
            openPanel('checkout-panel');
            updateShippingFee();
        }

        // --- Cart Logic ---
        function addToCart(productId, name, price, priceMulti, stock, maxLimit) {
            const productData = allProducts.find(p => p.key === productId) || {};
            const brandKey = productData.brand_key || 'default';
            const spec = productData.spec || '';

            const qtyToAdd = tempQtyMap[productId] || 1;
            const existingItem = cart.find(item => item.productId === productId);
            
            let currentCartQty = existingItem ? existingItem.qty : 0;
            if (currentCartQty + qtyToAdd > stock) { alert("抱歉，庫存不足！"); return; }
            if (currentCartQty + qtyToAdd > maxLimit) { alert(`此商品每人限購 ${maxLimit} 件`); return; }

            if (existingItem) { 
                existingItem.qty += qtyToAdd; 
            } else { 
                cart.push({ 
                    productId: productId, 
                    brand_key: brandKey, 
                    name: name, 
                    spec: spec,
                    price: price, 
                    price_multi: priceMulti, 
                    qty: qtyToAdd, 
                    stock: stock,
                    img: productData.img
                }); 
            }
            
            tempQtyMap[productId] = 1;
            const qtyDisplay = document.getElementById(`iq-${productId}`);
            if(qtyDisplay) qtyDisplay.innerText = 1;

            if (navigator.vibrate) navigator.vibrate(50);
            renderCartItems();
            openCart();
        }

        function getBrandCounts() {
            let counts = {};
            cart.forEach(item => {
                let k = item.brand_key || 'default';
                counts[k] = (counts[k] || 0) + item.qty;
            });
            return counts;
        }

        function calculateSubtotal() {
            const brandCounts = getBrandCounts();
            let subtotal = 0;
            cart.forEach(item => {
                let k = item.brand_key || 'default';
                let useDiscount = brandCounts[k] > 1;
                let finalPrice = useDiscount ? item.price_multi : item.price;
                subtotal += finalPrice * item.qty;
            });
            return subtotal;
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items-wrapper');
            const subtotalEl = document.getElementById('cart-subtotal');
            container.innerHTML = '';
            
            // Empty State
            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-gray-300 gap-3">
                        <span class="material-symbols-rounded text-5xl">shopping_basket</span>
                        <p class="text-sm font-medium">購物車是空的</p>
                    </div>`;
                subtotalEl.innerText = '0';
                document.getElementById('header-cart-badge').classList.add('hidden');
                return;
            }

            const brandCounts = getBrandCounts();
            const groupedCart = {};
            cart.forEach(item => {
                let k = item.brand_key || 'default';
                if(!groupedCart[k]) groupedCart[k] = [];
                groupedCart[k].push(item);
            });

            for (const [brandKey, items] of Object.entries(groupedCart)) {
                const isDiscountActive = brandCounts[brandKey] > 1;
                
                if(isDiscountActive) {
                    container.innerHTML += `
                        <div class="bg-brandLight text-brandDark text-xs font-bold px-4 py-2 flex items-center gap-1">
                            <span class="material-symbols-rounded text-sm">verified</span>
                            已套用同品牌多件優惠
                        </div>
                    `;
                }

                items.forEach((item) => {
                    const mainIndex = cart.indexOf(item);
                    const unitPrice = isDiscountActive ? item.price_multi : item.price;
                    const isMultiPriceApplied = isDiscountActive && (item.price !== item.price_multi);

                    // A-3: Image Logic (No render if empty)
                    let imgHtml = '';
                    if (item.img) {
                        const src = item.img.startsWith('http') ? item.img : BASE_REPO_URL + item.img;
                        imgHtml = `
                            <div class="w-16 h-16 bg-gray-50 rounded-lg flex-shrink-0 flex items-center justify-center overflow-hidden border border-gray-100">
                               <img src="${src}" class="w-full h-full object-cover">
                            </div>`;
                    }

                    container.innerHTML += `
                        <div class="relative flex gap-4 items-start border-b border-gray-50 p-5 last:border-0 group bg-white">
                             ${imgHtml}
                            
                            <div class="flex-1 min-w-0 flex flex-col justify-between min-h-[64px]">
                                <div class="pr-6">
                                    <div class="font-bold text-gray-800 text-sm leading-tight line-clamp-2">${item.name}</div>
                                    ${item.spec ? `<div class="text-[10px] text-gray-400 mt-0.5">${item.spec}</div>` : ''}
                                    <div class="text-xs text-gray-400 mt-1 font-mono">
                                        ${isMultiPriceApplied ? `<span class="line-through text-gray-300 mr-1">$${item.price}</span>` : ''}
                                        <span class="${isMultiPriceApplied ? 'text-brand font-bold' : ''}">$${unitPrice}</span>
                                    </div>
                                </div>
                                
                                <div class="flex justify-between items-end mt-2">
                                    <div class="flex items-center bg-gray-50 border border-gray-200 rounded-lg h-8">
                                        <button onclick="updateCartQty(${mainIndex}, -1)" class="w-8 h-full flex items-center justify-center text-gray-500 hover:text-brand hover:bg-gray-100 rounded-l-lg transition font-bold">-</button>
                                        <span class="w-8 text-center text-xs font-bold text-gray-700 font-mono">${item.qty}</span>
                                        <button onclick="updateCartQty(${mainIndex}, 1)" class="w-8 h-full flex items-center justify-center text-gray-500 hover:text-brand hover:bg-gray-100 rounded-r-lg transition font-bold">+</button>
                                    </div>
                                    <div class="font-bold text-brand font-mono">$${unitPrice * item.qty}</div>
                                </div>
                            </div>

                            <button onclick="removeFromCart(${mainIndex})" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500 transition p-1">
                                <span class="material-symbols-rounded text-xl">close</span>
                            </button>
                        </div>
                    `;
                });
            }

            subtotalEl.innerText = calculateSubtotal().toLocaleString();
            const badge = document.getElementById('header-cart-badge');
            const totalQty = cart.reduce((acc, i) => acc + i.qty, 0);
            badge.innerText = totalQty;
            badge.classList.toggle('hidden', totalQty === 0);
        }

        function updateCartQty(index, delta) {
            if (!cart[index]) return;
            const item = cart[index];
            const newQty = item.qty + delta;
            if (delta > 0 && item.stock && newQty > item.stock) { alert('庫存不足'); return; }
            if (newQty < 1) return;
            item.qty = newQty;
            renderCartItems();
            if (document.getElementById('checkout-panel').classList.contains('open')) { 
                updateCheckoutReadonlyList(); 
                updateShippingFee(); 
            }
        }

        function removeFromCart(index) {
            if (!confirm('確定要移除此商品嗎？')) return;
            cart.splice(index, 1);
            renderCartItems();
            if (document.getElementById('checkout-panel').classList.contains('open')) { 
                updateCheckoutReadonlyList();
                updateShippingFee(); 
            }
        }

        function updateCheckoutReadonlyList() {
             const listEl = document.getElementById('checkout-readonly-list');
             listEl.innerHTML = '';
             cart.forEach(item => {
                 listEl.innerHTML += `
                    <li class="px-4 py-3 text-sm text-brandDark font-medium flex items-start gap-2">
                        <span class="material-symbols-rounded text-brand text-base mt-0.5">check_circle</span>
                        <span>
                            ${item.brand_key || 'Default'} ${item.name} 
                            ${item.spec ? `<span class="text-xs bg-brandLight px-1 rounded ml-1">${item.spec}</span>` : ''}
                            <span class="text-xs text-gray-500 ml-1">x${item.qty}</span>
                        </span>
                    </li>
                 `;
             });
        }

        // --- Logistics & Shipping ---
        function selectLogistics(type, cardEl) {
            selectedLogisticsType = type;
            const select = document.getElementById('input-logistics');
            select.value = type;

            document.querySelectorAll('.logistics-card').forEach(c => {
                c.classList.remove('active');
                c.querySelector('.logistics-detail').classList.add('hidden');
            });
            
            cardEl.classList.add('active');
            cardEl.querySelector('.logistics-detail').classList.remove('hidden');

            document.getElementById('footer-logistics-name').innerText = `已選擇：${type}`;
            updateShippingFee();
        }

        function syncStoreInput() {
            let storeId = '';
            let storeName = '';

            if (selectedLogisticsType === '7-11') {
                storeId = document.getElementById('store-id-711').value;
                storeName = document.getElementById('store-name-711').value;
            } else if (selectedLogisticsType === '全家') {
                storeId = document.getElementById('store-id-fami').value;
                storeName = document.getElementById('store-name-fami').value;
            } else if (selectedLogisticsType.includes('宅配')) {
                storeId = document.getElementById('store-addr').value; 
            }

            document.getElementById('input-store').value = storeId;
            document.getElementById('input-store-note').value = storeName;
        }

        // D-3: Strict Shipping Logic
        function updateShippingFee() {
            const subtotal = calculateSubtotal();
            
            // D-2: Only use category="抹茶"
            const rule = shippingRules.find(r => 
                r.method === selectedLogisticsType && 
                r.category === '抹茶'
            );
            
            let finalFee = 0; 
            
            if (rule) {
                finalFee = Number(rule.base);
                if (rule.t3 && subtotal >= Number(rule.t3)) finalFee = Number(rule.f3);
                else if (rule.t2 && subtotal >= Number(rule.t2)) finalFee = Number(rule.f2);
                else if (rule.t1 && subtotal >= Number(rule.t1)) finalFee = Number(rule.f1);
            }
            
            // Update UI for all cards with rule-based fees if possible
            document.querySelectorAll('.logistics-price').forEach(el => {
                const type = el.dataset.type;
                const cardRule = shippingRules.find(r => r.method === type && r.category === '抹茶');
                let cardFee = cardRule ? Number(cardRule.base) : 0;
                
                if (cardRule) {
                    if (cardRule.t3 && subtotal >= Number(cardRule.t3)) cardFee = Number(cardRule.f3);
                    else if (cardRule.t2 && subtotal >= Number(cardRule.t2)) cardFee = Number(cardRule.f2);
                    else if (cardRule.t1 && subtotal >= Number(cardRule.t1)) cardFee = Number(cardRule.f1);
                }
                
                // If type is not selected, fallback to base logic or 0? 
                // Requirement: No Fallback. But for UI display we need to show *something*.
                // Assuming cards should show "potential fee".
                el.innerText = cardFee > 0 ? `$${cardFee}` : (type==='宅配'?'$100':'$60'); // Safe visual default just in case rules not loaded
            });
            
            shippingFee = finalFee;
            document.getElementById('modal-total').innerText = (subtotal + shippingFee).toLocaleString();
        }

        // --- Login & Member Logic ---
        function performLogin() {
             const input = document.getElementById('login-phone');
             const msg = document.getElementById('login-msg');
             const btn = document.getElementById('btn-login-action');
             const phone = input.value.trim();

             if (!input.checkValidity()) {
                msg.innerText = "格式錯誤";
                return;
             }

             btn.disabled = true;
             btn.innerHTML = '查詢中...';

             fetch(ORDER_API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "login", phone: phone })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // C-1: Auto Register / Welcome
                    const info = data.data || { phone: phone, name: '新朋友' };
                    currentUser = info;
                    showWelcomeState(info.name || phone);
                    populateMemberForm(info);
                } else {
                    // Fallback (Should be covered by success:true isNew:true)
                    currentUser = { phone: phone, name: '新朋友' };
                    showWelcomeState('新朋友');
                    populateMemberForm(currentUser);
                }
            })
            .catch(() => { msg.innerText = "連線失敗"; })
            .finally(() => { 
                btn.disabled = false; 
                btn.innerHTML = '查詢會員資料';
            });
        }

        function showWelcomeState(name) {
            document.getElementById('login-state-default').classList.add('hidden');
            document.getElementById('login-state-welcome').classList.remove('hidden');
            document.getElementById('welcome-name').innerText = name;
        }

        function populateMemberForm(info) {
             if(!info) return;
             document.getElementById('mem-name').value = info.name || '';
             document.getElementById('mem-phone').value = info.phone || '';
             document.getElementById('mem-email').value = info.email || '';
             document.getElementById('mem-line').value = info.line_name || ''; // GAS key check
             
             document.getElementById('mem-711-id').value = info.store_711 || '';
             document.getElementById('mem-711-note').value = info.store_711_note || '';
             
             document.getElementById('mem-fami-id').value = info.store_fami || '';
             document.getElementById('mem-fami-note').value = info.store_fami_note || '';
             
             document.getElementById('mem-addr').value = info.shipping_address || '';
        }

        function saveMemberData(btn) {
             btn.disabled = true;
             btn.innerHTML = '儲存中...';

             const payload = {
                action: "update_member",
                phone: document.getElementById('mem-phone').value,
                name: document.getElementById('mem-name').value,
                email: document.getElementById('mem-email').value,
                line_name: document.getElementById('mem-line').value,
                
                // C-2-2 Independent logistics data
                store_711: document.getElementById('mem-711-id').value,
                store_711_note: document.getElementById('mem-711-note').value,
                
                store_fami: document.getElementById('mem-fami-id').value,
                store_fami_note: document.getElementById('mem-fami-note').value,
                
                shipping_address: document.getElementById('mem-addr').value
             };

             fetch(ORDER_API_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
             })
             .then(res => res.json())
             .then(data => {
                 alert('資料已更新');
                 closeAllPanels();
             })
             .catch(() => { alert('更新失敗'); })
             .finally(() => {
                 btn.disabled = false;
                 btn.innerHTML = '<span class="material-symbols-rounded">save</span> 儲存變更';
             });
        }

        function lookupPhoneData(btn) {
            const input = document.getElementById('input-phone');
            const msg = document.getElementById('phone-msg');
            const phone = input.value.trim();

            if (!input.checkValidity()) {
                msg.innerText = "格式錯誤";
                msg.className = "text-xs mt-2 pl-1 h-4 font-medium text-red-500";
                return;
            }
            
            msg.innerText = "查詢中...";
            msg.className = "text-xs mt-2 pl-1 h-4 font-medium text-gray-400";
            btn.disabled = true;

            fetch(ORDER_API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "login", phone: phone })
            })
            .then(res => res.json())
            .then(data => {
                // Always treat as success/welcome logic (B-2, C-1)
                const info = (data.success && data.data) ? data.data : { phone: phone, name: '新朋友' };
                currentUser = info;
                msg.innerText = `歡迎回來，${info.name || '新朋友'}`;
                msg.className = "text-xs mt-2 pl-1 h-4 font-bold text-brand";
                
                if(info.name) document.getElementById('input-name').value = info.name;
                if(info.email) document.getElementById('input-email').value = info.email;
                if(info.line_name) document.getElementById('input-line').value = info.line_name;
                
                // Pre-fill existing logistics preferences if they match (B-2)
                if(info.store_711) document.getElementById('store-id-711').value = info.store_711;
                if(info.store_711_note) document.getElementById('store-name-711').value = info.store_711_note;
                
                if(info.store_fami) document.getElementById('store-id-fami').value = info.store_fami;
                if(info.store_fami_note) document.getElementById('store-name-fami').value = info.store_fami_note;
                
                if(info.shipping_address) document.getElementById('store-addr').value = info.shipping_address;

            })
            .catch(() => { msg.innerText = "連線失敗"; })
            .finally(() => { btn.disabled = false; });
        }

        function submitOrder(btn) {
            const form = document.getElementById('order-form');
            if (!form.checkValidity()) { alert('請檢查欄位是否填寫正確'); form.reportValidity(); return; }
            if (!selectedLogisticsType) { alert('請選擇配送方式'); return; }
            if (!document.getElementById('input-store').value) { alert('請填寫店號或地址'); return; }

            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loader border-white border-t-transparent mr-2"></span> 處理中...';

            const brandCounts = getBrandCounts();
            const itemsStr = cart.map(item => {
                let k = item.brand_key || 'default';
                let useDiscount = brandCounts[k] > 1;
                let finalP = useDiscount ? item.price_multi : item.price;
                return `${item.name} x${item.qty} ($${finalP})`;
            }).join('\n');

            const payload = {
                action: "checkout",
                name: document.getElementById('input-name').value,
                phone: document.getElementById('input-phone').value,
                email: document.getElementById('input-email').value,
                line_name: document.getElementById('input-line').value,
                logistics: selectedLogisticsType,
                store: document.getElementById('input-store').value,
                // B-1: Send store note
                store_note: document.getElementById('input-store-note').value, 
                product_note: document.getElementById('input-note').value,
                join_member: document.getElementById('join-member').checked,
                items: itemsStr,
                subtotal: calculateSubtotal(),
                shipping: shippingFee,
                date: new Date().toISOString()
            };

            fetch(ORDER_API_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert(`訂單建立成功！\n編號：${data.orderId}`);
                    cart = [];
                    renderCartItems();
                    closeAllPanels();
                    form.reset();
                    // Reset UI
                    document.getElementById('checkout-readonly-list').innerHTML = '';
                    document.querySelectorAll('.logistics-card').forEach(c => {
                        c.classList.remove('active');
                        c.querySelector('.logistics-detail').classList.add('hidden');
                    });
                    document.getElementById('input-store').value = '';
                    document.getElementById('input-store-note').value = '';
                } else {
                    alert('失敗：' + data.msg);
                }
            })
            .catch(err => { alert('網路錯誤'); console.error(err); })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
        }

        // Init
        function adjQty(productId, change) {
             if (!tempQtyMap[productId]) tempQtyMap[productId] = 1;
             let newQty = tempQtyMap[productId] + change;
             if (newQty < 1) newQty = 1; 
             tempQtyMap[productId] = newQty;
             const qtyDisplay = document.getElementById(`iq-${productId}`);
             if (qtyDisplay) { qtyDisplay.innerText = newQty; }
        }

        window.addEventListener('load', () => {
             const loader = document.getElementById('status-loader');
             
             fetch(DISPLAY_API_URL)
                .then(res => res.json())
                .then(data => {
                    if(data.error) throw new Error(data.error);
                    if(data.shipping_rules) shippingRules = data.shipping_rules;
                    
                    allProducts = data.products || [];

                    renderStatusOverview(data.brands);
                    renderProductSections(data.brands);
                    data.brands.forEach(brand => {
                        renderProductCards(brand.key, data.products.filter(p => p.brand_key === brand.key));
                    });
                    loader.style.display = 'none';
                })
                .catch(err => {
                    console.error(err);
                    const container = document.getElementById('status-grid-container');
                    if(container) container.innerHTML = `<p class="text-center text-red-500 w-full col-span-2">資料載入失敗</p>`;
                    loader.style.display = 'none';
                });
        });

        // (Original Render functions omitted for brevity, strictly SAME as previous)
        function renderStatusOverview(brands) {
            const container = document.getElementById('status-grid-container');
            if (!container) return;
            container.innerHTML = '';
            const sortedBrands = brands.sort((a, b) => (Number(a.order) || 999) - (Number(b.order) || 999));
            sortedBrands.forEach(brand => {
                const rawStatus = (brand.status || '').toLowerCase().trim();
                let statusText = brand.status || '未定';
                let statusClass = 'bg-gray-200 text-gray-600';
                if (['available', 'open', '开团', '開團', '接收訂單中', '收單中', '可供訂購', '可訂購'].includes(rawStatus)) {
                    statusText = '可訂購'; statusClass = 'bg-brand text-white';
                } else { statusText = '缺貨中'; }
                container.innerHTML += `
                    <a href="#brand-${brand.key}" class="block group transform hover:-translate-y-1 transition-transform duration-300">
                        <div class="bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow p-4 border border-gray-100 flex justify-between items-center">
                            <span class="font-bold text-gray-800 text-lg group-hover:text-brand transition-colors">${brand.name}</span>
                            <span class="${statusClass} text-xs font-bold px-3 py-1 rounded-full whitespace-nowrap shadow-sm">${statusText}</span>
                        </div>
                    </a>`;
            });
        }
        function renderProductSections(brands) {
            const container = document.getElementById('product-list-container');
            if (!container) return;
            container.innerHTML = '';
            brands.forEach(brand => {
                container.innerHTML += `
                    <section id="brand-${brand.key}" class="scroll-mt-24">
                        <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-gray-800 border-b pb-4">
                            <span class="w-2 h-6 bg-brand rounded-full"></span>${brand.name}
                        </h2>
                        <div id="${brand.key}-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </section>`;
            });
        }
        function renderProductCards(brandKey, products) {
            const grid = document.getElementById(`${brandKey}-grid`);
            if (!grid) return;
            if (products.length === 0) { grid.innerHTML = `<p class="text-gray-400 text-center col-span-full py-8">尚無品項</p>`; return; }
            products.forEach(product => {
                const productId = product.key || Math.random().toString(36).substr(2, 9); 
                const name = product.name || '未命名';
                const price = Number(product.price) || 0;
                const priceMulti = Number(product.price_multi) || 0;
                const status = product.status || '';
                const note = product.note || '';      
                const tag = product.tag || '';        
                const spec = product.spec || '';      
                const imgPath = String(product.img || ''); 
                let isStockZero = false;
                if (product.stock !== "" && product.stock !== undefined) { if (Number(product.stock) <= 0) isStockZero = true; }
                const isSoldOut = isStockZero || status.includes('完售');
                const hasImage = imgPath !== '';
                const hasMultiPrice = (priceMulti > 0 && priceMulti < price);
                let imgHTML = '';
                if (hasImage) {
                    const src = imgPath.startsWith('http') ? imgPath : BASE_REPO_URL + imgPath;
                    imgHTML = `<div class="card-img-group w-full aspect-square relative overflow-hidden bg-gray-50 md:order-first md:relative md:aspect-square md:w-full md:bg-gray-50 md:overflow-hidden">
                                    <img src="${src}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110" loading="lazy">
                                </div>`;
                }
                let badgeHTML = '';
                if (tag) { badgeHTML = `<span class="absolute top-3 right-3 bg-brand text-white text-xs font-semibold px-2.5 py-0.5 rounded-full z-10 shadow-sm">${tag}</span>`; } 
                else if (isSoldOut) { badgeHTML = `<span class="absolute top-3 right-3 bg-gray-500 text-white text-xs font-semibold px-2.5 py-0.5 rounded-full z-10 shadow-sm">缺貨</span>`; }
                let priceHTML = '';
                if (hasMultiPrice) {
                    priceHTML = `<div class="flex flex-col items-end w-full"><span class="text-xs text-gray-400">單件 $${price}</span><span class="text-brand font-bold text-lg font-mono">2件起 $${priceMulti}</span></div>`;
                } else {
                    priceHTML = `<div class="w-full text-right"><span class="text-brand font-bold text-lg font-mono">NT$ ${price}</span></div>`;
                }
                const btnClass = isSoldOut ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-brand text-white transition active:scale-95 hover:bg-brandDark shadow-md shadow-brand/10';
                const clickEvent = isSoldOut ? '' : `onclick="addToCart('${productId}', '${name}', ${price}, ${priceMulti}, ${product.stock}, ${product.max_limit})"`;
                const btnText = isSoldOut ? '完售' : '加入購物車';
                const qtyDisable = isSoldOut ? 'disabled opacity-50' : '';
                const topRowClass = `flex gap-4 md:contents ${hasImage ? 'items-center' : ''}`;
                grid.innerHTML += `
                    <div class="bg-white rounded-2xl border border-gray-100 overflow-hidden shadow-sm flex flex-col mobile-product-card transition hover:shadow-lg group relative">
                        ${badgeHTML}
                        <div class="p-4 md:p-0 ${topRowClass}">
                            ${imgHTML}
                            <div class="card-info-group flex-1 flex flex-col gap-3 md:p-5">
                                <h4 class="font-bold text-gray-800 text-xl leading-tight line-clamp-1 flex items-baseline">
                                    ${name}${spec ? `<span class="ml-2 text-gray-400 text-xs font-normal whitespace-nowrap">${spec}</span>` : ''}
                                </h4>
                                ${ note ? `<p class="text-gray-400 text-[11px] leading-relaxed line-clamp-2 min-h-[1.5em]">${note}</p>` : '' }
                                <div class="mt-auto">${priceHTML}</div>
                            </div>
                        </div>
                        <div class="flex gap-2 p-4 pt-0 md:p-5 md:border-t">
                            <div class="flex items-center justify-between bg-white border border-gray-200 rounded-xl px-2 h-12 w-1/3">
                                <button class="w-8 h-full flex items-center justify-center text-brand font-bold" onclick="adjQty('${productId}', -1)" ${qtyDisable}>-</button>
                                <span id="iq-${productId}" class="text-xs font-bold px-2 text-center">1</span>
                                <button class="w-8 h-full flex items-center justify-center text-brand font-bold" onclick="adjQty('${productId}', 1)" ${qtyDisable}>+</button>
                            </div>
                            <button class="flex-1 h-12 rounded-xl text-xs font-bold ${btnClass}" ${clickEvent}>${btnText}</button>
                        </div>
                    </div>`;
            });
        }
    </script>
</body>
</html>
